---
title: "Asymsamr real"
author: "Elio Campitelli"
date: "26/07/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Extraído del paper.   
(No corre porque le falta toda la lectura y transformación de datos anterior.)

### Is the Asymmetric SAM real?

(ref:fake-eof-cap) Row a: The three components used to create a synthetic dataset of 41 years of geopotential height at 200 hPa. Row b: The three EOF computed from the synthetic dataset with the variance explained by each EOF in parenthesis. Units are arbitrary.

```{r make_fake_eof}
pattern_wave <- era5 %>% 
  .[sep_ReIm(cEOF2, format = "wide")[, hgt := NULL], on = .NATURAL] %>% 
  .[lev == 200] %>% 
  .[lat <= -20] %>% 
  .[season(time) == "SON"] %>% 
  .[, FitLm(hgt, Imaginary, Real), by = .(lat, lon)] %>% 
  rm_intercept() 

pattern_sam <- sams[term == "full" & lev == 200] %>% 
  .[era5[lev == 200], on = c("lev", "time")] %>% 
  .[lat <= -20] %>% 
  .[, FitLm(hgt, estimate), by = .(lon, lat, lev)] %>% 
  rm_intercept() %>% 
  .[, estimate := mean(estimate), by = .(lat)] %>% 
  .[, term := "SAM"] %>% 
  .[, lev := NULL]

patterns <- rbind(pattern_sam, pattern_wave)


set.seed(42)
complement <- function(x, y1, y2) {
  e <- residuals(lm(x ~ y1 + y2))
  e/sd(e)*sd(x) + mean(x)
}

N <- 100

real <- sample(Re(cEOF2$hgt), N, replace = TRUE)
imaginary <- sample(Im(cEOF2$hgt), N, replace = TRUE)
x <- sample(sams[term == "full" & lev == 200]$estimate, size = N, replace = TRUE)

fake_series <- data.table(SAM = x, 
                         Real = real,
                         Imaginary = imaginary,
                         year = 1979 + seq_len(N))

cor_with_eof2 <- fake_series %>% 
  melt(id.vars = c("year", "SAM")) %>% 
  .[, correlate(value, SAM), by = variable]

fake_field <- fake_series %>% 
  melt(id.vars = c("year"), variable.name = "term") %>% 
  patterns[., on = c("term"), allow.cartesian = TRUE] %>% 
  .[, field := value*estimate] %>% 
  .[, .(field = sum(field)), by = .(lon, lat, year)]

fake_eof <- fake_field %>% 
  .[, eof := Anomaly(field)*sqrt(cos(lat*pi/180)), by = .(lon, lat)] %>%
  EOF(eof ~ lon + lat | year, n = 1:3, data = ., suffix = "EOF")  
```

```{r fake-eof, fig.cap = "(ref:fake-eof-cap)", fig.width=3.7, fig.height=3.3}
north_thumb <- function(sdev, n){
  sdev <- sdev^2
  delta <- sqrt(2 / n) * sdev
  
  # Separation between each pair of eofs must be 
  # greater than the sum of their errors.
  separation <- abs(diff(sdev))
  separation >  delta[-length(delta)] + delta[-1]
}

separated <- north_thumb(fake_eof$sdev$sd^2, 41)
stopifnot(all(separated))

var <- fake_eof$sdev %>%
  copy() %>% 
  .[, setNames(paste0(EOF, " (", scales::percent(r2), ")"),
               EOF)]
var <- c(var, setNames(c("Annular Pattern", "Imaginary cEOF2", "Real cEOF2"),
                       c("SAM", "Imaginary", "Real")))


rbind(fake_eof$left,
      setnames(copy(patterns), c("term", "estimate"), c("EOF", "eof"))) %>% 
  .[, EOF := factor(EOF, levels = c("SAM", 
                                    "Imaginary",
                                    "Real", 
                                    paste0("EOF", 1:3)))] %>% 
  # geom_contour_tanaka has problem with the perfectly symemtric SAM
  # adding just a tiny bit of noise solves it. 
  .[, eof := scale(eof), by = EOF] %>% 
  .[EOF == "SAM", eof := eof + rnorm(.N, sd = 1e-5)] %>%
  .[EOF %in% c("EOF1", "EOF2"), eof := -eof] %>% 
  periodic(lon = c(0, 360)) %>%
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = eof, fill = ..level..), global.breaks = TRUE, 
                    breaks = AnchorBreaks(0, 0.5, exclude = 0)) +
  
  geom_contour_tanaka(aes(z = eof), global.breaks = TRUE,
                      breaks = AnchorBreaks(0,0.5,  exclude = 0)) +
  scale_fill_divergent_discretised(NULL, guide = guide_colorsteps_bottom(), 
                                   limits = c(-4, 4)) +
  geom_qmap(~.x[lat <= -20]) +
  scale_x_longitude() +
  scale_y_latitude(labels = NULL,
                   minor_breaks = NULL) +
  grid_y +
  coord_polar() +
  facet_wrap(~EOF, ncol = 3, labeller = labeller(EOF = var)) +
  axis_labs_smol +
  theme(axis.text = element_blank()) +
  tag_facets("rc")
```

To test the hypothesis that a PSA-like feature can appear as statistic contamination of an otherwise zonally symmetrical and uncorrelated annular pattern, we create a synthetic dataset of `r N` fields by reconstructing the SON 200 hPa geopotential height field explained by the cEOF2 and adding a perfectly zonally symmetric annular pattern with random sign and value sampled with replacement from the real SAM index.
To this synthetic dataset we then apply traditional EOF.
By construction this dataset contains two independent components: a zonally symmetric standing oscillation and a PSA-like of varying amplitude and phase (Figure \@ref(fig:fake-eof) row a).
While the former is a standing oscillation which could be represented by a single EOF, the latter is a wave which can change phase, so traditional EOF analysis needs two EOFs to represented it correctly.
Thus, the full variance of this synthetic dataset can be perfectly explained by three EOFs.

The three EOFs of the synthetic dataset are shown in Figure \@ref(fig:fake-eof) row b.
The annular pattern is captured mainly by the first EOF while the cEOF2 is explained by the second and third.
However, even though the annular pattern used to construct these data is perfectly zonally symmetric, the leading EOF is not.
The EOF decomposition mixes the true annular pattern with parts of the the zonally asymmetric cEOF2 pattern, resulting in a pattern pretty similar to the real SAM pattern [@fogt2020].


In this particular example, it is with the Imaginary part.
Of note, the three EOFs are well separated according to North's rule of thumb [@north1982].

This suggests that the zonal asymmetries of the SON SAM could very well be mostly a statistical artefact.
Since many surface impacts are mediated by the asymmetric component, as well as the relationship between SAM and ENSO [@campitelli2021], this potential issue could affect the interpretability of many results involving the SAM.
Studies on the relationship between the SAM and PSA-like patterns would be particularly difficult to interpret.
