---
journal: "Geophysical Research Letters"
options: "draft,linenumbers"
title: "How stationary are planetary waves in the Southern Hemisphere?"
authors:
  - name: Elio Campitelli
    affil: 1
  - name: Carolina Vera
    affil: "1, 2"
  - name: Leandro Díaz
    affil: "1, 2"
affiliations:
  - number: 1
    name: "Centro de Investigaciones del Mar y la Atmosfera, UMI-IFAECI (CONICET-UBA-CNRS)"
  - number: 2
    name: "Departamento de Ciencias de la Atmósfera y los Océanos (FCEyN, UBA)"
corresponding_author:
  - name: Elio Campitelli
    email: elio.campitelli@cima.fcen.uba.ar
keypoints:  
  - "Zonal waves and Quasi-stationary waves are disctinct but related phenomena"
  - "This distinction has theoretical and practical implications"
  - "The relationship between the mean ZW amplitude and QS amplitude yields an estimate of stationarity"
abstract: >
   Abstract goes here
output:
   rticles::agu_article:
      keep_tex: true
bibliography: qszw.bib
header-includes: 
      - \usepackage{gensymb} 
      - \usepackage{soulutf8}
      - \usepackage{subfig}
---

```{r setup, include=FALSE}
# Some recommended settings. 
knitr::opts_chunk$set(
   echo = FALSE,
   fig.pos = 'h',
   out.extra = "",   # To force the use of figure enviroment
   fig.cap = "Please caption every figure"
)

# Notification
start.time <- unclass(Sys.time())
min.time <- 10
knit_doc <- knitr::knit_hooks$get("document")
knitr::knit_hooks$set(document = function(x) {
   took <- unclass(Sys.time()) - start.time
   if (unclass(Sys.time()) - start.time >= min.time) {
      notify("Done knitting!", 
             paste0("Took ", round(took), " seconds"),
             time = 5)
   }  
   knit_doc(x)
})

name <- tools::file_path_sans_ext(knitr::current_input())
knitr::opts_chunk$set(cache = TRUE,
                      warning = FALSE, 
                      message = FALSE,
                      cache.extra = 2,
                      cache.path = paste0("cache/", name, "/"),
                      fig.path = paste0("fig/", name, "/"),
                      fig.align = "center")

library(metR)
library(data.table)
library(ggplot2)
library(metR)
library(magrittr)
library(circular)
library(RcppRoll)
library(patchwork)
library(lubridate)
library(ggperiodic)
library(latex2exp)
library(glue)

here <- here::here

gluec <- function(...) {
   unname(vapply(c(...), function(x) glue(x), FUN.VALUE = "a"))
}
source(here("scripts/helperfun.R"))
remove(ggplot)

data.world <- BuildMap(res = 1, smooth = 1)
map.world <- geom_map2(data.world)
map.SH <- geom_map2(data.world[lat %b% c(-90, 20)], color = "gray20")

lev.breaks <- c(1000, 500, 300, 200, 100, 50, 10)

theme_elio <- theme_minimal(base_size = 9) +
   theme(
      # text = element_text(family = font_rc),
      legend.position = "bottom", legend.box = "vertical",
      panel.spacing.y = unit(5, "mm"),
      panel.spacing.x = unit(5, "mm"),
      legend.spacing = unit(2, "mm"),
      plot.margin = grid::unit(rep(3, 4), "mm"),
      legend.title = element_blank(),
      legend.box.spacing = unit(3, "mm"),
      legend.margin = margin(t = -5),
      panel.grid = element_line(color = "gray50", size = 0.2, linetype = 3),
      panel.ontop = TRUE)
theme_set(theme_elio)
guide_colorstrip_bottom <- function(width = 25, height = 0.5, ...) {
   guide_colorstrip(title.position = "top", title.hjust = 0.5,
                    barheight = height,
                    barwidth = width, ...)
}

```

# Introduction

Zonal waves, also called planetary waves, that can develop in the extratropical latitudes of the Southern Hemisphere (SH), have received some attention by the scientific community because of its role in modulating weather systems and regional climate (xxREF). They are typically characterized by applying Fourier decomposition to hemispheric anomalies of sea-level pressure or geopotential heights. On the other hand, “stationary waves” or “quasi-stationary waves” are terms generally reserved in the literature to the zonal asymmetries of the time mean field ($\overline{\phi}^*$). These terms are sometimes used interchangeably in the SH circulation related studies [e.g. @Rao2004; @Raphael2004; @Kravchenko2012; @Irving2015; @Turner2017; @Lastovicka2018]. This leads to both inter and intra-studies inconsistencies. 

As examples of the former, @Quintanar1995a define “quasi-stationary waves (QS)” as the zonally asymmetric component of the climatological mean field. @Raphael2004, conversely, use the term "zonal wave (ZW)" when describing her index of planetary waves with wavenumber 3 in phase with the climatological mean wave 3. @Irving2015 compare @Raphael2004's QS index with their own index computed as the integrated southern hemisphere zonal "waviness" irrespective of phase. 

As for intra-studies inconsistencies, @Rao2004 follow the nomenclature of @Quintanar1995a for QS, but they analyze the mean amplitude of ZW instead of the amplitude of QS. @Kravchenko2012 analyze temperature ZW amplitude as a predictor of total ozone, but call it "quasi-stationary amplitude". @Turner2017 use “planetary wave k”, “quasi-stationary wave k” and “wave number k” as synonymous in their analysis of QS associated with different wavenumbers k. Furthermore, @Lastovicka2018 study QS and ZW but they use the term “stationary planetary wave (SPW)” to refer to both.

As the name suggests, it is recognized that QS are not completely stationary. They are the result of the superposition of many individual ZW, hence there can be variability of their individual phases. However, there are not recent studies assessing how “stationary” or “quasi-stationary” ZW are in the SH. 

In this study we show that the degree of stationarity of quasi-stationary waves is related to the distinction between QS and ZW. We propose using the ratio between the amplitude of QS and the mean amplitude of ZW as a measure of QS stationarity. By this measure, we show that planetary waves with wavenumbers 2 and 3 are significantly less stationary in the southern hemisphere than in the northern hemisphere. 

# Methods

## Data


```{r read-rao}
period_rao <- c("1980", "2017")
period_cap_rao <- glue("From monthly NCEP/NCAR Reanalysis, {period_rao[1]} to {period_rao[2]}")
rao_data <- rbind(ReadNetCDF(here("DATA/NCEP Reanalysis/hgt.mon.mean.nc"), 
                             c(gh = "hgt") ,
                             subset = list(lat = -60, 
                                           time = gluec("{period_rao[1]}-01-01",
                                                        "{period_rao[2]}-12-31"))),
                  ReadNetCDF(here("DATA/NCEP Reanalysis/hgt.mon.mean.nc"), 
                             c(gh = "hgt") ,
                             subset = list(lat = 60, 
                                           time = gluec("{period_rao[1]}-01-01",
                                                        "{period_rao[2]}-12-31"))))
setnames(rao_data, "level", "lev")
```

We will use monthly geopotential fields from the NCEP/NCAR Reanalysis [@Kalnay1996] for the period `r period_rao[1]` to `r period_rao[2]`.

## Zonal waves and quasi-stationary waves 

In this study we define *planetary waves* as waves that extend along a full latitude circle. Planetary waves of the “instantaneous” fields are called in this study, *zonal waves* (ZW), and the ones of the field mean will be called *quasi-stationary waves* (QS). They are characterized by their wavenumber, amplitude and phase such that

\begin{linenomath*}
\begin{eqnarray}\label{eq:ZW}
\mathrm{ZWk}(t) & = & A_\mathrm{ZWk}(t)\cos \left [ k\lambda - \alpha_\mathrm{ZWk}(t) \right ] \\ 
\overline{\mathrm{ZWk}(t)} = \mathrm{QSk} & = & A_\mathrm{QSk}\cos \left (  \mathrm{k}\lambda - \alpha_\mathrm{QSk} \right ) \label{eq:QS}
\end{eqnarray}
\end{linenomath*}

where $\mathrm{k}$ is the wavenumber, $\lambda$ the longitude, and $\mathrm{A_{x}}$ and $\alpha_\mathrm{x}$, the amplitude and phase of each wave, respectively. Note that $\mathrm{ZWk}(t)$ is, by construction, explicitly dependent on time, while $\mathrm{QSk}$ is not. Furthermore, from the properties of wave superposition it can be seen that, in general, $\alpha_\mathrm{QSk}$ does not equal $\overline{\alpha_\mathrm{ZWk}}$ an that $A_\mathrm{QSk}$ will always be less or equal than $\overline{A_\mathrm{ZWk}}$ [@Pain2005]. 

While these definitions depend on which are the "instantaneous field" in question (monthly, daily, sub daily, etc...) and the averaging time scale, they illustrate that ZW are properties of the *elements* of the set, while QS are properties of the set as a whole. This is an important distinction with theoretical and methodological implications that is not always differentiated in the literature.

# Results

## Amplitude

```{r compute-qs-zw-rao}
qs <- rao_data %>% 
   .[, .(gh = mean(gh)), by = .(lon, lat, lev, month(time))] %>% 
   .[, FitWave(gh, 1:3), keyby = .(lat, lev, month)] %>% 
   addkey(k) %>% 
   .[, phase := phase*k] %>% 
   .[, c("r2") := NULL]

zw <- rao_data %>%
   .[, FitWave(gh, 1:3), by = .(lat, lev, time)] %>% 
   .[, .(amplitude = mean(amplitude),
         phase = as.numeric(mean(circular(phase*k)))), 
     keyby = .(k, lat, lev, month(time))] 
rao_qs <- rbindlist(list(QS = qs,
                         ZW = zw), 
                    use.names = TRUE,
                    idcol = "variable") 
rao_qs[, variable := factor(variable)]

math_levels <- c(TeX("Amplitude of quasi-stationary wave ($A_{QS}$)"),
                 TeX("Mean amplitude of zonal waves ($\\bar{A_{ZW}}$)"))
```

```{r}
computed <- "computed as the amplitude of the mean wave ($A_\\mathrm{QSk}$) and as the mean amplitude of the monthly waves ($\\overline{A_\\mathrm{ZW} }$)"
k_prefix <- AddPreffix("Wavenumber ")
```

```{r rao, fig.cap = glue("Seasonal cycle of amplitude of the geopotential planetary waves 1 to 3 {computed}."), fig.subcap=c("At 60\\degree S", "At 60\\degree N"), fig.width=5, fig.ncol=1}
plot_crossection <- function(k, lat, binwidth) {
   ks <- k
   lats <- lat
   gdata <- periodic(rao_qs[k == ks & lat == lats], month = 1:13)
   levels(gdata$variable) <- math_levels
   g <- periodic(gdata[k == ks], month = 1:13) %>% 
      ggplot(aes(month, lev)) +
      # geom_contour_fill(aes(z = value), binwidth = binwidth) +
      geom_contour2(aes(z = amplitude), binwidth = binwidth) +
      geom_text_contour(aes(z = amplitude), binwidth = binwidth, rotate = F, skip = 1,
                        stroke = 0.2, size = 2) +
      scale_y_level("Pressure (hPa)") +
      scale_x_continuous("Month", breaks = 1:13, 
                         labels = c(month.abb, "13" = "Jan"),
                         expand = c(0, 0), minor_breaks = NULL) +
      # scale_fill_viridis_c(guide = guide_colorstrip_bottom()) +
      # coord_fixed(1.7) +
      theme(aspect.ratio = 0.5) +
      facet_grid(k ~ variable,
                 labeller = labeller(k = k_prefix,
                                     variable = label_parsed))
   
   if (k != 3) {
      g <- g +
         theme(axis.text.x = element_blank(), axis.title.x = element_blank())
   }
   if (k != 1) {
      g <- g + 
         theme(axis.title.y = element_blank(),
               strip.text.x = element_blank(),
               plot.margin = unit(c(-0, 1, 1, 1), "lines"))
   }
   return(g)
}

binwidths <- c(50, 10, 5)
binwidths2 <- c(25, 10, 5)*2

lapply(1:3, function(x) plot_crossection(x, -60, binwidths[x]))  %>% 
   Reduce("+", .) + 
   plot_layout(ncol = 1) 

lapply(1:3, function(x) plot_crossection(x, 60, binwidths2[x]))  %>% 
       Reduce("+", .) + 
       plot_layout(ncol = 1) 
```

Figure \ref{fig:rao} shows the seasonal cycle of the amplitude of planetary waves at 60\degree S and 60\degree N using monthly fields from the NCEP/NCAR reanalysis [@Kalnay1996] between `r period_rao[1]` and `r period_rao[2]`. The left column ($A_\mathrm{QS}$) is computed by taking the amplitude of the averaged geopotential field for each month, level and wavenumber. The right column ($\overline{A_\mathrm{ZW}}$) is computed by taking the average amplitude of the 49 individual ZW. 

Figure \ref{fig:rao1} (60\degree S) shows that for planetary wave 1, $A_\mathrm{QS1}$ and $\overline{A_\mathrm{ZW1}}$ have similar vertical structures, seasonal cycles and even magnitude. On the other hand, $A_\mathrm{QS2}$ is much smaller than  $\overline{A_\mathrm{ZW2}}$ and its seasonal cycle is much less defined. $A_\mathrm{QS3}$ has a smaller magnitude than $\overline{A_\mathrm{ZW3}}$ but they have an overall similar structure of one relative maximum in February-March in the middle troposphere and another in July-August that extends to the lower stratosphere. But the details are different, particularly there is a local $A_\mathrm{QS3}$ minimum in November that is not present in $\overline{A_\mathrm{ZW3}}$. The relative individual contribution of each wavenumber is also different. $\overline{A_\mathrm{ZW2}}$ is of higher magnitude than $\overline{A_\mathrm{ZW3}}$ in the stratosphere and of similar magnitude in the troposphere. Conversely, $A_\mathrm{QS2}$ is much smaller than $A_\mathrm{QS3}$ throughout the year and in almost every level with the exception of the aforementioned November minimum.  

In contrast to Figure \ref{fig:rao1}, Figure \ref{fig:rao2} shows that at 60\degree N $A_\mathrm{QS}$ and $\overline{A_\mathrm{ZW}}$ are very similar for the three wavenumbers. In all cases they have a similar seasonal cycle with similar vertical extent. This shows that the difference between $A_\mathrm{QS}$ and $\overline{A_\mathrm{ZW}}$ are location-dependent. 

## Stationarity Index 

@Loon1972 recognized the distinction between $\overline{A_\mathrm{ZW}}$ and $A_\mathrm{QS}$ and, deduced that "the daily phases of waves 2 and 4-6 at 50\degree S must therefore be random since the waves almost cancel themselves when added, whereas 1 and 3 must recur consistently in certain longitudes since they are significantly large in the climatological mean". This observation motivates that stationary conditions in the circulation of the SH could be measured using the quotient between the two quantities. As an analogy with the constancy of the wind [@Singer1967], the stationarity of the QS can be estimated as

\begin{linenomath*}
\begin{equation}\label{eq:S}
\hat{S} = \frac{A_\mathrm{QS}}{\overline{A_\mathrm{ZW}}}
\end{equation}
\end{linenomath*}

It can be shown that $\hat{S} = 1$ for completely stationary waves. On the other hand, it can be demonstrated that the expected amplitude of the sum of $n$ waves with random phases and mean amplitude $A$ is $An^{-1/2}$ [@Pain2005]. Thus, for completely non stationary waves, the expected value of $\hat{S}$ is $n^{-1/2}$. 

$\hat{S}$ can equivalently be mathematically defined as

\begin{linenomath*}
\begin{equation}\label{eq:S2}
\hat{S} =   \frac{\sum_t A_\mathrm{ZW}(t) \cos  \left [\alpha_\mathrm{zw}(t) - \alpha_{qs} \right ]}{\sum_t A_\mathrm{ZW}(t)}
\end{equation}
\end{linenomath*}

The numerator is the sum of the projections of each $\mathrm{ZW}$ onto the direction of the $\mathrm{QS}$. Equation \ref{eq:S2} has some advantages over Equation \ref{eq:S}. First, it makes is clear that stationarity is a mixture of a phase effect and an amplitude effect. Secondly, one can, in principle, replace $\alpha_{qs}$ with any direction of interest, allowing to evaluate $\hat{S}(\alpha)$. This can also be useful for removing variability due to the seasonal cycle. The position of the monthly QS3 has a shift of about 15\degree between January and July [@Loon1972], so by replacing $\alpha_{qs}$ with $\alpha_{qs}(month)$ (one for each month) one can evaluate stationarity with respect to the seasonal changing position of the mean wave. Finally, it is possible to transform the sums into running sums with window $w$ and obtain $\hat{S}(w, t)$ and analyse variations of stationarity with time. 

While $\hat{S}$ is used --sometimes as $2/\pi\arcsin \left (\hat{S} \right )$ [@Singer1967]-- in the meteorological literature in the context of wind steadiness, to our knowledge this is the first time it has been applied to the study of atmospheric waves. However, its statistical properties are not well studied. One problem with $\hat{S}$ is that, as seen above, its estimation from a finite sample has a positive bias, but its convergence properties are not explored.




```{r stationarity, fig.cap = "Seasonal cycle of stationarity at 60\\degree S and 60\\degree N computed using Equation \\ref{eq:S}", fig.align="center", fig.width=5}
rao_qs %>% 
   dcast(lev + month + lat + k ~ variable, value.var = "amplitude") %>% 
   .[, S := QS/ZW] %>% 
   ggplot(aes(month, lev)) +
   geom_contour_fill(aes(z = S), binwidth = 0.1) +
   scale_y_level("Pressure (hPa)") +
   scale_x_continuous("Month", breaks = 1:13, 
                      labels = c(month.abb, "13" = "Jan"),
                      expand = c(0, 0), minor_breaks = NULL) +
   scale_fill_viridis_c(guide = guide_colorstrip_bottom(15),
                        breaks = MakeBreaks(0.1)) +
   theme(aspect.ratio = 0.5) +
   facet_grid(k ~ lat, labeller = labeller(k = k_prefix, 
                                           lat = LatLabel))
``` 


Figure \ref{fig:stationarity} shows $\hat{S}$ for QS 1 to 3 computed using Equation \ref{eq:S} at 60\degree S and 60\degree N. .....

## Considerations about phase 
\label{sec:phase}

```{r raphael_data}
ncep <- ReadNetCDF(here("DATA", "NCEP Reanalysis", "hgt.mon.mean.nc"), c(gh = "hgt") ,
                   subset = list(level = 300, 
                                 time = gluec("{period_rao[1]}-01-01",
                                              "{period_rao[2]}-12-31")))
setnames(ncep, "level", "lev")

raphael <- ncep[lat %~% -49] %>% 
   .[, gh := Anomaly(gh), by = .(lat, time)] %>% 
   .[lon %~% c(50, 166, 289)] %>% 
   .[, gh.s := RcppRoll::roll_mean(gh, 3, fill = NA), by = lon] %>%
   .[!is.na(gh.s)] %>% 
   .[, gh.std := (gh.s - mean(gh.s))/sd(gh.s), by = .(lon)] %>% 
   .[, .(I3 = mean(gh.std)), by = time] %>% 
   .[, I3 := as.numeric(scale(I3))]


ZW <- ncep[lat %~% -49] %>% 
   .[, gh.s := RcppRoll::roll_mean(gh, 3, fill = NA), by = lon] %>%
   .[!is.na(gh.s)] %>% 
   .[, FitWave(gh.s, 3), by = .(time)] %>% 
   .[, phase.m := mean.phase(amplitude, phase, 3)] %>% 
   .[, proj := amplitude*cos(3*(phase - phase.m))] %>% 
   .[, proj.std := as.numeric(scale(proj))]


raphael <- raphael[ZW[, .(time, proj.std)], on = "time"]
raphael_cor <- raphael[, cor(I3, proj.std)]
```

For defining local impacts, the phase of planetary waves is as important as their amplitude if not more. One way of dealing with the phase of ZW is to fix it. @Yuan2008 use Principal Component Analysis on the meridional wind field to obtain a spatial pattern of the leading mode that is very similar to the QS3. The timeseries associated to this mode is, then, an indication of the intensity of the ZW3 that is similar to the QS3. A more direct approach is the index created by @Raphael2004. Since it is based on the geopotential height anomalies at the maximums of the QS3, it is sensitive to ZW3 patterns with phase close to the stationary phase. An almost mathematically equivalent approach (with correlation = `r round(raphael_cor, 2)`) is to compute the projection of each $\mathrm{ZW}$ onto the direction of the $\mathrm{QS}$ (i.e. the expression inside the sum of the numerator in Equation \ref{eq:S2}). This methodology has fewer constrains in that the phase of interest can be changed depending on the application. 

# Conclusions

The fact that zonal waves (ZW) and quasi-stationary waves (QS) are two distinct but related phenomena has both practical and theoretical implications. 

First, researchers should be aware of which phenomena they want to study and use the appropriate methods. The mean amplitude of the ZW could be appropriate to study the vertical propagation of Rossby waves, for example. But ZW amplitude could lead to misleading results if used as the basis of local impacts studies because they are probably more influenced by phase effects. 

Secondly, comparison between results should also be made having this issues in mind. For instance, @Irving2015 compare their planetary wave activity index with @Raphael2004's wave 3 index and conclude that the later cannot account for events with waves far removed from their climatological position. However, in light of the discussion in Section \ref{sec:phase}, this limitation becomes a feature, not a bug. 

Although having a consistent nomenclature across papers is desirable, we believe that this problems can be ameliorated by researchers detailing their definitions and methodology. This is also good for clarity and reproducibility. Since planetary waves are generally more stationary in the northern hemisphere, these issues are more critical for studies of the southern hemisphere. 

Thirdly, the explorations of both ZW and QS can lead to novel levels of analysis. Here, we showed it can be used to define a metric of stationarity of quasi-stationary waves, but other applications are also possible. @Smith2012 used the phase relationship between ZW1 and QS1 to show that linear interference between the QS1 and ZW1 was related to vertical wave activity transport at the tropopause. 



*xx me falta un final acá xx*
