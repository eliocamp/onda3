---
# Choose from this list of Journals:
# JGR: Atmospheres, JGR: Biogeosciences, JGR: Earth Surface, 
# JGR: Oceans, JGR: Planets, JGR: Solid Earth, JGR: Space Physics, 
# Global Biogeochemical Cycles, Geophysical Research Letters, 
# Paleoceanography and Paleoclimatology, Radio Science, Reviews of Geophysics, 
# Tectonics, Space Weather, Water Resources Research, Geochemistry, Geophysics, 
# Geosystems, Journal of Advances in Modeling Earth Systems (JAMES),
# Earth's Future, Earth and Space Science, Geohealth
journal: "JGR: Atmospheres"
# Use draft to submit a paper
options: "draft,linenumbers"
# A title should be specific, informative, and brief. Use
# abbreviations only if they are defined in the abstract. Titles that
# start with general keywords then specific terms are optimized in
# searches
title: "Are quasi-stationary waves and planetary waves the same?"
# First name or initial followed by last name
# Authors are individuals who have significantly contributed to the
# research and preparation of the article. Group authors are allowed, if
# each author in the group is separately identified in an appendix.
# Additional author notes should be indicated with
authors:
  - name: Elio Campitelli
    affil: 1
  - name: Carolina Vera
    affil: "1, 2"
  - name: Leandro Díaz
    affil: "1, 2"
affiliations:
  - number: 1
    name: "Centro de Investigaciones del Mar y la Atmosfera, UMI-IFAECI (CONICET-UBA-CNRS)"
  - number: 2
    name: "Departamento de Ciencias de la Atmósfera y los Océanos (FCEyN, UBA)"
# More than one corresponding author is allowed in this LaTeX file and for
# publication; but only one corresponding author is allowed in our editorial system.
corresponding_author:
  - name: Elio Campitelli
    email: elio.campitelli@cima.fcen.uba.ar
keypoints:  
  - "List up to three key points (at least one is required)"
  - "Key Points summarize the main points and conclusions of the article"
  - "Each must be 100 characters or less with no special characters or punctuation"
abstract: |
  A good abstract will begin with a short description of the problem
  being addressed, briefly describe the new data or analyses, then
  briefly states the main conclusion(s) and how they are supported and
  uncertainties. 
output: 
   rticles::agu_article:
      keep_tex: yes
bibliography: qszw.bib
header-includes: 
      - \usepackage{gensymb} 
      - \usepackage{trackchanges}
# As of 2018 we recommend use of the TrackChanges package to mark revisions.
# The trackchanges package adds five new LaTeX commands:
#
#  \note[editor]{The note}
#  \annote[editor]{Text to annotate}{The note}
#  \add[editor]{Text to add}
#  \remove[editor]{Text to remove}
#  \change[editor]{Text to remove}{Text to add}
#
# complete documentation is here: http://trackchanges.sourceforge.net/
---

```{r setup, include=FALSE}
# Some recommended settings. 
knitr::opts_chunk$set(
   echo = FALSE,
   fig.pos = 'h',
   out.extra = "",   # To force the use of figure enviroment
   fig.cap = "Please caption every figure"
)

# Notification
start.time <- unclass(Sys.time())
min.time <- 10
knit_doc <- knitr::knit_hooks$get("document")
knitr::knit_hooks$set(document = function(x) {
   took <- unclass(Sys.time()) - start.time
   if (unclass(Sys.time()) - start.time >= min.time) {
      notify("Done knitting!", 
             paste0("Took ", round(took), " seconds"),
             time = 5)
   }  
   knit_doc(x)
})

name <- tools::file_path_sans_ext(knitr::current_input())
knitr::opts_chunk$set(cache = TRUE,
                      warning = FALSE, 
                      message = FALSE,
                      cache.path = paste0("cache/", name, "/"),
                      fig.path = paste0("fig/", name, "/"))

library(metR)
library(data.table)
library(ggplot2)
library(metR)
library(magrittr)
library(circular)
library(RcppRoll)
library(patchwork)
library(lubridate)
library(ggperiodic)

here <- here::here
source(here("scripts/helperfun.R"))

data.world <- BuildMap(res = 1, smooth = 1)
map.world <- geom_map2(data.world)
map.SH <- geom_map2(data.world[lat %b% c(-90, 20)], color = "gray20")

lev.breaks <- c(1000, 500, 300, 200, 100, 50, 10)

theme_elio <- theme_minimal(base_size = 11) +
   theme(
      # text = element_text(family = font_rc),
      legend.position = "bottom", legend.box = "vertical",
      panel.spacing.y = unit(5, "mm"),
      panel.spacing.x = unit(5, "mm"),
      legend.spacing = unit(2, "mm"),
      plot.margin = grid::unit(rep(3, 4), "mm"),
      legend.title = element_blank(),
      legend.box.spacing = unit(3, "mm"),
      legend.margin = margin(t = -5),
      panel.grid = element_line(color = "gray50", size = 0.2, linetype = 3),
      panel.ontop = TRUE)
theme_set(theme_elio)
guide_colorstrip_bottom <- function(width = 25, height = 0.5, ...) {
   guide_colorstrip(title.position = "top", title.hjust = 0.5,
                    barheight = height,
                    barwidth = width, ...)
}

```


```{r read-data}
rao_data <- ReadNetCDF(here("DATA/NCEP Reanalysis/hgt.mon.mean.nc"), c(gh = "hgt") ,
                       subset = list(lat = -60, 
                                     time = c("1950-01-01", "1998-12-01")))
setnames(rao_data, "level", "lev")
```


```{r compute-qs-zw}
rao_data %>% 
   .[lat == -60, .(gh = mean(gh)), by = .(lon, lev, month(time))] %>% 
   .[, FitWave(gh, 1:3), keyby = .(lev, month)] %>% 
   addkey(k) %>% 
   .[, c("phase", "r2") := NULL] -> qs
setnames(qs, "amplitude", "QS")

rao_qs <- rao_data %>%
   .[lat == -60, FitWave(gh, 1:3), by = .(lev, time)] %>% 
   .[, .(ZW = mean(amplitude)), keyby = .(k, lev, month(time))] %>% 
   .[qs, on = key(qs)] %>% 
   melt(id.vars = key(qs), measure.vars = c("ZW", "QS"))
```


# Introduction

Atmospheric planetary waves are blabalbaal... 
In some latitudes and tiems of the year they exhibit some degree of stationatiry...


# Story

...

Zonal waves (ZW; sometimes also called planetary waves) are waves observed in each individual "instantaneous" field. Quasi-stationary waves (QS), on the other hand, are the resulting waves in the mean field. Of course, these definitions depend on which are the "instantaneous field" in question and the averaging timescales used. However, they illustrate that, given a set of tmospheric fields, ZWs are properties of the *elements* of the set, while the QS is a property of the set as a whole. This is an important distinction with theorical and methodological implications but is not always appreciated in the literature.

```{r rao, fig.cap = "Seasonal cycle of amplitude of the geopotential planetary waves 1 to 3 at 60\\degree S computed as the mean amplitude of the monthly waves ($\\overline{ZW}$) and as the amplitude of the mean wave (QS). The period of analysis is 1950 to 1998. The left column reproduces Figure 3 from \\citet{Rao2004}."}
plot_crossection <- function(k, binwidth) {
   ks <- k
   g <- periodic(rao_qs[k == ks], month = 1:13) %>% 
      ggplot(aes(month, lev)) +
      # geom_contour_fill(aes(z = value), binwidth = binwidth) +
      geom_contour2(aes(z = value), binwidth = binwidth) +
      geom_text_contour(aes(z = value), binwidth = binwidth, rotate = F, skip = 1,
                        stroke = 0.2, size = 2) +
      scale_y_level("Pressure (hPa)") +
      scale_x_continuous("Month", breaks = 1:13, 
                         labels = c(month.abb, "13" = "Jan"),
                         expand = c(0, 0)) +
      # scale_fill_viridis_c(guide = guide_colorstrip_bottom()) +
      # coord_fixed(1.7) +
      theme(aspect.ratio = 0.5) +
      facet_grid(k ~ variable, 
                 labeller = labeller(k = AddPreffix("Planetary\n Wave "),
                                     variable = c(ZW = "Mean Zonal Wave\n(ZW)",
                                                  QS = "Quasi-stationariy Wave\n(QS)")))
   
   if (k != 3) {
      g <- g +
         theme(axis.text.x = element_blank(), axis.title.x = element_blank())
   }
   if (k != 1) {
      g <- g + 
         theme(axis.title.y = element_blank(),
               strip.text.x = element_blank(),
               plot.margin = unit(c(-0, 1, 1, 1), "lines"))
   }
   return(g)
}

binwidths <- c(50, 10, 5)

lapply(1:3, function(x) plot_crossection(x, binwidths[x]))  %>% 
   Reduce("+", .) + 
   plot_layout(ncol = 1) 
```

As an example, Figure \ref{fig:rao} shows the monthly seasonal cycle of amplitude of planetary waves at 60\degree S using monthly fields from the NCEP/NCAR reanalysis \citep{Kalnay1996} between 1950 and 1998. The left column ($\overline{ZW}$) reproduces Figure 3 from \citet{Rao2004} and is computed by taking --for each month and level-- the average amplitude of the 49 individual amplitudes. The right column (QS), on the other hand, is computed by taking the amplitude of the average geopotential field for each month and level. 

The resulting fields convey different information. First, the amplitude of $\overline{ZW}$ fields is always greater than the one for QS fields. This is a \annote[elio]{mathematical necessity}{Deberia demostrar eso? Vale la pena una demostracion en un material suplementario?} that explains \citet{Rao2004}'s observation that their Wave 1 amplitude was greater than that reported by \citet{Hurrell1998}. Secondly, they have different annual cycles and vertical structures. QS2, for example, has a strong minimum in the low stratosphere during the austral autumn that is not aparent in $\overline{ZW2}$. Similarly, the austral winter mid-troposferic maxmium is very well defined in $\overline{ZW3}$ but not so in QS3. Thirdly, the relative importance between each wavenumber vary. $\overline{ZW}$ fields show, for example, a preponderance of wave 2 over 3 in almost every level and month. However, the QS3 has greater amplitude than QS2 in the first half of the year. In contrast with wave-numbers 2 and 3, $\overline{ZW1}$ and QS1 fields are very similar.

```{r hurrell, fig.cap = "Seasonal cycle of amplitude of the geopotential planetary waves 2 at 300hPa computed as the mean amplitude of the monthly waves ($\\overline{ZW}$) and as the amplitude of the mean wave (QS). The period of analysis is 1979 to 2017."}
ncep <- ReadNetCDF(here("DATA", "NCEP Reanalysis", "hgt.mon.mean.nc"), c(gh = "hgt") ,
                   subset = list(level = 300, 
                                 time = c("1979-01-01", "2017-12-01")))
setnames(ncep, "level", "lev")

ncep %>% 
   .[, .(gh = mean(gh)), by = .(lon, lat, month(time))] %>% 
   .[, FitWave(gh, 1:3), keyby = .(lat, month)] %>% 
   addkey(k) %>% 
   .[, c("phase", "r2") := NULL] -> qs
setnames(qs, "amplitude", "QS")

qs <- ncep %>%
   .[, FitWave(gh, 1:3), by = .(lat, time)] %>% 
   .[, .(ZW = mean(amplitude)), keyby = .(k, lat, month(time))] %>% 
   .[qs, on = key(qs)] 

qs <- melt(qs, id.vars = key(qs), measure.vars = c("ZW", "QS"))
qs %>% 
   periodic(month = 1:13) %>% 
   ggplot(aes(month, lat)) +
   geom_contour_fill(aes(z = value), breaks = 60) +
   geom_contour2(aes(z = value), binwidth = 20) +
   geom_text_contour(aes(z = value), binwidth = 20, rotate = F, skip = 1,
                     stroke = 0.2, size = 2) +
   scale_y_latitude(limits = pm(90)) +
   scale_x_continuous("Month", breaks = 1:13, labels = c(month.abb, "13" = "Jan"),
                      expand = c(0, 0)) +
   theme(aspect.ratio = 0.5) +
   facet_grid(k ~ variable, 
              labeller = labeller(k = AddPreffix("Planetary\n Wave "),
                                  variable = c(ZW = "Mean Zonal Wave\n(ZW)",
                                               QS = "Quasi-stationariy Wave\n(QS)")))
```

These differences are related to the degree of stationatiry of zonal waves and are location-dependent. Figure \ref{fig:hurrell} show the same variable that Figure \ref{fig:rao} but for 300hPa. The contrast between the northern and shouthern hemisphere is not only evident in the amplitud of the planetary waves, but also in the comparison between $\overline{ZW}$ and QS. Specially for wave-numbers 2 and 3, $\overline{ZW}$ and QS fields are very similar in the north but they have significant diferences in the south. The theorical implication is that planetary waves are more stationary in the northern hemispher while the practical implication is that researchers of the southern hemisphere planetary waves should be specially atentive to the choice of metodology. 

Another important consequence of the distinction between $\overline{ZW}$ and QS is that the quotient between the two can be used as a measure of stationarity. As an analogy with the steadiness of the wind \citep{Singer1967}, planetary wave stationarity can be calculated as

\begin{linenomath*}
\begin{equation}\label{eq:S}
S = \frac{2}{\pi}\arcsin{\left ( \frac{QS}{\overline{ZW}} \right )}
\end{equation}
\end{linenomath*}

It can be shown that $S = 1$ for completely stationary waves and that $E(S) = n^{-1/2}$ for completely non-stationary waves (where $n$ is the sample size).

```{r stationarity, fig.cap = "Stationarity of the 300hPa geopotential QS2 "}
qs[k == 3] %>% 
   dcast(month + lat + k ~ variable) %>%
   .[, S := 2/pi*asin(QS/ZW)] %>% 
   periodic(month = 1:13) %>% 
   ggplot(aes(month, lat)) +
   geom_contour_fill(aes(z = S), binwidth = 0.2) +
   geom_contour2(aes(z = S), binwidth = 0.2) +
   # geom_text_contour(aes(z = S), binwidth = 0.2, rotate = F, skip = 1,
   #                   stroke = 0.2, size = 2) +
   scale_y_latitude(limits = pm(90)) +
   scale_x_continuous("Month", breaks = 1:13, labels = c(month.abb, "13" = "Jan"),
                      expand = c(0, 0)) +
   scale_fill_viridis_c(guide = guide_colorstrip_bottom(),
                        breaks = MakeBreaks(0.2)) +
   # coord_fixed(1/25) +
   theme(aspect.ratio = 0.5)
```


As an exmaple, Figure \ref{fig:stationarity} shows $S$ for QS2 computed using Equation \ref{eq:S}. The


