---
journal: "JGR: Atmospheres"
# Use draft to submit a paper
options: "draft,linenumbers"
title: "Are planetary waves the same thing as quasi-stationary waves?"
authors:
  - name: Elio Campitelli
    affil: 1
  - name: Carolina Vera
    affil: "1, 2"
  - name: Leandro Díaz
    affil: "1, 2"
affiliations:
  - number: 1
    name: "Centro de Investigaciones del Mar y la Atmosfera, UMI-IFAECI (CONICET-UBA-CNRS)"
  - number: 2
    name: "Departamento de Ciencias de la Atmósfera y los Océanos (FCEyN, UBA)"
corresponding_author:
  - name: Elio Campitelli
    email: elio.campitelli@cima.fcen.uba.ar
keypoints:  
  - "Zonal waves and Quasi-stationary waves are disctinct but related phenomena"
  - "This distinction has theoretical and practical implications"
  - "The relationship between the mean ZW amplitude and QS amplitude yields an estiamte of stationarity"
abstract: |
   In the meteorological literature the analysis of the zonally asymmetric 
   it is very common to analyse 
output: 
   rticles::agu_article
   # word_document
bibliography: qszw.bib
header-includes: 
      - \usepackage{gensymb} 
      - \usepackage{soulutf8}
# As of 2018 we recommend use of the TrackChanges package to mark revisions.
# The trackchanges package adds five new LaTeX commands:
#
#  \note[editor]{The note}
#  \annote[editor]{Text to annotate}{The note}
#  \add[editor]{Text to add}
#  \remove[editor]{Text to remove}
#  \change[editor]{Text to remove}{Text to add}
#
# complete documentation is here: http://trackchanges.sourceforge.net/
---

```{r setup, include=FALSE}
# Some recommended settings. 
knitr::opts_chunk$set(
   echo = FALSE,
   fig.pos = 'h',
   out.extra = "",   # To force the use of figure enviroment
   fig.cap = "Please caption every figure"
)

# Notification
start.time <- unclass(Sys.time())
min.time <- 10
knit_doc <- knitr::knit_hooks$get("document")
knitr::knit_hooks$set(document = function(x) {
   took <- unclass(Sys.time()) - start.time
   if (unclass(Sys.time()) - start.time >= min.time) {
      notify("Done knitting!", 
             paste0("Took ", round(took), " seconds"),
             time = 5)
   }  
   knit_doc(x)
})

name <- tools::file_path_sans_ext(knitr::current_input())
knitr::opts_chunk$set(cache = TRUE,
                      warning = FALSE, 
                      message = FALSE,
                      cache.path = paste0("cache/", name, "/"),
                      fig.path = paste0("fig/", name, "/"),
                      fig.align = "center")

library(metR)
library(data.table)
library(ggplot2)
library(metR)
library(magrittr)
library(circular)
library(RcppRoll)
library(patchwork)
library(lubridate)
library(ggperiodic)
library(latex2exp)
library(glue)

here <- here::here
source(here("scripts/helperfun.R"))

data.world <- BuildMap(res = 1, smooth = 1)
map.world <- geom_map2(data.world)
map.SH <- geom_map2(data.world[lat %b% c(-90, 20)], color = "gray20")

lev.breaks <- c(1000, 500, 300, 200, 100, 50, 10)

theme_elio <- theme_minimal(base_size = 9) +
   theme(
      # text = element_text(family = font_rc),
      legend.position = "bottom", legend.box = "vertical",
      panel.spacing.y = unit(5, "mm"),
      panel.spacing.x = unit(5, "mm"),
      legend.spacing = unit(2, "mm"),
      plot.margin = grid::unit(rep(3, 4), "mm"),
      legend.title = element_blank(),
      legend.box.spacing = unit(3, "mm"),
      legend.margin = margin(t = -5),
      panel.grid = element_line(color = "gray50", size = 0.2, linetype = 3),
      panel.ontop = TRUE)
theme_set(theme_elio)
guide_colorstrip_bottom <- function(width = 25, height = 0.5, ...) {
   guide_colorstrip(title.position = "top", title.hjust = 0.5,
                    barheight = height,
                    barwidth = width, ...)
}

```


# Introduction

Many atmospheric variables have a strong dependence with latitude, so it is often natural to decompose them into a zonal mean component and a deviation from it. If $\phi$ is a generic variable, then 

\begin{linenomath*}
\begin{equation}\label{eq:Z}
\phi_{(x, y, z, t)} = [\phi]_{(y, z, t)} + \phi_{(x, y, z, t)}^*
\end{equation}
\end{linenomath*}

where $[\phi]$ is the mean zonal field and $\phi^*$, the deviations from it. This zonally asymmetric part is sometimes called "zonal wave" or "planteary wave". The names "stationary wave" or "quasi-strationary wave", on the other hand, are generaly reserved to the zonal asymmetires of the time mean field ($\overline{\phi}^*$). However, these terms are sometimes used interchangeably in the literature (e.g. @Rao2004, @Raphael2004, @Kravchenko2012, @Irving2015, @Turner2017, @Lastovicka2018) which could lead to some confusion. 

Given a set of atmospheric fields, we define *zonal waves* (ZW) as waves observed in each individual "instantaneous" field and *quasi-stationary waves* (QS) as the resulting waves in the mean field. While these definitions depend on which are the "instantaneous field" in question (monthly, daily, subdaily, etc...) and the averaging timescales used, they illustrate that ZWs are properties of the *elements* of the set, while the QSs are properties of the set as a whole. This is an important distinction with theoretical and methodological implications that is not always appreciated in the literature.

# Story

```{r read-rao}
period_rao <- c("1950", "1998")
rao_data <- ReadNetCDF(here("DATA/NCEP Reanalysis/hgt.mon.mean.nc"), c(gh = "hgt") ,
                       subset = list(lat = -60, 
                                     time = c(glue("{period_rao[1]}-01-01"),
                                              glue("{period_rao[2]}-12-31"))))
setnames(rao_data, "level", "lev")
```

```{r compute-qs-zw-rao}
rao_data %>% 
   .[lat == -60, .(gh = mean(gh)), by = .(lon, lev, month(time))] %>% 
   .[, FitWave(gh, 1:3), keyby = .(lev, month)] %>% 
   addkey(k) %>% 
   .[, c("phase", "r2") := NULL] -> qs
setnames(qs, "amplitude", "QS")

rao_qs <- rao_data %>%
   .[lat == -60, FitWave(gh, 1:3), by = .(lev, time)] %>% 
   .[, .(ZW = mean(amplitude)), keyby = .(k, lev, month(time))] %>% 
   .[qs, on = key(qs)] %>% 
   melt(id.vars = key(qs), measure.vars = c("ZW", "QS"))
```

```{r rao, fig.cap = glue("Seasonal cycle of amplitude of the geopotential planetary waves 1 to 3 at 60\\degree S computed as the mean amplitude of the monthly waves ($\\overline{{ZW}}$) and as the amplitude of the mean wave (QS). The period of analysis is {period_rao[1]} to {period_rao[2]}. The left column reproduces Figure 3 from @Rao2004.")}

plot_crossection <- function(k, binwidth) {
   ks <- k
   gdata <- periodic(rao_qs[k == ks], month = 1:13)
   levels(gdata$variable) <- c(TeX("Mean amplitude of zonal waves ($\\bar{ZW}$)"),
                            TeX("Amplitude of quasi-stationary wave (QS)"))
   g <- periodic(gdata[k == ks], month = 1:13) %>% 
      ggplot(aes(month, lev)) +
      # geom_contour_fill(aes(z = value), binwidth = binwidth) +
      geom_contour2(aes(z = value), binwidth = binwidth) +
      geom_text_contour(aes(z = value), binwidth = binwidth, rotate = F, skip = 1,
                        stroke = 0.2, size = 2) +
      scale_y_level("Pressure (hPa)") +
      scale_x_continuous("Month", breaks = 1:13, 
                         labels = c(month.abb, "13" = "Jan"),
                         expand = c(0, 0)) +
      # scale_fill_viridis_c(guide = guide_colorstrip_bottom()) +
      # coord_fixed(1.7) +
      theme(aspect.ratio = 0.5) +
      facet_grid(k ~ variable, 
                 labeller = labeller(k = AddPreffix("Planetary\n Wave "),
                                     variable = label_parsed))
   
   if (k != 3) {
      g <- g +
         theme(axis.text.x = element_blank(), axis.title.x = element_blank())
   }
   if (k != 1) {
      g <- g + 
         theme(axis.title.y = element_blank(),
               strip.text.x = element_blank(),
               plot.margin = unit(c(-0, 1, 1, 1), "lines"))
   }
   return(g)
}

binwidths <- c(50, 10, 5)

lapply(1:3, function(x) plot_crossection(x, binwidths[x]))  %>% 
   Reduce("+", .) + 
   plot_layout(ncol = 1) 
```

To illustrate the distinction between ZWs and QS, Figure \ref{fig:rao} shows the monthly seasonal cycle of amplitude of planetary waves at 60\degree S using monthly fields from the NCEP/NCAR reanalysis (@Kalnay1996) between 1950 and 1998. The left column ($\overline{ZW}$) reproduces Figure 3 from @Rao2004 and is computed by taking --for each month and level-- the average amplitude of the 49 individual amplitudes. The right column (QS), on the other hand, is computed by taking the amplitude of the average geopotential field for each month and level. 

The resulting fields convey different information. First, the amplitude of $\overline{ZW}$ fields is always greater than the one for QS fields. This is a mathematical necessity  (*xx¿Deberia demostrar eso? Vale la pena una demostracion en un material suplementario?xx*) that explains @Rao2004's observation that their Wave 1 amplitude was greater than that reported by @Hurrell1998. Secondly, they have different annual cycles and vertical structures. QS2, for example, has a strong minimum in the low stratosphere during the austral autumn that is not apparent in $\overline{ZW2}$. Similarly, the austral winter mid-tropospheric maximum is very well defined in $\overline{ZW3}$ but not so in QS3. Thirdly, the relative importance between each wave number vary. $\overline{ZW}$ fields show, for example, a preponderance of wave 2 over 3 in almost every level and month. However, the QS3 has greater amplitude than QS2 in the first half of the year. In contrast with wave-numbers 2 and 3, $\overline{ZW1}$ and QS1 fields are very similar.

```{r}
period_rest <- c(1979, 2017)
period_cap <- glue("From monthly NCEP/NCAR Reanalysis, {period_rest[1]} to {period_rest[2]}")
```

```{r hurrell, fig.cap = glue("Seasonal cycle of amplitude of the geopotential planetary waves 2 at 300hPa computed as the mean amplitude of the monthly waves ($\\overline{{ZW}}$) and as the amplitude of the mean wave (QS). {period_cap}.")}
ncep <- ReadNetCDF(here("DATA", "NCEP Reanalysis", "hgt.mon.mean.nc"), c(gh = "hgt") ,
                   subset = list(level = 300, 
                                 time = c(glue("{period_rest[1]}-01-01"), 
                                          glue("{period_rest[2]}-12-31"))))
setnames(ncep, "level", "lev")

ncep %>% 
   .[, .(gh = mean(gh)), by = .(lon, lat, month(time))] %>% 
   .[, FitWave(gh, 1:3), keyby = .(lat, month)] %>% 
   addkey(k) %>% 
   .[, c("phase", "r2") := NULL] -> qs
setnames(qs, "amplitude", "QS")

qs <- ncep %>%
   .[, FitWave(gh, 1:3), by = .(lat, time)] %>% 
   .[, .(ZW = mean(amplitude)), keyby = .(k, lat, month(time))] %>% 
   .[qs, on = key(qs)] 

gdata <- melt(qs, id.vars = key(qs), measure.vars = c("ZW", "QS")) %>% 
   periodic(month = 1:13) 
levels(gdata$variable) <- c(TeX("Mean amplitude of zonal waves ($\\bar{ZW}$)"),
                            TeX("Amplitude of quasi-stationary wave (QS)"))
ggplot(gdata, aes(month, lat)) +
   geom_contour_fill(aes(z = value), breaks = 60) +
   geom_contour2(aes(z = value), binwidth = 20) +
   geom_text_contour(aes(z = value), binwidth = 20, rotate = F, skip = 1,
                     stroke = 0.2, size = 2) +
   scale_y_latitude(limits = pm(90)) +
   scale_x_continuous("Month", breaks = 1:13, labels = c(month.abb, "13" = "Jan"),
                      expand = c(0, 0)) +
   theme(aspect.ratio = 0.5) +
   facet_grid(k ~ variable, 
              labeller = labeller(k = AddPreffix("Planetary\n Wave "),
                                  variable = label_parsed))
```

These differences are related to the degree of stationarity of zonal waves and are location-dependent. Figure \ref{fig:hurrell} show the same variable that Figure \ref{fig:rao} but for 300hPa. The contrast between the northern and southern hemisphere is not only evident in the amplitude of the planetary waves, but also in the comparison between $\overline{ZW}$ and QS. Specially for wave-numbers 2 and 3, $\overline{ZW}$ and QS fields are very similar in the north but they have significant differences in the south. 

## Stationarity

Another important consequence of the distinction between $\overline{ZW}$ and QS is that the quotient between the two can be used as a measure of stationarity. As an analogy with the constancy of the wind (@Singer1967), planetary wave stationarity can be estimated as

\begin{linenomath*}
\begin{equation}\label{eq:S}
\hat{S} =  \frac{QS}{\overline{ZW}}
\end{equation}
\end{linenomath*}

It can be shown that $\hat{S} = 1$ for completely stationary waves and that $E(\hat{S}) = n^{-1/2}$ for completely non-stationary waves (where $n$ is the sample size).

```{r stationarity, fig.cap = glue("Seasonal cycle of stationarity of the 300hPa geopotential QS2 computed using Equation \\ref{{eq:S}} (shaded) and $\\overline{{ZW2}}$ (contours). {period_cap}."), fig.width=4, fig.align="center"}
qs[k == 2] %>% 
   .[, S := 2/pi*asin(QS/ZW)] %>% 
   periodic(month = 1:13) %>% 
   ggplot(aes(month, lat)) +
   geom_contour_fill(aes(z = S), binwidth = 0.2) +
   geom_contour_tanaka(aes(z = ZW), binwidth = 20) +
   # geom_text_contour(aes(z = S), binwidth = 0.2, rotate = F, skip = 1,
   #                   stroke = 0.2, size = 2) +
   scale_y_latitude(limits = pm(90)) +
   scale_x_continuous("Month", breaks = 1:13, labels = c(month.abb, "13" = "Jan"),
                      expand = c(0, 0)) +
   scale_fill_viridis_c(guide = guide_colorstrip(barwidth = unit(.5, "lines")),
                        breaks = MakeBreaks(0.2)) +
   # coord_fixed(1/25) +
   theme(aspect.ratio = 0.5) +
   theme(legend.position = "right")
```

As an example, Figure \ref{fig:stationarity} shows $\hat{S}$ for QS2 computed using Equation \ref{eq:S}. The southern hemisphere clearly shows a lower degree of QS2 stationarity than the northern hemisphere or the tropics. In the northern mid latitudes there is a seasonal cycle of stationarity that follows the seasonal cycle of $\overline{ZW}$ (Figure \ref{fig:hurrell}). In the southern hemisphere, instead, the June maximum of $\overline{ZW}$ at 60\degree S coincides with a minimum of stationarity. 

While $\hat{S}$ is used --sometimes with a $\arcsin$ transformation (@Singer1967)-- in the meteorological literature in the context of wind steadiness, to our knowledge this is the first time it has been applied to the study of atmospheric waves. Furthermore, its statistical properties are not well studied. For example, it can be seen that the estimation of $\hat{S}$ from a finite sample has a positive bias that is inversely proportional to the population stationarity, but its convergence properties are not explored.

## QS activity 

Defining quasi-stationary waves as a climatological property of a set of atmospheric fields, precludes, in principle, the possibility of quantifying a QS metric that applies to instantaneous fields. It would seem impossible to, for example, construct an time series of QS activity that could be use as a basis for correlations with other variables, compositions or for use in other methodologies. But there are ways of solving this issue.

One possibility is recognising that individual fields can be characterised by their degree of similarity with the climatological QS. The index produced by @Raphael2004 for the QS3 is an example. While not expressly a measure of similarity, it is sensitive to wave 3 patterns with phase close to the stationary phase. @Yuan2008 use Principal Component Analysis on the meridional wind field; the spatial pattern of the leading mode is very similar to the QS3 and so a time series can be obtained by projecting each instantaneous field to it. 

Another way of constructing a time series is to exploit the fact the timescale dependence of QS. By applying a running mean with a suitable window before computing wave amplitudes, one obtains the QS wave amplitude of that window. This is the methodology applied by @Wolf2018 who performed a 15 day low pass filter before computing wave envelopes. Each data time represents, then, the mean field of a set of fields inside the 15 day window an thus waves computed from them are actually QS waves for each of those sets. (*xx no estoy seguro que se entienda bien xx*)

# Conclusions

The fact that zonal waves (ZW) and quasi-stationary waves (QS) are two distinct but related phenomena has both practical and theoretical implications. First, it underscores the importance of 

Researchers should be aware of which phenomena they want to study and use the appropriate methods. The mean amplitude of the ZW could be appropireate to study the vertical propagation of Rossby waves, for example. But ZW amplitude could lead to misleading results if used as the basis of local impacts studies because they are probably more influenced by phase effects. For clarity and reproducibility, we encourage researchers in the field to describe if they are using the mean amplitude of the individual waves or the amplitude of the mean wave. 

Comparison between results should also be made having this issues in mind. For example, @Irving2015 compare their planetary wave activity index with @Raphael2004's wave 3 index and conclude that the later cannot account for events with waves far removed from their climatological position. However, if we understand it as an index of QS3 similitude, then it is a feature, not a bug. 

Since planetary waves are generally more stationary in the northern hemisphere, these issues are more critical in studies of the southern hemisphere. 

Besides those direct implications, separating ZW and QS can lead to novel levels of analysis. Here, we showed a simple metric of the stationarity, but others applications are also possible. For example, @Smith2012 showed that linear interference between the QS1 and ZW1 was related to vertical wave activity transport at the troposphere. 