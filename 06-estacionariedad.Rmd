---
title: "Estacionariedad"
author: "Elio"
date: "July 20, 2018"
output: 
   pdf_document
   
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      cache = TRUE,
                      warning = FALSE, message = FALSE,
                      out.extra = "", 
                      cache.path = "cache/estacionariedad/",
                      fig.path = "fig/estacionariedad/")

library(metR)
library(data.table)
library(ggplot2)
library(metR)
library(magrittr)
library(circular)
library(RcppRoll)

source("scripts/helperfun.R")

data.world <- BuildMap(res = 1, smooth = 1)
map.world <- geom_map2(data.world)
map.SH <- geom_map2(data.world[lat %b% c(-90, 20)], color = "gray20")


theme_elio <- theme_minimal(base_size = 11) +
   theme(
      # text = element_text(family = font_rc),
      legend.position = "bottom", legend.box = "vertical",
      panel.spacing.y = unit(5, "mm"),
      panel.spacing.x = unit(5, "mm"),
      legend.spacing = unit(2, "mm"),
      plot.margin = grid::unit(rep(3, 4), "mm"),
      legend.title = element_blank(),
      legend.box.spacing = unit(3, "mm"),
      legend.margin = margin(t = -5),
      panel.grid = element_line(color = "gray50", size = 0.2, linetype = 3),
      panel.ontop = TRUE)
theme_set(theme_elio)
guide_colorstrip_bottom <- function(width = 25, height = 0.5, ...) {
   guide_colorstrip(title.position = "top", title.hjust = 0.5,
                    barheight = height,
                    barwidth = width, ...)
}

```

```{r read-data}
ncep <- ReadNetCDF("DATA/NCEP Reanalysis/hgt.mon.mean.nc", c(gh = "hgt"), 
                   subset = list(lat = -90:0, time= lubridate::as_datetime(c("1979-12-01",
                                                                           "2015-12-01"))))
setnames(ncep, "level", "lev")
```

# Concepto básico

Antes de poder tener una medida de la *estacionariedad* de un conjunto de ondas tengo que entender qué quiero decir con ondas estacionarias. 

Primero, la estacionariedad no es una propiedad de una onda sino de un conjunto de ondas. Para ser más preciso, la estacionariedad es la propiedad de la *población* de ondas generadas a partir de un proceso (físico o estadíco) y lo que se busca es estimarla a partir de las propieda des de una *muestra* de ondas. 

Segundo, un conjunto de ondas perfectamente estacionario tiene fase constante, mientras que la amplitud puede variar como quiera. Es decir, la estacionariedad es describe la variabilidad en la localización de máximos y mínimos pero no su intensidad. Sin embargo, esta propiedad no sirve para definir estacionariedad de forma continua (estacionariedad en mayor o menor grado). Una onda con una fase completamente aleatoria pero con amplitud mayor cuando se da en una fase preferencial (fase estacionaria) *es* estacionaria. De ahí que en estacionariedad no sólo está involucrada la distribución de la fase sino también la relación entre ésta y la amplitud.

La estacionariedad, entonces, involucra dos efectos: la distribución de la fase (estacionariedad de fase) y la relación entre la amplitud y la fase (estacionariedad de amplitud). Un conjunto de ondas puede ser estacionario por tener la mayoría de sus elementos con fase similar a la fase estacionaria y una amplitud constante o aleatoria, o puede serlo teniendo una fase aleatoria pero una mayor amplitud cuando la fase está cerca de la fase estacionaria. El primer efecto se puede observar en la distribución de densidad de la fase mientras que el segundo se aprecia en la amplitud media en función de la fase.  

```{r calc-density}
qs <- ncep[, FitWave(gh, 3), by = .(lat, time, lev)] 
qs[, phase.c := circular(phase*3, modulo = "2pi")]
lats <- c(-55, -10)
qs.density <- qs[lat != -90 & lev == 200,
                 density(phase*3*180/pi, weights = amplitude/sum(amplitude),
                         from = 0, to = 360)[c("x", "y")],
                 by = lat]
mean.phases <- qs[lat %in% lats & lev == 200,
                 .(mean.phase = mean.wave(amplitude, phase, k)$phase*180/pi*3),
                 by = lat]
# qs.density <- qs[lat != -90, 
#                  density(phase.c, bw = 7)[c("x", "y")], 
#                  by = lat] 
```

```{r densities, fig.cap = "Estimated density of wave 3 phase weighted by amplitude in 55°s (red) and 10°S (blue) at 200hPa. Vertical lines show the stationary phase, which is identical to the mean phase weighet by amplitude.", fig.height=3}
ggplot(qs.density[lat %in% c(-10, -55)], 
       aes(x, y, color = factor(lat))) + 
   geom_line() +
   geom_vline(aes(xintercept = mean.phase, color = factor(lat)),
              data = mean.phases, linetype = 2) +
   # geom_rug(data = mean.phase, aes(x = mean.phase, y = 0)) +
   scale_y_continuous("Density") +
   scale_x_continuous("Phase", seq(0, 360, by = 60),
                      label = AddSuffix("°")) +
   scale_color_brewer("Latitude", palette = "Set1",
                      label = LatLabel) +
   theme(legend.title = element_text())
```

Una forma de combinar ambos efectos y visualizar la estacionariedad es la distribución de la fase pesada por la amplitud. Esto se ve en la Figura \ref{fig:densities} que muestra la distribución de probabilidad de la fase pesada por la amplitud para dos latitudes distintas. Queda claro que la onda 3 es más estacionaria en 10°S que en 55°S. En este caso tanto la estacionariedad de fase como la de amplitud es mayor en 10°S que en 55°S.

Notar que en estos casos las distriuciones son claramente unimodales. En el caso de ser multimodal, se podría definir la estacionariedad con respecto a cada moda. En cualquier caso, queda claro que la estacionariedad se define con refernecia a una determinada fase estacionaria. Las líneas verticales marcan la fase de la onda promedio para cada latitud (que es idéntica a la media de la fase pesado por la amplitud) que es la fase estacionaria considerada. Se puede observar que este valor no coincide exactamente con la moda de la distribución. 

# Posibles medidas

## Varianza de la fase

Una forma intuitiva de medir la estacionariedad podría ser la variabilidad en la fase con respecto a la fase estacionaria. Una onda perfectamente estacionaria debería tener nula variabilidad en la fase mientras que una onda totalmente "antiestacionaria" tendría una varianza igual a la de una distribución uniforme entre $0$ y $2\pi$ ($(2\pi)^2/12 \sim 3.29$).

De la discusión anterior se desprende que esta medida puede representar la estacionariedad de fase, pero no la estacionariedad de amplitud.

## Correlación entre fase y amplitud

Para capturar la estacionariedad de amplitud podría considerarse la correlación entre la amplitud de las ondas y el corrimiento de fase con respecto a la fase estacionaria. Cuanto más negativa, más estacionaria. 

El problema es que esta medida no represetna la estacionariedad de fase. Además no queda claro cómo interpretar las correlaciones positivas. 

## Varianza de la fase pesada por la amplitud

Una forma de combinar ambos tipos de estacionariedad es calcular la varianza de la fase pero pesarla por la magnitud de la amplitud (AVAR). Ondas que se alejan mucho de la fase estacionaria pero tienen poca amplitud contriburían poco a esta medida, capturando el efecto de estacionariedad de amplitud. Esta medida equivale a la varianza de la función de densidad pesada por la amplitud (Figura \ref{fig:densities}).

Un detalle a tener en cuenta es que la fase es una variable circular con período $2\pi$, lo que significa que $0 - 2\pi = 0$ y así es como hay que interpretar las distancias. Una forma de calcular esta distancia correctamente es definir la resta como el arcoseno del coseno de la resta. 

AVAR se define, entonces como

$$
\mathrm{AVAR} =\frac{1}{N'} \sum_{i = 1}^{N'} \frac{A_i}{A_e}\cos^{-1}  \left[ \cos \left( \overline{\phi} - \phi_i \right) \right]^2
$$

donde $N'$ es la cantidad de elementos con $A_i \ne 0$, $A_i$ y $\phi_i$ son la amplitud y la fase de la *i*ésima onda, $A_e = \sum_{i = 1}^{N'}A_i$ es la sumatoria de las amplitudes (que equivale a la amplitud de la suma de ondas en el caso 100% estacionario) y $\overline{\phi}$ es la fase estacionaria (entendida como al fase de la onda media).


## AMOMA

Otra forma de pensar en la estacionariedad de las ondas es considerando el efecto de la interferencia destructiva. En un conjunto de ondas estacinario, la suma de las ondas es siempre constructiva, mientras que en uno no estacionario, hay la misma cantidad de interferencia constructiva y destructiva. Una forma de medir este efecto es comparando la amplitud de la onda media (AM) que sufre el efecto de la interferencia destructiva y la media de la amplitud de las ondas (MA), que no tiene en cuenta éste efecto.

Intuitivamente, la amplitud de la onda media debería ser 0 para un grupo de ondas no estacionarias e igual a la amplitud media en un grupo de ondas perfectamente estacionarias. De modo que *AMMOMA* (AM over MA) tomaría valores entre 0 y 1 indicando el nivel de estacionariedad del conjunto de ondas. 

Formalizando matemáticamente, si la amplitud de una onda $w_i$ es $A(w_i)$, se tiene que 

$$
\begin{aligned}
\mathrm{AM} &=& A(\overline{w_i}) &=& A \left ( \frac{1}{N}\sum_{i=1}^{N}w_i\right) \\
\mathrm{MA} &=& \overline{A(w_i)} &=& \frac{1}{N}\sum_{i=1}^{N}A(w_i) 
\end{aligned}
$$

La segunda expresión no tiene demasiada complicación, pero la primera hay que desarrollarla. 

Suponiendo el caso $N = 2$, se tiene que 

$$
w_1  = A_1\cos(k(\phi - \alpha_1)) \quad
w_2 = A_2\cos(k(\phi - \alpha_2)) 
$$

La suma de las ondas será una tecer onda con igual período pero distinta amplitud y fase. [Se puede demostrar](http://scipp.ucsc.edu/~haber/ph5B/addsine.pdf) que la amplitud $A_3$ de dicha suma es 

$$A(w_1 + w_2) = A_3 = \sqrt{A_1^2 + A_2^2 + 2A_1A_2\cos(\alpha_1 - \alpha_2)}$$

En el caso de ondas perfectamente estacionarias se tiene que $\alpha_1 = \alpha_2 = \alpha_i = \alpha_0$ (o equivalentemente, $\alpha_i \ne \alpha_0 \rightarrow  A_i = 0$) de manera que $A_3 = A_1 + A_2$ y generalizando a la suma en $N$, se llega a que

$$
\begin{aligned}
A \left ( \frac{1}{N}\sum_{i=1}^{N}w_i\right)  &=  \frac{1}{N}\sum_{i=1}^{N}A(w_i) \\
\mathrm{AM}& = \mathrm{MA}
\end{aligned}
$$

Es decir, para ondas perfectamente estacionarias, $AM/MA = 1$. 

Para ondas no estacionarias... todavía no encontré el formalismo de matemática pura, pero se puede ver "empíricamente". Para distintos valores de $N$, calculo la amplitud de la suma de $N$ ondas con amplitud constante (2, en este caso) y fase aleatoria ($\alpha \sim U(0, 2\pi)$). Repito eso 1000 veces y calculo el promedio. Esto me da una estimación de la esperanza matemática de AM para distintos tamaños muestrales.

```{r calc-sim, include=FALSE}
amplsum <- function(N = 2, A = 2) {
   amplitudes <- rep(A, N)
   phases <-  runif(N, -pi, pi)
   sum.wave(amplitudes, phases)$amplitude
}

B <- 1000
trials <- data.table(t = seq(2, 500, by = 10))
set.seed(42)
trials[, ampl := mean(sapply(1:B, function(x) amplsum(t))), by = t]
               
trials[, mean := ampl/t] 
trials[, mean(mean*sqrt(t), na.rm = TRUE)] -> k
```

```{r sim, echo=FALSE, fig.cap=" Amplitud del promedio de N ondas con amplitud = 2. La línea roja es la línea $y = \\sqrt{\\frac{\\pi}{x}}$.", out.extra = "", fig.height=3}
ggplot(trials, aes(t, mean)) +
   geom_line(size = 1.3) +
   stat_function(fun = function(x) 1/2*2*sqrt(pi/x), color = "red") +
   scale_y_continuous("Amplitud") +
   scale_x_continuous("N") 
```

Se puede ver en la Figura \ref{fig:sim} que $\lim_{N\rightarrow \infty} \mathrm{AM}= 0$ y que va como $\sim N^{-1/2}$ aunque con una constante multiplicativa que en este caso es $k = `r round(k, 3)`$. La parte más empírica y sucia viene ahora, porque *jugando* con este y otros casos, parece ser que que esa contante es $k = \frac{A}{2}\sqrt{\frac{\pi}{N}}$. De manera que, *empíricamente* se puede ver que en el caso de ondas con fase totalmente aleatorias 

$$
\mathrm{AM} = \mathrm{MA} \frac{1}{2}\sqrt{\frac{\pi}{N}}
$$

Poniendo todo en limpio, se demostró (con una mezcla de teoría y práctica), que si se define $\mathrm{AMOMA} = \frac{\mathrm{AM}}{\mathrm{MA}}$ como medida de estacionariedad, se tiene que 

$$
\frac{1}{2}\sqrt{\frac{\pi}{N}} \le \mathrm{AMOMA} \le 1
$$

y que las igualdades izquierda y derecha valen para el caso de pura inestacionariedad y pura estacionariedad respectivamente. 

Se puede llegar a otra forma de expresar AMOMA que clarifica su significado. Sea 

$$
\mathrm{\overline{A}}^2 + \mathrm{A}_i^2 + 2\mathrm{\overline{A}}\mathrm{A}_i\cos\left (\overline{\phi} - \phi_i \right ) = \mathrm{\tilde{A}}_i^2 
$$

Donde $\mathrm{\overline{A}}$ es la amplitud de la onda media, $\mathrm{A}_i$ es la amplitud de la *i*ésima onda, $\overline{\phi}$ es la fase de la onda media, $\phi_i$ es la fase de la onda *i*ésima y $\mathrm{\tilde{A}}_i$ es la amplitud resultante de la suma de onda media y la *i*ésima onda. 

Reordenando y dividiendo por $A_e$ se obtiene

$$
\frac{\mathrm{A}_i}{\mathrm{A}_e}\cos\left (\overline{\phi} - \phi_i \right ) = \frac{\mathrm{\tilde{A}}_i^2 - \left( \mathrm{\overline{A}}^2+\mathrm{A}_i^2 \right)}{2\mathrm{\overline{A}}\mathrm{A}_e}
$$

Haciendo la suma en $i$ y dividiendo por $N'$ se obtiene

$$
\frac{1}{N'}\sum_{i=1}^{N'}\frac{\mathrm{A}_i}{\mathrm{A}_e}\cos\left (\overline{\phi} - \phi_i \right ) = 
\sum_{i=1}^{N'}\frac{\mathrm{\tilde{A}}_i^2 - \mathrm{\tilde{A}}_{ie}^2  }{2N'\mathrm{\overline{A}}\mathrm{A}_e}
$$

Donde además se escribió $\mathrm{\tilde{A}}_{ie}^2 =  \mathrm{\overline{A}}^2+\mathrm{A}_i^2$, que es el cuadrado de la amplitud de la suma entre la onda *i*ésima y la onda media si ésta fuera perfectmaente estacionaria. 

Teniendo en cuenta que $\rho_{w_i} = \cos(\overline{\phi}- \phi_i)$ es la correlación entre la onda media y la *i*ésima onda ([demostración](https://www.johndcook.com/blog/2016/03/06/correlating-two-sine-waves/)), la expresión de la izquierda es el promedio pesado de la correlación entre las ondas y la onda media. Este valor es igual a AMOMA (demostración pendiente, pero se vio numéricamente).

La expresión de la derecha es la sumatoria de la diferencia entre el cuadrado de la suma de la amplitud y la suma de la ampitud en el caso estacionario, normalizada por el producto de la amplitud de la suma estacionaria y la amplitud media (hay un factor $1/2$ que no es muy relevante). 

De esto surge que AMOMA es proporcional a la suma de las diferencias entre amplitudes reales y las amplitudes que se obtendrían en el caso perfectamente estacionario. 

Como nota metodológica, es computacionalmente más eficiente y además más exacto computar AMOMA como el promedio pesado del coseno de la diferencia de fase que como la amplitud de la onda promedio sobre el promedio del a amplitud. 

Comparando ambas medidas, se puede notar su similaridad

$$
\begin{aligned}
\mathrm{AMOMA} &= \frac{1}{N'}\sum_{i=1}^{N'}\frac{\mathrm{A}_i}{\mathrm{A}_e}\cos\left (\overline{\phi} - \phi_i \right ) \\
\mathrm{AVAR} &=\frac{1}{N'} \sum_{i = 1}^{N'} \frac{A_i}{A_e}\cos^{-1}  \left[ \cos \left( \overline{\phi} - \phi_i \right) \right]^2
\end{aligned}
$$
 
Ambos son el promedio pesado de una distancia entre la fase y la fase estacionaria. Pero ésta se define de manera distinta.
 
# Algunos resultados

## Campos espaciales

```{r calc-avar}
qs[, phase.stat := mean.wave(amplitude, phase, k)$phase, by = .(lat, lev, season(time))]
qs[, phase.stat.c := circular(phase.stat*3, modulo = "2pi")]

avar <- qs[amplitude != 0, 
           .(avar = (mean(amplitude/sum(amplitude)*acos(cos(3*(phase - phase.stat)))^2))),
           by = .(lat, lev, season(time))]
```

```{r calc-amoma}
meanfun <- function(x, group, fun, ...) {
   dt <- data.table(x, group)
   dt[, group2 := seq_len(.N), by = group]
   
   mf <- dt[, .(f = fun(x, ...)), by = group][, .(mf = mean(f, na.rm = TRUE))]$mf
   fm <- dt[, .(m = mean(x, na.rm = TRUE)), by = group2][, .(fm = fun(m, ...))]$fm
   
   return(list(mean.fun = mf, fun.mean = fm))
}

amoma <- ncep[ , meanfun(gh, time, function(x) FitWave(x, 3)$amplitude),
                by = .(lat, lev, season(time))] %>% 
   .[, amoma := fun.mean/mean.fun]
```

```{r amoma-avar, fig.cap = "Relationship between AVAR and AMOMA.", fig.height=3}
avar[amoma, on = c("lat", "lev", "season")] %>% 
   ggplot(aes(amoma, avar)) +
   geom_point(size = 0.5, alpha = 0.2) +
   scale_x_continuous("AMOMA") +
   scale_y_continuous("AVAR") 
```



```{r amoma-avar-field, fig.cap = "AMOMA (shaded) and AVAR (contours)", fig.height=4}
ggplot(amoma, aes(lat, lev)) +
   geom_contour_fill(aes(z = amoma)) +
   geom_contour_tanaka(aes(z = avar), data = avar) +
   scale_x_latitude(trans = "reverse")+
   scale_fill_viridis_c() +
   scale_y_level() +
   facet_wrap(~season)
```

La comparación ente AMOMA y AVAR (Figuras \ref{fig:amoma-avar} y \ref{fig:amoma-avar-field}) muestran que hay un excelente acuerdo entre ambas medidas. 

Curiosamente, con 108 meses el mínimo valor de AMOMA debería ser $\sim `r round(1/2*sqrt(pi/108), 3)`$, sin embargo en los datos es `r round(amoma[, min(amoma, na.rm = TRUE)], 3)`, indicando que algo falla con mi "demostración" empírica de la cota inferior.

## Evolución temporal 

La estacionariedad no puede estar definida para un mes en particular sino que sólo se define con respecto a una fase estacionaria que debe ser calculada para un determinado intervalo de tiempo. Lo más directo es usar todo el período, pero si interesa saber el nivel de estacionariedad en una década determinada, por ejemplo, se debe usar la fase estacionaria de esa década. Más aún, la fase estacionaria en realidad debe calcularse *para cada mes* por separado de manera de eliminar la influencia del ciclo anual. 

```{r calc-ts}
w <- 12*5 + 1 


mean.phase.wave <- function(wave) {
   wave <- transpose(wave)
   names(wave) <- c("amplitude", "phase", "k")
   with(wave, mean.phase(amplitude, phase, k))
}


qs <- qs[, wave :=  as.wave(amplitude, phase, k)] %>% 
   .[, phi.s := listapply(wave, 5, mean.phase.wave),
                       by = .(lat, lev, month(time))]

S <- copy(qs)[, wave := as.wave(amplitude, phase, k, phi.s)]

S <- S[, amoma := listapply(wave, w, stationarity.wave2), 
        by = .(lat, lev)] %>% 
   .[, avar := listapply(wave, w, stationarity.wave2, method = "avar"),
     by = .(lat, lev)] %>%
   .[, .(lat, lev, time, amoma, avar)] %>% 
   melt(id.vars = c("time", "lat", "lev"), variable.name = "method") %>% 
   .[!is.na(value)]
```


```{r ts, fig.cap = "Stationarity as meassured by AMOMA and AVAR at 55°S and 200hPa. Background rectangles mark El Niño and La Niña events and their intensities."}
S[lat == -55 & lev == 200] %>%
ggplot(aes(time, value)) +
   # geom_ribbon(aes(x = time, ymin = -Inf, ymax = Inf, fill = event,
   #                 group = id, alpha = intensity), inherit.aes = FALSE,
   #             data = enso[event != "Neutral" & l > 5 & time <= max(S[, time])]) +
   geom_line()  +
   # geom_line(aes(y = avar)) +
   geom_smooth(method = "lm", color = "black") +
   scale_y_continuous("Stationarity")  +
   scale_alpha(guide = "none") +
   scale_fill_manual(values = c(Niña = "blue", Niño = "red")) +
   facet_wrap(~method, scales = "free_y", ncol = 1)
```

La Figura \ref{fig:ts} muestra la serie temporal de estacionariedad según los dos métodos en 55°S y 200hPa con una ventana móvil de 5 años. Es notorio que ambas variables coinciden en gran medida (recordar que un valor mayor de AVAR implica una menor estacionariedad). Una tendencia a la baja con mínimos locales en los 90, mediados de 2010 y máximo a principios de los 2000. 

Una forma alternativa --aunque conceptualmente equivalente-- es la de calcular la correlación entre la onda 

```{r cor-smooth, fig.cap = "Correlation between monthly wave and a running mean wave with windows of 5 years (gray line), loess fit weigthed by wave amplitude (black line). AMOMA computed with a 5 year running window."}
qs[, rho := cos(3*(phase - phi.s))]

ggplot(qs[lev == 200 & lat == -55], aes(time, rho)) +
   geom_line(color = "gray") +
   geom_smooth(aes(weight = amplitude), span = 0.5, color = "black", 
               size = 0.7) +
   geom_line(aes(y = value), data = S[lev == 200 & lat == -55 & method == "amoma"], 
             color = "red") +
   coord_cartesian(ylim = c(0, 1))
```


```{r}
S[lev == 200 & method == "amoma"] %>%
ggplot(aes(lat, time)) +
   # geom_contour_fill(aes(z = amoma), data = qs[lev == 200]) +
   geom_contour_fill(aes(z = value)) +
   scale_x_latitude(trans = "reverse") +
   scale_fill_viridis_c() 
```


```{r amoma-trends, fig.cap = "Decadal trend in AMOMA (shaded) and AMOMA value for the whole period (contours).", fig.height=5}
regr.S <- S[, FitLm(value, time = 1:.N),
     by = .(lat, lev, method)]

regr.S[method == "avar", estimate := estimate*10]
ggplot(regr.S[term == "time"], aes(lat, lev)) +
   geom_contour_fill(aes(z = estimate*12*10)) +
   geom_contour_tanaka(data = qs[, stationarity.wave2(wave), by = .(lat, lev)],
                       aes(z = V1)) +
   scale_x_latitude(trans = "reverse")+
   scale_fill_divergent() +
   scale_y_level()  +
   facet_wrap(~method)
```

```{r}
sst <- ReadNetCDF("DATA/sst.nc", vars = "sst")[!is.na(sst)]

sst[, sst.a := Anomaly(sst), by = .(lon, lat, month(time))]

regr.sst <- S[lat == -55 & lev == 700, 
       .(time, value = Detrend(value), method)] %>% 
   .[sst, on = c("time"), allow.cartesian = TRUE] %>% 
   .[!is.na(value), FitLm(sst.a, value, se = TRUE), 
     by = .(lon, lat, method)]
```

```{r}
regr.gh <- S[lat == -50 & lev == 200, .(time, value = Detrend(value), method)] %>% 
   ncep[lev == 200][., on = c("time"), allow.cartesian = TRUE] %>% 
   .[, gh.z := Anomaly(gh), by = .(lat, time)] %>% 
   .[, FitLm(gh.z, value = value, se = TRUE), 
     by = .(lat, lon, method)]

regr.gh[term == "value"] %>% 
ggplot(aes(lon, lat)) +
   geom_raster(aes(fill = estimate), data = regr.sst[term == "value"]) + 
   geom_contour2(aes(z = estimate, linetype = factor(-sign(stat(level)))), 
                 breaks = AnchorBreaks(0, 20, 0), size = 0.2) +
   # geom_raster(aes(fill = estimate)) +
   map.SH +
   scale_y_latitude(limits = c(-90, 15)) +
   scale_x_longitude() +
   scale_linetype(guide = "none") +
   scale_fill_divergent(breaks = AnchorBreaks(0, 5, 0)) +
   coord_quickmap() +
   facet_wrap(~method, labeller = labeller(month.abb))
```



