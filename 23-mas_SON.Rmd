---
title: "SON"
author: "Elio Campitelli"
output: 
   # pdf_document:
   #    latex_engine: xelatex
   powerpoint_presentation:
   # ioslides_presentation:
   fig_height: 7.6
fig_width: 12.8
reference_doc: template.pptx
urlcolor: blue
header_includes:
   - \usepackage[utf8]{inputenc}
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(metR)
library(data.table)
library(ggplot2)
library(magrittr)
library(patchwork)
library(here)

here <- here::here


source(here("scripts", "facet_nested.R"))
source(here("scripts", "helperfun.R"))
source(here("scripts", "data_locations.R"))
knitr_set_timer()
knitr_set_cache()
```

```{r}
mean_season <- function(data) {
   data %>% 
      .[is.full_season(time)] %>%  
      .[, lapply(.SD, mean), by = .(lon, lat, time = seasonaly(time))]   
}

```


```{r}
datos <- ReadNetCDF(ERA5(), vars = c(hgt = "z", "u", "v", vort = "vo", air = "t"),
                    subset = list(level = list(200, 500, 925, 50),
                                  latitude = c(-90:10))) %>% 
   na.omit() %>% 
   normalise_coords() %>% 
   # .[season(time) == "SON"] %>% 
   .[, mean_season(.SD), by = lev]

cmap <- ReadNetCDF(CMAP(), vars = c(pp = "precip"), 
                   subset = list(lat = -90:10)) %>% 
   normalise_coords() %>%
   # .[season(time) == "SON"] %>% 
   mean_season()
   
olr <- ReadNetCDF(OLR(), vars = "olr", 
                  subset = list(lat = -90:10)) %>% 
   normalise_coords() %>%
   # .[season(time) == "SON"] %>% 
   mean_season()
```

```{r}

ks <- function(vorticity_gradient, u, lat) {
   sqrt(vorticity_gradient/u)*(metR:::a*cos(lat*pi/180))
}

datos[, vort.dlat := Derivate(vort ~ lon + lat, cyclical = TRUE, sphere = TRUE)[[2]], 
      by = .(time, lev)] %>% 
   .[, U := mean(u), by = .(lat, lev, time)] %>% 
   .[, ks := ks(vort.dlat + f.dy(lat), U, lat)] %>% 
   .[, vt := Anomaly(v)*Anomaly(air)/abs(f(lat)), by = .(lat, lev, time)]
```




```{r}
divide_eof <- function(eof, which = c("left", "right", "sd")){
   setNames(lapply(which, function(x) eof[x]), which)
}

unnest_eof <- function(dt, col, which) {
   colstr <- deparse(substitute(col))
   cols <- colnames(dt)[!(colnames(dt) %in% colstr)]
   # browser()
   expr <- quote(
      dt[, col[[1]][[which]], by = c(cols)]
   )
   expr  <-  do.call(substitute, list(expr, 
                                      list(col = substitute(col))))
   eval(expr)
}
```


```{r}
ceofs <- datos %>% 
   .[lev %in% c(200, 50)] %>% 
   .[, season := season(time)] %>% 
   .[, .(ceof = list(compute_ceof(.SD))), by = .(season)]
```


<!-- ```{r} -->
<!-- datos_long <- regr <- ceofs %>%  -->
<!--    unnest_eof(ceof, "left") %>%  -->
<!--    .[, season := NULL] %>% -->
<!--    setnames("hgt", "EOF") %>%  -->
<!--    .[datos %>%  -->
<!--         melt(id.vars = c("lon", "lat", "lev", "time")),  -->
<!--      on = "time", allow.cartesian = TRUE] %>%  -->
<!--    sep_ReIm(EOF) -->
<!-- ``` -->

## vt


```{r}
datos_join <- ceofs %>% 
   unnest_eof(ceof, "left") %>% 
   setnames("hgt", "EOF") %>% 
   sep_ReIm(EOF) %>% 
   .[datos, on = .NATURAL, allow.cartesian = TRUE] 
```


```{r}
datos_join %>% 
   .[lat <= -10 & lat != -90] %>% 
   .[, FitLm(EOF, vt, se = TRUE), by = .(lon, lat, lev, part, PC, season)] %>% 
   rm_intercept() %>% 
   .[, p.val := Pvaluate(estimate, std.error, df), by = .(part, season, PC, lev)] %>% 
   # .[lev == 200] %>% 
   na.omit() %>% 
   ggplot(aes(lon, lat)) +
   geom_contour_fill(aes(z = estimate), bins = 20) +
   # geom_raster(aes(fill = estimate)) +
   stat_subset(aes(subset = p.val < 0.01 & is.cross(lon, lat)), size = 0.1) +
   geom_map2(lat <= 10) +
   scale_fill_divergent() +
   scale_x_longitude() +
   scale_y_latitude() +
   coord_quickmap() +
   facet_nested(lev ~ part + PC)
```



```{r}

ceofs %>% 
   unnest_eof(ceof, "left") %>% 
   sep_ReIm(hgt) %>% 
   .[cmap, on = .NATURAL, allow.cartesian = TRUE] %>% 
   filter_sa() %>% 
   .[, FitLm(hgt, pp, se = TRUE), by = .(lon, lat, part, PC, season)] %>% 
   rm_intercept() %>% 
   .[, p.val := Pvaluate(estimate, std.error, df, "fdr"), by = .(part, season, PC)] %>% 
   na.omit() %>% 
   ggplot(aes(lon, lat)) +
   geom_contour_fill(aes(z = estimate), bins = 20) +
   # geom_raster(aes(fill = estimate)) +
   stat_subset(aes(subset = p.val < 0.05), size = 0.1) +
   geom_map2(is.sa(data), keep = 1) +
   scale_fill_divergent() +
   scale_x_longitude() +
   scale_y_latitude() +
   coord_quickmap() + 
   facet_nested(season ~ PC + part)
```



```{r}

ceofs %>% 
   unnest_eof(ceof, "left") %>% 
   sep_ReIm(hgt) %>% 
   .[olr, on = .NATURAL, allow.cartesian = TRUE] %>% 
   .[, FitLm(hgt, olr, se = TRUE), by = .(lon, lat, part, PC, season)] %>% 
   rm_intercept() %>% 
   .[, p.val := Pvaluate(estimate, std.error, df, "fdr"), by = .(part, season, PC)] %>% 
   na.omit() %>% 
   ggplot(aes(lon, lat)) +
   # geom_contour_fill(aes(z = estimate), bins = 20) +
   geom_raster(aes(fill = estimate)) +
   stat_subset(aes(subset = p.val < 0.05), size = 0.1) +
   geom_map2(lat < 10) +
   scale_fill_divergent() +
   scale_x_longitude() +
   scale_y_latitude() +
   coord_quickmap() + 
   facet_nested(season ~ PC + part)
```


```{r}
regr_air <- datos_long %>% 
   .[variable == "air" & lev == 925] %>% 
   .[, FitLm(EOF, value, se = TRUE), by = .(lon, lat, PC, part, season(time))] %>% 
   rm_intercept()
```

```{r}
regr_air %>% 
   .[, p.val := Pvaluate(estimate, std.error, df, "fdr"), by = .(season, part, PC)] %>% 
   ggplot(aes(lon, lat)) +
   geom_contour_fill(aes(z = estimate)) +
   stat_subset(aes(subset = p.val < 0.05 & is.cross(lon, lat, 1)), 
               size = 0.1, alpha = 0.4) +
   geom_map2(lat <= 10) +
   scale_fill_divergent() +
   scale_x_longitude() +
   scale_y_latitude()
coord_quickmap() +
   facet_nested(part ~ PC)
```






