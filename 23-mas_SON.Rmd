---
title: "SON"
author: "Elio Campitelli"
output: 
   # pdf_document:
   #    latex_engine: xelatex
   powerpoint_presentation:
   # ioslides_presentation:
      fig_height: 7.6
      fig_width: 12.8   
      reference_doc: template.pptx
urlcolor: blue
header_includes:
   - \usepackage[utf8]{inputenc}
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(metR)
library(data.table)
library(ggplot2)
library(magrittr)
library(patchwork)
library(here)

here <- here::here


source(here("scripts", "facet_nested.R"))
source(here("scripts", "helperfun.R"))
source(here("scripts", "data_locations.R"))
knitr_set_timer()
knitr_set_cache(cache.extra  = 43)
```

```{r}
mean_season <- function(data) {
   data %>% 
      .[is.full_season(time)] %>%  
      .[, lapply(.SD, mean), by = .(lon, lat, time = seasonaly(time))]   
}

```


```{r}
datos <- ReadNetCDF(ERA5(), vars = c(hgt = "z", "u", "v", vort = "vo", air = "t"),
                    subset = list(level = list(200, 500, 925, 50),
                                  latitude = c(-90:10))) %>% 
   na.omit() %>% 
   normalise_coords() %>% 
   # .[season(time) == "SON"] %>% 
   .[, mean_season(.SD), by = lev]

cmap <- ReadNetCDF(CMAP(), vars = c(pp = "precip"), 
                   subset = list(lat = -90:10)) %>% 
   normalise_coords() %>%
   # .[season(time) == "SON"] %>% 
   mean_season()

olr <- ReadNetCDF(OLR(), vars = "olr", 
                  subset = list(lat = -90:10)) %>% 
   normalise_coords() %>%
   # .[season(time) == "SON"] %>% 
   mean_season()
```

```{r}

ks <- function(vorticity_gradient, u, lat) {
   vorticity_gradient/u*(metR:::a*cos(lat*pi/180))^2
}

sqrti <- function(x) {
   sqrt(abs(x))*sign(x)
}


datos[, vort.dlat := Derivate(vort ~ lon + lat, cyclical = TRUE, sphere = TRUE)[[2]], 
      by = .(time, lev)] %>% 
   .[, U := mean(u), by = .(lat, lon, lev, season(time))] %>% 
   .[, ks := sqrti(ks(vort.dlat + f.dy(lat), U, lat))] %>% 
   .[, vt := Anomaly(v)*Anomaly(air)*abs(f(lat)), by = .(lat, lev, time)] 
```




```{r}
divide_eof <- function(eof, which = c("left", "right", "sd")){
   setNames(lapply(which, function(x) eof[x]), which)
}

unnest_eof <- function(dt, col, which) {
   colstr <- deparse(substitute(col))
   cols <- colnames(dt)[!(colnames(dt) %in% colstr)]
   # browser()
   expr <- quote(
      dt[, col[[1]][[which]], by = c(cols)]
   )
   expr  <-  do.call(substitute, list(expr, 
                                      list(col = substitute(col))))
   eval(expr)
}
```


```{r}
ceofs <- datos %>% 
   .[lev %in% c(200, 50)] %>% 
   .[, season := season(time)] %>% 
   .[, .(ceof = list(compute_ceof(.SD, temporal = FALSE))), by = .(season)]
```


<!-- ```{r} -->
<!-- datos_long <- regr <- ceofs %>%  -->
<!--    unnest_eof(ceof, "left") %>%  -->
<!--    .[, season := NULL] %>% -->
<!--    setnames("hgt", "EOF") %>%  -->
<!--    .[datos %>%  -->
<!--         melt(id.vars = c("lon", "lat", "lev", "time")),  -->
<!--      on = "time", allow.cartesian = TRUE] %>%  -->
<!--    sep_ReIm(EOF) -->
<!-- ``` -->




```{r}
regress_m <- memoise::memoise(function(ceof, data, variable) {
   regr_by <- c("lon", "lat", "PC", "season")
   pval_by <- c("term", "season", "PC")
   formula <- season ~ PC + term
   if ("lev" %in% colnames(data)) {
      regr_by <- c("lev", regr_by)
      pval_by <- c("lev", pval_by)
      formula <- season + lev ~ PC + term
   }
   
   regr <- ceof %>% 
      unnest_eof(ceof, "left") %>% 
      setnames("hgt", "EOF") %>% 
      sep_ReIm(EOF, FALSE) %>% 
      .[data, on = .NATURAL, allow.cartesian = TRUE] %>% 
      .[, FitLm(get(variable), R, I, se = TRUE), by = c(regr_by)] %>% 
      rm_intercept() %>% 
      .[, p.val := Pvaluate(estimate, std.error, df, "fdr"), by = c(pval_by)] %>% 
      .[]
   
   class(regr) <- c("regression", class(regr))
   attr(regr, "formula") <- formula
   regr
})

regress <- function(ceof, data, variable) {
   variable <- deparse(substitute(variable))
   regress_m(ceof, data, variable)
}

plot.regression <- function(x, ..., keep = 0.015) {
   lats <- range(x$lat)
   lons <- range(x$lon)
   
   ggplot(x, aes(lon, lat)) +
      geom_contour_fill(aes(z = estimate), ...) +
      # geom_raster(aes(fill = estimate)) +
      stat_subset(aes(subset = p.val < 0.05), size = 0.1) +
      geom_map2(keep = keep) +
      scale_fill_divergent() +
      scale_x_longitude(limits = lons) +
      scale_y_latitude(limits = lats) +
      coord_quickmap() + 
      facet_nested(attr(x, "formula", TRUE))
}
```

## PC2

```{r}
this_PC <- "PC2"
```

```{r, fig.cap = "Regresión con v*T*"}
regress(ceofs, datos, vt) %>% 
   .[lev %in% c(50, 200, 500)] %>% 
   .[season %in% c("DJF", "MAM")] %>%
   .[PC == this_PC] %>% 
   plot(bins = 20) +
   facet_nested(season + term ~ PC + lev)
```


```{r, fig.cap = "Regresión con v*T*"}
regress(ceofs, datos, vt) %>% 
   .[lev %in% c(50, 200, 500)] %>% 
   .[!(season %in% c("DJF", "MAM"))] %>% 
   .[PC == this_PC] %>% 
   plot(bins = 20) +
   facet_nested(season + term ~ PC + lev)
```



```{r, fig.cap="Regresión con olr"}
regress(ceofs, olr, olr) %>%
   na.omit() %>% 
   .[PC == this_PC] %>% 
   plot(bins = 20)
```

```{r, fig.cap = "Regresión con temperatura del aire"}
ceofs %>% 
   regress(datos, air) %>% 
   .[lev %in% max(lev)] %>% 
   .[PC == this_PC] %>% 
   plot(bins = 20)
```


```{r}

datos[, hgt_a := Anomaly(hgt), by = .(lon, lat, lev, season(time))] 

mean_ks <- datos[, .(ksm = mean(ks)), by = .(lat, lon, lev, season(time))] 

ks_join <- ceofs %>% 
   unnest_eof(ceof, "left") %>% 
   setnames("hgt", "EOF") %>% 
   sep_ReIm(EOF) %>% 
   .[, EOF := Percentile(EOF), by = .(season, PC, part)] %>% 
   .[, tercil := cut(EOF, c(0, 1/4, 3/4, 1), labels = c("low", "medium", "high"))] %>% 
   .[datos, on = .NATURAL, allow.cartesian = TRUE] %>% 
   .[, .(ks = mean(ks),
         ks_se = sd(ks)/sqrt(.N),
         hgt = mean(hgt_a),
         n = .N), 
     by = .(lat, lon, lev, season, PC, part, tercil)] %>% 
   mean_ks[., on = .NATURAL]
```
```{r}
k_limit <- if (this_PC == "PC2") 3 else 0
```

```{r, fig.cap = paste0("Ks medio para 1 tercil (low) y tercer tercil (high) de PC2. K menor a ", k_limit, " marcado en gris")}
ks_join %>% 
   .[lev == 200] %>% 
   .[PC == this_PC] %>% 
   .[lat <= -10] %>% 
   # .[tercil != "medium"] %>% 
   .[ks <= k_limit, ks := NA] %>%
   .[, ks := floor(ks)] %>% 
   .[, hgt := FilterWave(hgt, -1), by = .(lat, lev, PC, part, tercil, season)] %>% 
   ggplot(aes(lon, lat)) +
   geom_raster(aes(fill = ks)) +
   geom_contour2(aes(z = hgt, linetype = factor(sign(..level..))), size = 0.3) +
   geom_vline(xintercept = 210) +
   geom_map2(lat <= 0) +
   scale_x_longitude() +
   scale_y_latitude() +
   scale_fill_divergent(limits = pm(5), oob = scales::squish, midpoint = 3) +
   coord_quickmap(ylim = c(-85, -10)) +
   facet_nested(season ~ PC + part + tercil)
```

```{r, fig.cap = "Igual que en la figura anterior pero restando el Ks medio climatológico"}
ks_join %>% 
   .[lev == 200] %>% 
   .[PC == this_PC] %>% 
   .[lat <= -10] %>% 
   .[tercil != "medium"] %>%
      ggplot(aes(lon, lat)) +
      geom_raster(aes(fill = ks - ksm)) +
      geom_map2(lat <= 0) +
      geom_vline(xintercept = 210) +
      scale_x_longitude() +
      scale_y_latitude() +
      scale_fill_divergent(limits = pm(2), oob = scales::squish) +
      coord_quickmap(ylim = c(-85, -10)) +
      facet_nested(season ~ PC + part + tercil)
```


```{r, fig.cap = "Igual que en figura anterior pero corte en 120°W"}
ks_join %>% 
   .[lev == 200] %>% 
   .[PC == this_PC] %>% 
   .[lon %~% 210] %>% 
   .[lat <= -30] %>% 
   ggplot(aes(lat, ks)) +
   geom_hline(yintercept = 0) +
   geom_line(aes(y = ksm)) +
   geom_ribbon(aes(ymin = ks - ks_se, ymax = ks + ks_se, fill = tercil), alpha = 0.2) +
   geom_line(aes(color = tercil)) +
   scale_y_continuous(breaks = pm(0:6)) +
   facet_nested(season ~ PC + part) +
   coord_flip()
```



## PC1

```{r}
this_PC <- "PC1"
```

```{r, fig.cap = "Regresión con v*T*"}
regress(ceofs, datos, vt) %>% 
   .[lev %in% c(50, 200, 500)] %>% 
   .[season %in% c("DJF", "MAM")] %>%
   .[PC == this_PC] %>% 
   plot(bins = 20) +
   facet_nested(season + term ~ PC + lev)
```


```{r, fig.cap = "Regresión con v*T*"}
regress(ceofs, datos, vt) %>% 
   .[lev %in% c(50, 200, 500)] %>% 
   .[!(season %in% c("DJF", "MAM"))] %>% 
   .[PC == this_PC] %>% 
   plot(bins = 20) +
   facet_nested(season + term ~ PC + lev)
```



```{r, fig.cap="Regresión con olr"}
regress(ceofs, olr, olr) %>%
   na.omit() %>% 
   .[PC == this_PC] %>% 
   plot(bins = 20)
```

```{r, fig.cap = "Regresión con temperatura del aire"}
ceofs %>% 
   regress(datos, air) %>% 
   .[lev %in% max(lev)] %>% 
   .[PC == this_PC] %>% 
   plot(bins = 20)
```


```{r}

datos[, hgt_a := Anomaly(hgt), by = .(lon, lat, lev, season(time))] 

mean_ks <- datos[, .(ksm = mean(ks)), by = .(lat, lon, lev, season(time))] 

ks_join <- ceofs %>% 
   unnest_eof(ceof, "left") %>% 
   setnames("hgt", "EOF") %>% 
   sep_ReIm(EOF) %>% 
   .[, EOF := Percentile(EOF), by = .(season, PC, part)] %>% 
   .[, tercil := cut(EOF, c(0, 1/4, 3/4, 1), labels = c("low", "medium", "high"))] %>% 
   .[datos, on = .NATURAL, allow.cartesian = TRUE] %>% 
   .[, .(ks = mean(ks),
         ks_se = sd(ks)/sqrt(.N),
         hgt = mean(hgt_a),
         n = .N), 
     by = .(lat, lon, lev, season, PC, part, tercil)] %>% 
   mean_ks[., on = .NATURAL]
```
```{r}
k_limit <- if (this_PC == "PC2") 3 else 0
```

```{r, fig.cap = paste0("Ks medio para 1 tercil (low) y tercer tercil (high) de PC2. K menor a ", k_limit, " marcado en gris")}
ks_join %>% 
   .[lev == 200] %>% 
   .[PC == this_PC] %>% 
   .[lat <= -10] %>% 
   # .[tercil != "medium"] %>% 
   .[ks <= k_limit, ks := NA] %>%
   .[, ks := floor(ks)] %>% 
   .[, hgt := FilterWave(hgt, -1), by = .(lat, lev, PC, part, tercil, season)] %>% 
   ggplot(aes(lon, lat)) +
   geom_raster(aes(fill = ks)) +
   geom_contour2(aes(z = hgt, linetype = factor(sign(..level..))), size = 0.3) +
   geom_vline(xintercept = 210) +
   geom_map2(lat <= 0) +
   scale_x_longitude() +
   scale_y_latitude() +
   scale_fill_divergent(limits = pm(5), oob = scales::squish, midpoint = 3) +
   coord_quickmap(ylim = c(-85, -10)) +
   facet_nested(season ~ PC + part + tercil)
```

```{r, fig.cap = "Igual que en la figura anterior pero restando el Ks medio climatológico"}
ks_join %>% 
   .[lev == 200] %>% 
   .[PC == this_PC] %>% 
   .[lat <= -10] %>% 
   .[tercil != "medium"] %>%
      ggplot(aes(lon, lat)) +
      geom_raster(aes(fill = ks - ksm)) +
      geom_map2(lat <= 0) +
      geom_vline(xintercept = 210) +
      scale_x_longitude() +
      scale_y_latitude() +
      scale_fill_divergent(limits = pm(2), oob = scales::squish) +
      coord_quickmap(ylim = c(-85, -10)) +
      facet_nested(season ~ PC + part + tercil)
```


```{r, fig.cap = "Igual que en figura anterior pero corte en 120°W"}
ks_join %>% 
   .[lev == 200] %>% 
   .[PC == this_PC] %>% 
   .[lon %~% 210] %>% 
   .[lat <= -30] %>% 
   ggplot(aes(lat, ks)) +
   geom_hline(yintercept = 0) +
   geom_line(aes(y = ksm)) +
   geom_ribbon(aes(ymin = ks - ks_se, ymax = ks + ks_se, fill = tercil), alpha = 0.2) +
   geom_line(aes(color = tercil)) +
   scale_y_continuous(breaks = pm(0:6)) +
   facet_nested(season ~ PC + part) +
   coord_flip()
```



# Precipitación

```{r}
cmap_mean <- cmap %>% 
   .[, .(pp = mean(pp)), by = .(lon, lat, season(time))]
```

```{r "Regresión con precipitación en sudamérica"}
lats <- c(-38.75, -23.75)
lons <- ConvertLongitude(c(-63.75, -51.25))


regress(ceofs, filter_sa(cmap), pp) %>%
   # .[PC == "PC2"] %>% 
   plot(keep = 1) +
   annotate("rect", xmin = min(lons), xmax = max(lons), ymin = min(lats), ymax = max(lats),
            fill = NA, color = "black") +
   scale_fill_distiller(palette = "BrBG", direction = 1, limits = pm(25))
```




```{r, fig.cap = "Precipitación media en LPB (caja de la figura anterior) en función de parte real e imaginaria de cada PC."}
cmap[lat %between% lats & lon %between% lons] %>% 
   .[, .(pp = mean(pp)), by = .(time)] %>% 
   .[unnest_eof(ceofs, ceof, "left"), on = .NATURAL, allow.cartesian = TRUE] %>% 
   sep_ReIm(hgt) %>% 
   ggplot(aes(pp, hgt)) +
   geom_point() +
   geom_smooth(method = "lm") +
   facet_nested(season ~ PC + part, scales = "free")
```

```{r, fig.cap = "Series temporales de precipitación en LPB observadas (rojo) y modeladas con modelo lineal (azul). El modelo se ajustó con datos anteriores a 2000. Se muestra la correlación entre las series para los datos posteriores a 2000."}
cmap[lat %between% lats & lon %between% lons] %>% 
   .[, .(pp = mean(pp)), by = .(time)] %>% 
   # .[, pp := scale(pp), by = .(season(time))] %>%
   .[unnest_eof(ceofs, ceof, "left"), on = .NATURAL, allow.cartesian = TRUE] %>% 
   sep_ReIm(hgt, longer = FALSE) %>% 
   .[, model := predict(lm(pp ~ R + I, data = .SD[year(time) < 2000]), newdata = .SD), by = .(season, PC)] %>%
   melt(id.vars = c("time", "season", "PC"), measure.vars = c("pp", "model")) %>% 
   ggplot(aes(time, value)) +
   geom_label(data = function(x) x[year(time) >= 2000] %>% 
                 .[, widyr::pairwise_cor(.SD, variable, time, value, upper = FALSE), by = .(season, PC)],
              aes(label = scales::number(correlation, accuracy = 0.01)), 
              x =  lubridate::make_datetime(year = 2010),
              y = 5) +
   geom_vline(xintercept = lubridate::make_datetime(year = 2000), color = "gray") +
   geom_line(aes(color = variable)) +
   scale_color_brewer("", palette = "Set1", label = c("Obs", "Modelo")) +
   facet_grid(season ~ PC)
```

