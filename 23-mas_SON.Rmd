---
title: "SON"
author: "Elio Campitelli"
output: 
   # pdf_document:
   #    latex_engine: xelatex
   powerpoint_presentation:
   # ioslides_presentation:
   fig_height: 7.6
fig_width: 12.8
reference_doc: template.pptx
urlcolor: blue
header_includes:
   - \usepackage[utf8]{inputenc}
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(metR)
library(data.table)
library(ggplot2)
library(magrittr)
library(patchwork)
library(here)

here <- here::here


source(here("scripts", "facet_nested.R"))
source(here("scripts", "helperfun.R"))
source(here("scripts", "data_locations.R"))
knitr_set_timer()
knitr_set_cache()
```

```{r}
mean_season <- function(data) {
   data %>% 
      .[is.full_season(time)] %>%  
      .[, lapply(.SD, mean), by = .(lon, lat, time = seasonaly(time))]   
}

```


```{r}
datos <- ReadNetCDF(ERA5(), vars = c(hgt = "z", "u", "v", vort = "vo", air = "t"),
                    subset = list(level = list(200, 500, 925, 50),
                                  latitude = c(-90:10))) %>% 
   na.omit() %>% 
   normalise_coords() %>% 
   # .[season(time) == "SON"] %>% 
   .[, mean_season(.SD), by = lev]

cmap <- ReadNetCDF(CMAP(), vars = c(pp = "precip"), 
                   subset = list(lat = -90:10)) %>% 
   normalise_coords() %>%
   # .[season(time) == "SON"] %>% 
   mean_season()

olr <- ReadNetCDF(OLR(), vars = "olr", 
                  subset = list(lat = -90:10)) %>% 
   normalise_coords() %>%
   # .[season(time) == "SON"] %>% 
   mean_season()
```

```{r}

ks <- function(vorticity_gradient, u, lat) {
   sqrt(vorticity_gradient/u)*(metR:::a*cos(lat*pi/180))
}

datos[, vort.dlat := Derivate(vort ~ lon + lat, cyclical = TRUE, sphere = TRUE)[[2]], 
      by = .(time, lev)] %>% 
   .[, U := mean(u), by = .(lat, lev, time)] %>% 
   .[, ks := ks(vort.dlat + f.dy(lat), U, lat)] %>% 
   .[, vt := Anomaly(v)*Anomaly(air)*abs(f(lat)), by = .(lat, lev, time)] 
```




```{r}
divide_eof <- function(eof, which = c("left", "right", "sd")){
   setNames(lapply(which, function(x) eof[x]), which)
}

unnest_eof <- function(dt, col, which) {
   colstr <- deparse(substitute(col))
   cols <- colnames(dt)[!(colnames(dt) %in% colstr)]
   # browser()
   expr <- quote(
      dt[, col[[1]][[which]], by = c(cols)]
   )
   expr  <-  do.call(substitute, list(expr, 
                                      list(col = substitute(col))))
   eval(expr)
}
```


```{r}
ceofs <- datos %>% 
   .[lev %in% c(200, 50)] %>% 
   .[, season := season(time)] %>% 
   .[, .(ceof = list(compute_ceof(.SD, temporal = FALSE))), by = .(season)]
```


<!-- ```{r} -->
<!-- datos_long <- regr <- ceofs %>%  -->
<!--    unnest_eof(ceof, "left") %>%  -->
<!--    .[, season := NULL] %>% -->
<!--    setnames("hgt", "EOF") %>%  -->
<!--    .[datos %>%  -->
<!--         melt(id.vars = c("lon", "lat", "lev", "time")),  -->
<!--      on = "time", allow.cartesian = TRUE] %>%  -->
<!--    sep_ReIm(EOF) -->
<!-- ``` -->

## vt


```{r}
regress_m <- memoise::memoise(function(ceof, data, variable) {
   
   regr_by <- c("lon", "lat", "PC", "season")
   pval_by <- c("term", "season", "PC")
   formula <- season ~ PC + term
   if ("lev" %in% colnames(data)) {
      regr_by <- c("lev", regr_by)
      pval_by <- c("lev", pval_by)
      formula <- season + lev ~ PC + term
   }
   
   regr <- ceof %>% 
      unnest_eof(ceof, "left") %>% 
      setnames("hgt", "EOF") %>% 
      sep_ReIm(EOF, FALSE) %>% 
      .[data, on = .NATURAL, allow.cartesian = TRUE] %>% 
      .[, FitLm_m(get(variable), R, I, se = TRUE), by = c(regr_by)] %>% 
      rm_intercept() %>% 
      .[, p.val := Pvaluate(estimate, std.error, df, "fdr"), by = c(pval_by)] %>% 
      .[]
   
   
   class(regr) <- c("regression", class(regr))
   attr(regr, "formula") <- formula
   regr
})

regress <- function(ceof, data, variable) {
   variable <- deparse(substitute(variable))
   regress_m(ceof, data, variable)
}

plot.regression <- function(x, ..., keep = 0.015) {
   lats <- range(x$lat)
   lons <- range(x$lon)
   
   ggplot(x, aes(lon, lat)) +
      geom_contour_fill(aes(z = estimate), ...) +
      # geom_raster(aes(fill = estimate)) +
      stat_subset(aes(subset = p.val < 0.05), size = 0.1) +
      geom_map2(keep = keep) +
      scale_fill_divergent() +
      scale_x_longitude(limits = lons) +
      scale_y_latitude(limits = lats) +
      coord_quickmap() + 
      facet_nested(attr(x, "formula", TRUE))
}
```


```{r, fig.cap = "Regresión con v*T*"}
regress(ceofs, datos, vt) %>% 
   .[lev %in% c(200, 500)] %>% 
   plot(bins = 20)
```

```{r}
cmap_mean <- cmap %>% 
   .[, .(pp = mean(pp)), by = .(lon, lat, season(time))]
```


```{r, fig.cap="Regresión con olr"}
regress(ceofs, olr, olr) %>%
   na.omit() %>% 
   plot(bins = 20)
```

```{r, fig.cap = "Regresión con temperatura del aire"}
ceofs %>% 
   regress(datos, air) %>% 
   .[lev %in% max(lev)] %>% 
   plot(bins = 20)
```


```{r}

FitLr <- function(y, ...) {
   X <- cbind(`(Intercept)` = 1, ...)
   term <- dimnames(X)[[2]]
   fit <- RcppNumerical::fastLR(X, y)
   list(term = term, 
        estimate = fit$coefficients
   )
}

ceofs %>% 
   unnest_eof(ceof, "left") %>% 
   setnames("hgt", "EOF") %>% 
   sep_ReIm(EOF, FALSE) %>% 
   .[datos, on = .NATURAL, allow.cartesian = TRUE] %>% 
   .[, prop_3 := is.finite(ks) & ks > 3 ] %>% 
   # filter_sa() %>%  abs(R),
   .[lev == 500 & season == "SON"]  %>% 
   .[, FitLr(prop_3, EOF = abs(EOF)), by = .(lon, lat, lev, PC, season)] %>%
   ggplot(aes(lon, lat)) +
   geom_raster(aes(fill = sign(estimate))) +
   geom_map2(lat < 0) +
   scale_x_longitude() +
   scale_y_latitude() +
   scale_fill_divergent() +
   coord_quickmap() +
   facet_grid(PC~term)
```

```{r}

prop_mean <- datos %>% 
   copy() %>% 
   .[, prop_3 := is.finite(ks) & ks > 3 ] %>% 
   .[, .(prop_mean = mean(prop_3)), by = .(lon, lev, lat, season(time))]

mean_ks <- ceofs %>% 
   unnest_eof(ceof, "left") %>% 
   setnames("hgt", "EOF") %>% 
   sep_ReIm(EOF) %>% 
   .[datos, on = .NATURAL, allow.cartesian = TRUE] %>% 
   .[, EOF_p := Percentile(abs(EOF)), by = .(PC, part, season)] %>%
   .[, prop_3 := is.finite(ks) & ks > 3 ] %>% 
   .[, .(n = .N, 
         prop = mean(prop_3)), by = .(lon, lat, lev, season, PC, cut(EOF_p, c(0, 1/3, 2/3, 1)))] %>% 
   prop_mean[., on = .NATURAL]

mean_ks %>% 
   .[lev == 200] %>% 
   .[PC == "PC2"] %>% 
   ggplot(aes(lon, lat)) +
   geom_raster(aes(fill = prop - prop_mean)) +
   scale_x_longitude() +
   scale_y_latitude() +
   scale_fill_divergent(midpoint = 0) +
   coord_quickmap() +
   facet_nested(season ~ cut)

```


```{r "Regresión con precipitación en sudamérica"}
lats <- c(-38.75, -23.75)
lons <- ConvertLongitude(c(-63.75, -51.25))


regress(ceofs, filter_sa(cmap), pp) %>% 
   # .[PC == "PC2"] %>% 
   plot(keep = 1) +
   annotate("rect", xmin = min(lons), xmax = max(lons), ymin = min(lats), ymax = max(lats),
            fill = NA, color = "black") +
   scale_fill_distiller(palette = "BrBG")
```




```{r, fig.cap = "Precipitación media en LPB (caja de la figura anterior) en función de parte real e imaginaria de cada PC."}
cmap[lat %between% lats & lon %between% lons] %>% 
   .[, .(pp = mean(pp)), by = .(time)] %>% 
   .[unnest_eof(ceofs, ceof, "left"), on = .NATURAL, allow.cartesian = TRUE] %>% 
   sep_ReIm(hgt) %>% 
   ggplot(aes(pp, hgt)) +
   geom_point() +
   geom_smooth(method = "lm") +
   facet_nested(season ~ PC + part, scales = "free")
```

```{r, fig.cap = "Series temporales de precipitación en LPB observadas (rojo) y modeladas con modelo lineal (azul). El modelo se ajustó con datos anteriores a 2000. Se muestra la correlación entre las series para los datos posteriores a 2000."}
cmap[lat %between% lats & lon %between% lons] %>% 
   .[, .(pp = mean(pp)), by = .(time)] %>% 
   # .[, pp := scale(pp), by = .(season(time))] %>%
   .[unnest_eof(ceofs, ceof, "left"), on = .NATURAL, allow.cartesian = TRUE] %>% 
   sep_ReIm(hgt, longer = FALSE) %>% 
   .[, model := predict(lm(pp ~ R + I, data = .SD[year(time) < 2000]), newdata = .SD), by = .(season, PC)] %>%
   melt(id.vars = c("time", "season", "PC"), measure.vars = c("pp", "model")) %>% 
   ggplot(aes(time, value)) +
   geom_label(data = function(x) x[year(time) >= 2000] %>% 
                 .[, widyr::pairwise_cor(.SD, variable, time, value, upper = FALSE), by = .(season, PC)],
              aes(label = scales::number(correlation, accuracy = 0.01)), 
              x =  lubridate::make_datetime(year = 2010),
              y = 5) +
   geom_vline(xintercept = lubridate::make_datetime(year = 2000), color = "gray") +
   geom_line(aes(color = variable)) +
   scale_color_brewer("", palette = "Set1", label = c("Obs", "Modelo")) +
   facet_grid(season ~ PC)
```

