---
title: "09 - Usando datos diarios"
author: "Elio"
date: ""
output: pdf_document
---


```{r setup, include=FALSE}
# Notification
start.time <- unclass(Sys.time())
min.time <- 10
knit_doc <- knitr::knit_hooks$get("document")
knitr::knit_hooks$set(document = function(x) {
   took <- unclass(Sys.time()) - start.time
   if (unclass(Sys.time()) - start.time >= min.time) {
      notify("Done knitting!", 
             paste0("Took ", round(took), " seconds"),
             time = 5)
   }  
   knit_doc(x)
})

name <- tools::file_path_sans_ext(knitr::current_input())
knitr::opts_chunk$set(echo = FALSE,
                      cache = TRUE,
                      warning = FALSE, message = FALSE,
                      out.extra = "", 
                      cache.path = paste0("cache/", name, "/"),
                      fig.path = paste0("fig/", name, "/"))

library(metR)
library(data.table)
library(ggplot2)
library(metR)
library(magrittr)
library(circular)
library(RcppRoll)
library(patchwork)
library(lubridate)
library(here)
here <- here::here
source("scripts/helperfun.R")

data.world <- BuildMap(res = 1, smooth = 1)
map.world <- geom_map2(data.world)
map.SH <- geom_map2(data.world[lat %b% c(-90, 20)], color = "gray20")

lev.breaks <- c(1000, 500, 300, 200, 100, 50, 10)

theme_elio <- theme_minimal(base_size = 11) +
   theme(
      # text = element_text(family = font_rc),
      legend.position = "bottom", legend.box = "vertical",
      panel.spacing.y = unit(5, "mm"),
      panel.spacing.x = unit(5, "mm"),
      legend.spacing = unit(2, "mm"),
      plot.margin = grid::unit(rep(3, 4), "mm"),
      legend.title = element_blank(),
      legend.box.spacing = unit(3, "mm"),
      legend.margin = margin(t = -5),
      panel.grid = element_line(color = "gray50", size = 0.2, linetype = 3),
      panel.ontop = TRUE)
theme_set(theme_elio)
guide_colorstrip_bottom <- function(width = 25, height = 0.5, ...) {
   guide_colorstrip(title.position = "top", title.hjust = 0.5,
                    barheight = height,
                    barwidth = width, ...)
}
```

```{r}
hgt <- ReadNetCDF("~/DATOS/NCEP Reanalysis/hgt.daily.nc", "hgt", 
           subset = list(lat = -55, level = 200)) 
setnames(hgt, "level", "lev")

hgt.m <- ReadNetCDF("~/DATOS/NCEP Reanalysis/hgt.mon.mean.nc", "hgt", 
                    subset = list(lat = -55, level = 200))
```

Dado que al fin conseguí bajar y juntar los datos diarios de geopotential de NCEP, veamos qué pasa. Obviamente leer todos los datos es una bestialidad, así que me concentro en 200hPa y 55°S.

```{r}
(hgt[, FitWave(hgt, 3), by = time] %>% 
   ggplot(aes(time, amplitude)) +
   geom_line() +
    scale_x_datetime(expand = c(0, 0))) %>% 
   ggwrap::ggwrap(3)
```

Obviamente no se ve nada. Esta es la amplitud de la ZW3 del geopotencial con un suavizado de 31 días comparado con la ZW3 de los campos mensuales (en rojo)

```{r}
hgt[, hgt.s := RcppRoll::roll_mean(hgt, 31, fill = NA), by = lon]

hgt[!is.na(hgt.s), FitWave(hgt.s, 3), by = time] %>% 
   .[, amplitude.s := smooth.loess(amplitude ~ as.numeric(time), 
                                   span = 365*5/.N)] -> qs.m
(ggplot(qs.m, aes(time, amplitude)) +
    geom_line() + 
    geom_line(data = hgt.m[, FitWave(hgt, 3), by = time], color = "red") +
    scale_x_datetime(expand = c(0, 0))) %>% 
   ggwrap::ggwrap(3)
```

Es básicamente lo mismo, jeje. Pero se puede hacer un ciclo anual muy detallado haciendo la QS3 de cada día del año

```{r}
qs <- hgt[!is.na(hgt.s), FitWave(hgt.s, 3), by = .(time)]

hgt[!is.na(hgt.s),
    mean(hgt.s), by = .(lon, daymonth(time))] %>%
   .[, FitWave(V1, 3), by = daymonth] -> qs.m

melt(qs.m[, .(daymonth, amplitude, phase)], id.vars = c("daymonth")) %>%
   ggplot(aes(daymonth, value)) +
    geom_line(aes(x = as.numeric(daymonth))) +
   facet_wrap(~variable, scales = "free", ncol = 1)
```

No hay grandes novedades sobre la amplitud, aunque se ve un poco mejor el gran minimo en noviembre y que el resto del año es más constante. En el caso de la fase, se nota mejor cómo es la forma del ciclo anual. Se desplaza lentamente entre verano e invierno y luego aumenta rápidamente pero no llega a la misma posición. En comparación, la visión desde los datos mensuales es bastante más rústica. 

```{r}
hgt.m[, mean(hgt), by = .(lon, month(time))] %>% 
   .[, FitWave(V1, 3), by = month] %>% 
   .[, .(month, amplitude, phase)] %>% 
   melt(id.vars = c("month")) %>% 
      ggplot(aes(month, value)) +
    geom_line() +
   facet_wrap(~variable, scales = "free", ncol = 1)
   
```


En cuanto la estacionariedad. Los datos diarios se comportan igual que los mensuales (en rojo).

```{r}
window <- 10
qs[, c("R", "I") := .(amplitude*cos(3*phase), amplitude*sin(3*phase))]
qs[, R.s := smooth.loess(R ~ as.numeric(time), span = 365*window/.N)]
qs[, I.s := smooth.loess(I ~ as.numeric(time), span = 365*window/.N)]
qs[, c("phi.s") := atan2(I.s, R.s)]

# qs[, phi.s := mean.phase(amplitude, phase, 3)]
qs[, rho := cos(3*phase - phi.s)]

qs[, amplitude.s := predict(loess(amplitude ~ as.numeric(time), 
                            span = 365*window/.N, degree = 1))]
qs[!is.na(rho), amoma := predict(loess(rho ~ as.numeric(time), 
                                       weights = amplitude, span = 365*window/.N, 
                                       degree = 1))]

amoma.m <- hgt.m[, FitWave(hgt, 3), by = .(time)] %>% 
   .[, c("R", "I") := .(amplitude*cos(3*phase), amplitude*sin(3*phase))] %>% 
   .[, R.s := smooth.loess(R ~ as.numeric(time), span = 12*window/.N)] %>% 
   .[, I.s := smooth.loess(I ~ as.numeric(time), span = 12*window/.N)] %>% 
   .[, c("phi.s") := atan2(I.s, R.s)] %>% 
   # .[, phi.s := mean.phase(amplitude, phase, 3)] %>% 
   .[, rho := cos(3*phase - phi.s)] %>% 
   .[!is.na(rho),
     c("amoma", "ci") := 
        predict(loess(rho ~ as.numeric(time), weights = amplitude, 
                      span = 12*window/.N, data = .SD, degree = 1), 
                se = TRUE)[c("fit", "se.fit")]]


ggplot(qs, aes(time, amoma)) +
   # geom_line(color = "gray40") +
   geom_line() +
   geom_line(data = amoma.m, color = "red") +
   coord_cartesian(ylim = c(0, NA))
```



```{r}
periodic(qs, phi.s = c(-pi, pi)) %>% 
   wrap(phi.s = c(0, 2*pi)) %>% 
ggplot( aes(time, phi.s)) +
   geom_line() +
   geom_line(aes(y = amoma*2*pi), color = "red") +
   scale_y_continuous(limits = c(0, 2*pi), sec.axis = ~./2/pi) +
   scale_x_datetime(date_breaks = "5 years", date_labels = "%Y", 
                    date_minor_breaks = "1 year")
```

Está más que claro que algo pasó en ~1953 (el cambio es en ese año precisamente). Ese salto enorme en la fase, que además está acompañado por una disminución de la estacionariedad no parece normal y podría estar relacionado con alguna inhomogeneidad. 

```{r}
amoma.m[] %>%
   qwrap(phi.s = c(-pi, pi) ~ c(0, 2*pi)) %>% 
   # .[year(time) > 1960] %>% 
   .[, date := time] %>% 
   .[, Wavelets(.SD, "phi.s" , loess.span = 0)] -> wv

autoplot(wv, geom = "tanaka")
```


