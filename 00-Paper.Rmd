---
title: "1 paper de la onda 3"
author: "Elio Campitelli"
date: "April 19, 2018"
output:
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      cache = TRUE, cache.lazy = TRUE,
                      warning = FALSE,
                      dev = "cairo_pdf")

library(data.table)
library(ggplot2)
library(dplyr)
library(metR) 
library(WaveletComp)
# library(patchwork)
library(circular)
library(hrbrthemes)
library(extrafont)

source("scripts/helperfun.R")
# Plot thingys

data.world <- BuildMap(res = 1, smooth = 1)
map.world <- geom_map2(data.world)
map.SH <- geom_map2(data.world[lat %b% c(-90, 20)], color = "gray20")


pres <- ReadNetCDF("DATA/srfp.mon.mean.nc")
pres.mean <- pres[, .(pres = median(pres)), by = lat]
pres.mean <- rbind(data.table(lat = 0.0, pres = Inf), 
                   pres.mean, 
                   data.table(lat = -90.0, pres = Inf))
surface <- geom_polygon(data = pres.mean, aes(y = pres), fill = "white", 
                        alpha = 1, color = "gray30", size = 0.5)
pres <- pres[, .(pres = mean(pres)), by = .(lon, lat)]

# From https://github.com/hrbrmstr/hrbrthemes/issues/18
d <- read.csv(extrafont:::fonttable_file(), stringsAsFactors = FALSE)
d[grepl("Light", d$FontName),]$FamilyName <- font_rc_light
write.csv(d,extrafont:::fonttable_file(), row.names = FALSE)
extrafont::loadfonts()

theme_elio <- theme_minimal(base_size = 11) +
   theme(
      text = element_text(family = font_rc),
      legend.position = "bottom", legend.box = "vertical",
      panel.spacing.y = unit(5, "mm"),
      panel.spacing.x = unit(5, "mm"),
      legend.spacing = unit(2, "mm"),
      plot.margin = grid::unit(rep(3, 4), "mm"),
      legend.title = element_blank(),
      legend.box.spacing = unit(3, "mm"),
      legend.margin = margin(t = -5),
      panel.grid = element_line(color = "gray50", size = 0.2, linetype = 3),
      panel.ontop = TRUE)
theme_set(theme_elio)
update_geom_defaults(metR:::GeomTextContour, list(family = font_rc))

update_geom_defaults("contour2", list(color = "black"))
update_stat_defaults("contour2", aes(linetype = factor(-sign(..level..))))

options(ggplot2.continuous.fill = "viridis", 
        ggplot2.continuous.color = "viridis")

coord_quickmap <- function(..., ylim = c(-90, -15)) {
   ggplot2::coord_quickmap(ylim = ylim, ...) 
} 

geom_contour_ <- function(..., gap = 0, rotate = FALSE) {
   if (gap != 0) {
      list(geom_contour2(..., gap = gap),
           geom_text_contour(..., rotate = rotate))
   } else {
      geom_contour2(...)
   }
}

# For vertical cross-sections
coord_latlev <- function(ratio = 20, ...) coord_fixed(ratio = ratio, ...)
coord_lonlev <- function(ratio = 20*4, ...) coord_fixed(ratio = ratio, ...)

lev.breaks <- c(10, 30, 100, 200, 500, 1000)

season <- function(...) {
   metR::season(..., lang = "en")
}
```

```{r read-ncep}
ncep.f <- memoise::memoise(function(lat = -90:40, 
                                    lon = 0:360,
                                    time = lubridate::as_datetime(c("1979-12-01", "2015-12-01")),
                                    level = 10:1000,
                                    vars = "gh"){
   subset <- list(lat = lat, lon = lon, level = level,
                  time = time)
   n <- ReadNetCDF("DATA/hgt.mon.mean.nc", vars = c(gh = "hgt"),
                   subset = subset) %>% 
      setnames(., c("level"), c("lev"))
   if ("u" %in% vars) {
      n[, u := ReadNetCDF("DATA/uwnd.mon.mean.nc", out = "vector",
                          subset = subset)[[1]]] 
   }
   if ("v" %in% vars) {
      n[, v := ReadNetCDF("DATA/vwnd.mon.mean.nc", out = "vector",
                          subset = subset)[[1]]]
   }
   n[, time := as.Date(time[1]), by = time]
   return(n)
}, cache = memoise::cache_filesystem(".rcache"))
ncep <- ncep.f()
```

# "Tradicional" analysis.

```{r calc-fourier1}
rect.annotation <- data.frame(latmin = -65, latmax = -40,
                              levmin = 100, levmax = 700, 
                              k = 3)
ncep.qs <- ncep[, .(gh = mean(gh)), by = .(lat, lon, lev, season(time))] %>% 
   .[, FitWave(gh, k = 1:4), 
     by = .(lat, lev, season)] 
```

```{r ampl-ncep, fig.cap = "Fourier amplitude of geopotential height"}
breaks <- 2^seq(0, log2(650), by = 1)
ggplot(ncep.qs[lat <= 0], aes(lat, lev)) +
   geom_contour_fill(aes(z = amplitude),
                     breaks = breaks) +
   geom_contour_(aes(z = amplitude),
                 breaks = breaks, gap = 1, rotate = FALSE) +
   surface +
   geom_index.region(rect.annotation) +
   scale_fill_viridis_c(name = "Amplitud (escala logarítmica)", 
                        trans = "log2",
                        breaks = breaks,
                        labels = round(breaks, 1),
                        guide = guide_colorstrip_bottom(),
                        option = "D") +
   scale_y_level() +
   scale_x_latitude(name = "latitud", trans = "reverse", 
                    ticks = 15) +
   coord_latlev() +
   facet_grid(k ~ season, labeller = labeller(k = qs.lab)) 
```

```{r gh3-season, fig.cap = "Wave 3 component of the geopotential field of each season at 200hPa."}
lons <- unique(ncep$lon)
qs3 <- ncep.qs[k == 3, .(lon = lons, 
                         gh = BuildField(lons*pi/180, amplitude, phase, k)), 
               by = .(lat, lev, season)]

binwidth <- 10
ggplot(qs3[lev == 200], aes(lon, lat)) +
   geom_contour_fill(aes(z = gh), breaks = AnchorBreaks(0, binwidth, 0)) +
   geom_contour_(aes(z = gh), breaks = AnchorBreaks(0, binwidth, 0), gap = 0) +
   map.SH +
   scale_s_map(ylim = c(-90, 20)) +
   scale_fill_divergent(breaks = AnchorBreaks(0, binwidth, 0), 
                        name = "QS3",
                        guide = guide_colorstrip_bottom()) +
   facet_wrap(~season, ncol = 2) +
   coord_quickmap()
```

```{r qs3-season-cut, fig.cap = "Mean wave 3 component of geopotential height between 65°S and 35°S"}
cutlats <- c(-65, -35)
binwidth <- 5
ggplot(qs3[lat %between% cutlats, .(gh = mean(gh)), by = .(lon, lev, season)], 
       aes(lon, lev)) +
   geom_contour_fill(aes(z = gh), breaks = AnchorBreaks(0, binwidth, 0)) +
   geom_contour3(aes(z = gh), breaks = AnchorBreaks(0, binwidth, 0)) +
   scale_y_level(breaks = lev.breaks) +
   scale_x_longitude(name = "lon") +
   scale_fill_divergent(breaks = AnchorBreaks(0, binwidth, 0), 
                        name = "QS3",
                        guide = guide_colorstrip_bottom()) +
   facet_wrap(~season, ncol = 2) 
```


Now this has some problems... yada yada yada, alternative analysis. 

# New seasons

```{r eof4-ncep, fig.cap = "First 4 EOFs derived from the 200hPa detrended geopotential zonal anomaly field between 30°S and 80°S with zonal wave 1 filtered out. Erros bars represent the 95% cuantile range estimated via bootstrap."}
region <- expand.grid(lat = c(-65, -40),
                      lev = c(100, 700))
lats.eof <- c(-80, -30)
qs.eof <- copy(ncep[lev == 200 & lat %between% lats.eof]) %>%
   .[, gh.minus := FilterWave(gh, k = 0:-1), by = .(lat, time, lev)] %>% 
   .[, gh := gh.minus*sqrt(cos(lat*pi/180))] %>%
   .[, gh := resid(.lm.fit(cbind(1, time), gh)),
        by = .(lon, lat)] %>%
   EOF(data = ., gh ~ time | lon + lat, n = 1:10, B = 5000)

qs.eof$sdev %>% 
   ggplot(aes(as.numeric(PC), mid)) +
   geom_point() +
   geom_line() +
   geom_errorbar(aes(ymin = lower, ymax = upper),
                 width = 0.3) +
   scale_x_continuous("PC", 
                      breaks = 1:20, minor_breaks = NULL) +
   scale_y_continuous("sigma")
```

```{r}
qs.eof <- CutEOF(qs.eof, 1:6)
pc.labeller <- function(qs.eof) {
   with(qs.eof$sdev, setNames(paste0(PC, " - ", scales::percent(r2)),
                              PC))
}

binwidth <- 0.01
ggplot(qs.eof$right, aes(lon, lat)) +
   geom_contour_fill(aes(z = gh), 
                     breaks = AnchorBreaks(0, binwidth, 0)) +
   geom_contour3(aes(z = gh),
                 breaks = AnchorBreaks(0, binwidth, 0)) +
   map.SH +
   geom_hline(yintercept = lats.eof, linetype = 2) +
   scale_s_map() +
   scale_fill_divergent(breaks = AnchorBreaks(0, binwidth, 0),
                        guide = guide_colorstrip_bottom()) +
   coord_quickmap(ylim = c(-90, -20)) +
   facet_wrap(~PC, ncol = 3, dir = "v", labeller = labeller(PC = pc.labeller(qs.eof)))
```

```{r fourier-eof, fig.cap = "Fourier decomposition by latitude of each EOF."}
qs.eof$right[, FitWave(gh, 2:4), by = .(lat, PC)]  %>%
   ggplot(aes(amplitude, lat)) +
   geom_path(aes(color = paste0("QS", k))) +
   scale_y_latitude(ticks = 15) +
   scale_x_continuous() +
   scale_color_brewer(palette = "Set1") +
   coord_fixed(1/900) +
   facet_wrap(~PC, ncol = 3, dir = "v", labeller = labeller(PC = pc.labeller(qs.eof)))
```


This text is no longer valid: 

PC1 to PC4 represent the principal modes of variability of the geopotential field with wavenumber greater than 1...

PC1 and PC2 both are dominated by a wave 3 pattern. They both explain an almost equal proportion of the total variance and represent a wave 3 pattern offset by 1/4 wavelength. From that, one can infer that they are degenerated modes that represent the same wave pattern and it's meridional movement. PC3 is mainly a hemispheric scale wave 2 with a small contribution of wave 4 north of 45°S. PC4 exhibits a more complex pattern with both waves 2 and 3 contributing to the field. The result is a wave 3-ish pattern on the eastern hemisphere that affects the Atlantic and the Indian oceans but disappears over the central-south Pacific.

This result suggest that the ZW3 could be represented by a linear combination of PC1 and PC2 at the same time preserving it's meridional propagation and zonal variation.

```{r PC1-PC2-trim, fig.cap = "Monthly mean values for each PC. Colors and shapes divide months into 5 'seasons'."}
qs.eof$left %>% 
   .[qs.eof$sdev, on = "PC"] %>% 
   .[, .(value = mean(gh*sd)), by = .(PC, month(time))] %>%
   dcast(... ~ PC) %>%
   ggplot(aes(PC1, PC2)) +
   # xlab("PC 1") + ylab("PC 2") +
   geom_cross(color = "gray50") +
   ggforce::geom_link2(aes(color = qs.season(month),
                           group = 1),
                       alpha = 0.5) +
   geom_point(aes(color = qs.season(month), shape = qs.season(month)),
              size = 3)+
   ggrepel::geom_text_repel(aes(label = month.abb[month])) +
   scale_color_brewer(palette = "Set1", na.translate = F) +
   scale_shape_circlefill() +
   guides(color = "none", shape = "none") +
   coord_equal()
```

```{r cluster, fig.cap = "Hierarchical clustering of the months of the year according to the mean value of each PC scaled by it's variance."}
qs.eof$left %>% 
   .[qs.eof$sdev, on = "PC"] %>% 
   .[, .(value = mean(gh*sd)), by = .(PC, month(time))] %>%
   dcast(month ~ PC, value.var = "value") %>% 
   .[, -1] %>% 
   dist() %>%
   hclust() %>% 
   plot(labels = month.abb, hang = -1) 
```


```{r PC1-PC2-trim-sd, fig.cap = "Monthly standard deviation for each PC. Colors and shapes divide months into 5 'seasons'."}
qs.eof$left %>% 
   .[qs.eof$sdev, on = "PC"] %>% 
   .[, .(value = sd(gh*sd)), by = .(PC, month(time))] %>%
   dcast(... ~ PC) %>%
   ggplot(aes(PC1, PC2)) +
   # xlab("PC 1") + ylab("PC 2") +
   geom_cross(color = "gray50") +
   ggforce::geom_link2(aes(color = qs.season(month),
                           group = 1),
                       alpha = 0.5) +
   geom_point(aes(color = qs.season(month), shape = qs.season(month)),
              size = 3)+
   ggrepel::geom_text_repel(aes(label = month.abb[month])) +
   scale_color_brewer(palette = "Set1", na.translate = F) +
   scale_shape_circlefill() +
   guides(color = "none", shape = "none") +
   coord_equal()
```


```{r cluster-sd, fig.cap = "Hierarchical clustering of the months of the year according to the standard deviation of each PC scaled by it's variance."}
qs.eof$left %>% 
   .[qs.eof$sdev, on = "PC"] %>% 
   .[, .(value = sd(gh*sd)), by = .(PC, month(time))] %>%
   dcast(month ~ PC, value.var = "value") %>% 
   .[, -1] %>% 
   dist() %>%
   hclust() %>% 
   plot(labels = month.abb, hang = -1) 
```




```{r sd-eof, fig.cap = "Standard deviation (scaled by their variance) of each PC for each month"}
qs.eof$left %>%
   .[qs.eof$sdev, on = "PC"] %>% 
   .[, sd(gh*sd), by = .(PC, month(time))] %>% 
   ggplot(aes(month, PC, color = V1)) +
   geom_raster(aes(fill = V1)) +
   scale_x_continuous("", breaks = 1:12, labels = month.abb,
                      expand = c(0, 0)) +
   scale_y_discrete("", expand = c(0, 0)) +
   theme(panel.ontop = FALSE) +
   scale_fill_viridis_c()
```


```{r sd-eof2, fig.cap = "Standard deviation of each PC for each month"}
qs.eof$left %>%
   .[, sd(gh), by = .(PC, month(time))] %>% 
   ggplot(aes(month, PC, color = V1)) +
   geom_raster(aes(fill = V1)) +
   scale_x_continuous("", breaks = 1:12, labels = month.abb,
                      expand = c(0, 0)) +
   scale_y_discrete("", expand = c(0, 0)) +
   theme(panel.ontop = FALSE) +
   scale_fill_viridis_c()
```


An optimal (if somewhat arbitrary) division of the year can be seen in Figure X based on monthly mean values of each PC...


Notes: 

- Making other (still sensible) decisions lead to some differences in clustering. For example, using fields with QS1 *and* QS2 filtered out puts May closer to April, and December further from JFM. Not surprisingly, a similar result is achieved by using using idealized fields from the reconstructed zonal wave 3 (since higher wavenumbers explain a negligible proportion of the viariance). JFM and ASO (and it's similarity with April), on the other hand, are robust trimesters.

- This differences imply that the ZW2 might be have an important role in the variability in May and December. 

- JJ is a relatively robust grouping but with obviously more heterogeneous than JFM or ASO

- Futhermore, removing the linear trend as well as the QS1 field results in a similar classification to the one shown, but the structure of the EOF is slightly different with less separation between wavenumbers (the zonal wave 3 is present in PC1, PC2 and PC3) and a much more asymmetric nature, with higher amplitude anomalies on the western hemisphere than the eastern in the first two PCs and the reverse on the second two. Is it as the wave activity of each hemosphere is separated this way. 


# Regressions


```{r calc-gh.cor}
qs.eof$left <- qs.eof$left[, gh.sd := gh/sd(gh), by = .(PC)]

qs.eof$left %>% 
   copy() %>% 
   .[, .(gh.eof = mean(gh.sd)), 
     by = .(PC, season = qs.trim(time), year(time))] %>% 
   .[!is.na(season)] %>% 
   CutEOF(1:2) %>% 
   dcast(year + season ~ PC, value.var = "gh.eof") -> eof.trim

ncep[lev == 200, .(gh = mean(gh)), 
     by = .(lon, lat, year(time), 
            season = qs.trim(time))] %>% 
   .[!is.na(season)] %>% 
   .[, gh := Anomaly(gh), by = .(lon, lat, season)] -> gh.trim 

# Regresión de PCs estandarizados con anomalía trimestral,
# (1 dato por trimestre por año)
gh.regr <- gh.trim[eof.trim,  
                   on = c("season", "year"), 
                   allow.cartesian = TRUE] %>% 
   .[, FitLm(gh, PC1, PC2, se = TRUE), 
     by = .(lon, lat, season)] %>% 
   .[regressor != "mean"]

# Regresión de PCs estandarizados con anomalía mensual, agregados
# trimestralmente (~3 datos por año por trimestre)
gh.regr.month <- ncep[lev == 200] %>% 
   .[, gh := Anomaly(gh), by = .(lon, lat, month(time))] %>% 
   .[dcast(CutEOF(qs.eof$left, 1:2), 
           time ~ PC, value.var = "gh.sd"), on = "time", 
     allow.cartesian = TRUE] %>% 
   .[!is.na(qs.trim(time)), 
     FitLm(gh, PC1, PC2, se = TRUE), 
     by = .(lon, lat, season = qs.trim(time))] %>% 
   .[regressor != "mean"]
```


```{r gh-regr, fig.cap = "(standarized) Regression between PCs and gh."}
binwidth <- 20
rbindlist(list(full = gh.regr.month, 
               point = gh.regr), use.names = TRUE,
          idcol = "method") %>% 
   ggplot( aes(lon, lat)) +
   # geom_contour2(aes(z = -value, linetype = factor(-sign(..level..))),
   # breaks = AnchorBreaks(0, 0.15, 0), color = "black") +
   geom_contour_fill(aes(z = estimate), circular = "x",
                     breaks = AnchorBreaks(0, binwidth, 0)) +
   geom_contour3(aes(z = estimate), circular = "x",
                 breaks = AnchorBreaks(0, binwidth, 0)) +
   map.SH +
   scale_fill_divergent(breaks = AnchorBreaks(0, binwidth, 0),
                        guide = guide_colorstrip_bottom()) +
   scale_s_map() +
   coord_quickmap() +
   facet_grid(regressor + method ~ season)
```

```{r read-psi}
subset <- list(lat = -90:40,
               time = lubridate::as_datetime(c("1979-12-01",
                                               "2016-02-01")))
stream <- ReadNetCDF("DATA/stream.mon.mean.nc",
                     subset = subset, key = TRUE) %>%
   setnames(c("level"), c("lev")) %>%
   .[, time := as.Date(time[1]), by = time] %>% 
   .[, psi.z := Anomaly(psi), by = .(lat, time)]

stream.mean.season <- stream[, .(psi = mean(psi),
                                 psi.z = mean(psi.z)),
                             by = .(lon, lat, lev, season = qs.trim(time))] %>% 
   .[!is.na(season)]
stream.mean.season[, c("f.lon", "f.lat") := WaveFlux(.SD), by = season]
```

```{r calc-psi.regr}
stream %>% 
   .[!is.na(qs.trim(time)), 
     .(psi = mean(psi)), by = .(lon, lat, year(time),
                                season = qs.trim(time))] %>% 
   .[, psi.a := Anomaly(psi), by = .(lon, lat, season)] -> stream.trim

# Regresión de PCs estandarizados con anomalía trimestral,
# (1 dato por trimestre por año)
stream.trim[eof.trim, on = c("season", "year")] %>% 
   .[complete.cases(.)] %>% 
   .[, FitLm(psi.a, PC1, PC2),
     by = .(lon, lat, season)] %>% 
   .[regressor != "mean"] -> psi.regr

# Regresión de PCs estandarizados con anomalía mensual, agregados
# trimestralmente (~3 datos por año por trimestre)
qs.eof$left %>% CutEOF(1:2) %>% 
   dcast(time ~ PC, value.var = "gh.sd") %>%
   .[stream, on = "time"] %>%
   .[, psi := Anomaly(psi), by = .(lon, lat, month(time))] %>% 
   .[!is.na(qs.trim(time)),
     FitLm(psi, PC1, PC2),
     by = .(lon, lat, season = qs.trim(time))] %>% 
   .[regressor != "mean"] -> psi.regr.month

psi.regr <- rbindlist(list(point = psi.regr,
                           full = psi.regr.month),
                      use.names = TRUE,
                      idcol = "method") %>%  
   .[, psi.z := estimate] %>% 
   .[, c("f.lon", "f.lat") := WaveFlux(.SD), 
     by = .(regressor, season, method)] 
```


```{r psi.regr, fig.cap = "Regression between PCs and Psi. "}
binwidth <- 0.0015
ggplot(psi.regr, aes(lon, lat)) +
   geom_contour_fill(aes(z = psi.z*10^-9),
                     breaks = AnchorBreaks(0, binwidth, 0),
                     # breaks = breaks,
                     circular = "x") +
   geom_contour3(aes(z = psi.z*10^-9),
                 breaks = AnchorBreaks(0, binwidth, 0),
                 # breaks = breaks,
                 circular = "x") +
   geom_streamline(aes(dx = f.lon, dy = f.lat), 
                   skip = 3, circular = "x", L = 10, size = 0.3, 
                   min.dist = 5, arrow.length = 0.2, arrow.angle = 10) +
   map.SH +
   scale_s_map(ylim = c(-90, 40)) +
   scale_fill_divergent(breaks = AnchorBreaks(0, binwidth, 0),
                        guide = guide_colorstrip_bottom()) +
   facet_grid(regressor + method  ~ season) +
   coord_quickmap(ylim = c(-90, 20))
```


```{r psi.regr2, fig.cap = "Zonal anomaly of regression between PCs and Psi."}
binwidth <- 0.0015
psi.regr %>% 
   .[, psi.z := Anomaly(estimate), by = .(lat, regressor, method, season)] %>% 
   .[, c("f.lon", "f.lat") := WaveFlux(.SD), 
     by = .(regressor, season, method)] 
ggplot(psi.regr, aes(lon, lat)) +
   geom_contour_fill(aes(z = psi.z*10^-9),
                     breaks = AnchorBreaks(0, binwidth, 0),
                     circular = "x") +
   geom_contour3(aes(z = psi.z*10^-9),
                 breaks = AnchorBreaks(0, binwidth, 0),
                 circular = "x") +
   geom_streamline(aes(dx = f.lon, dy = f.lat), 
                   skip = 3, circular = "x", L = 10, size = 0.3, 
                   min.dist = 5, arrow.length = 0.2, arrow.angle = 10) +
   map.SH +
   scale_s_map(ylim = c(-90, 40)) +
   scale_fill_divergent(breaks = AnchorBreaks(0, binwidth, 0),
                        guide = guide_colorstrip_bottom()) +
   facet_grid(regressor + method  ~ season) +
   coord_quickmap(ylim = c(-90, 20))
```


```{r read-ice}
ice <- readRDS("DATA/seaice.Rds")
ice.mask <- readRDS("DATA/landmask.Rds")
ice.mask <- setDT(tidyr::complete(ice.mask, x, y, fill = list(concentration = 0)))
setnames(ice, "date", "time")

ice.trim <- ice[!is.na(qs.trim(time)), 
                       .(concentration = mean(concentration)), 
                keyby = .(lon, lat, year(time), season = qs.trim(time))]

ice.trim[, concentration.a := Anomaly(concentration), 
         by = .(lon, lat, season)]
```

```{r calc-ice.regr}
ice.trim[eof.trim, on = c("season", "year")] %>% 
   .[complete.cases(.)] %>% 
   .[, FitLm(concentration.a, PC1, PC2, se = TRUE),
     by = .(lon, lat, season)] %>% 
   .[regressor != "mean"] -> ice.regr
```

```{r ice-regr, fig.cap = "Regression of standarized PC with antarctic sea ice concentrations."}
binwidth <- 10

ggplot(ice.regr[lat < -55], aes(lon, lat)) +
   geom_point(aes(color = estimate*100), size = 0.05) +
   geom_contour3(data = gh.regr, aes(z = estimate),
                 breaks = AnchorBreaks(0, 25, 0), circular = "x") +
   map.SH +
   scale_color_divergent(breaks = AnchorBreaks(0, binwidth, 0),
                         limits = c(-25, 25),
                        guide = guide_colorstrip_bottom()) +
   scale_s_map(ylim = c(-90, -40)) +
   coord_polar() +
   # coord_quickmap(ylim = c(-90, -55)) +
   facet_grid(regressor ~ season)
```


```{r read-sst}
sst <- ReadNetCDF("DATA/sst.nc", vars = "sst")
sst[, time := as.Date(time[1]), by = time]

sst.trim <- sst[!is.na(qs.trim(time)), 
                .(sst = mean(sst)), 
                keyby = .(lon, lat, year(time), 
                          season = qs.trim(time))] %>% 
   .[, sst.a := Anomaly(sst), by = .(lon, lat, season)]
```

```{r calc-sst.regr}
sst.trim[eof.trim, on = c("season", "year")] %>% 
   .[complete.cases(.)] %>% 
   .[, FitLm(sst.a, PC1, PC2, se = TRUE),
     by = .(lon, lat, season)] %>% 
   .[regressor != "mean"] -> sst.regr
```

```{r sst-regr, fig.cap = "Regression of standarized PC with SST."}
ggplot(sst.regr, aes(lon, lat)) +
   geom_raster(aes(fill = estimate)) +
   geom_contour3(aes(z = sign(estimate)*as.numeric(abs(estimate) > se*1.6)),
                 breaks = c(-0.5, 0.5), circular = "x") +
   stat_subset(aes(subset =  abs(estimate) > se*2), geom = "point",
               alpha = 0.5, color = "black", size = 0.05,
               data = sst.regr[lon %in% JumpBy(unique(lon), 4) &
                                  lat %in% JumpBy(unique(lat), 4)]) +
   map.SH +
   scale_fill_divergent(guide = guide_colorstrip_bottom(),
                        breaks = AnchorBreaks(0, 0.5, 0)) +
   scale_s_map(ylim = c(-90, 30)) +
   coord_quickmap(ylim = c(-90, 30)) +
   facet_grid(season ~ regressor)
```


```{r read-oni}
oni <- fread("DATA/ONI_v5.csv") 
colnames(oni) <- c("year", 1:12)
oni <- melt(oni, id.vars = "year", variable.name = "month", value.name = "ONI")
oni[, time := lubridate::ymd(paste0(year, "-", month, "-01"))]
oni[, c("year", "month") := NULL]
```

```{r enso-regr}
oni.trim <- oni[!is.na(qs.trim(time)), 
                .(ONI = mean(ONI)), 
                by = .(year(time), season = qs.trim(time))] %>% 
   .[, ONI.a := Anomaly(ONI), by = season]

eof.trim %>% 
   melt(id.vars = c("year", "season"), variable.name = "PC") %>%
   oni.trim[., on = c("season", "year")] %>% 
   .[complete.cases(.)] %>% 
   .[,  broom::tidy(cor.test(value, ONI)),
     by = .(season, PC)] %>% 
   .[PC == "PC1"] %>% 
   dcast(season ~ PC, value.var = c("estimate", "p.value")) %>% 
   knitr::kable(digits = c(1, 2, 9), 
                caption = "Correlation between ONI and PC1")
```

\newpage


```{r read-olr}
olr <- ReadNetCDF("DATA/olr.mon.mean_sub.nc")
olr[, time := as.Date(time[1]), by = time]

qs.eof$right %>%
   .[, gh := gh/sd(gh), by = .(PC)] %>% 
   dcast(time ~ PC, value.var = "gh") %>%
   .[olr, on = "time"] %>%
   .[!is.na(PC1)] -> olr

olr <- olr[, olr.a := Anomaly(olr), by = .(lon, lat, month(time))]
```

```{r}
copy(oni) %>% 
   .[, ONI := ONI/sd(ONI)] %>% 
   .[olr, on = "time"] -> olr
```


```{r calc-olr.regr}
olr[!is.na(qs.trim(time)), 
    FitLm(olr.a, PC1, PC2, se = TRUE),
    by = .(lon, lat, season = qs.trim(time))] %>% 
   .[regressor != "mean"] -> olr.regr
```

```{r olr-regr, fig.cap = "Regression between OLR and PCs"}
binwidth <- 1
ggplot(olr.regr[regressor != "ONI"], aes(lon, lat)) +
   geom_contour_fill(aes(z = estimate), breaks = AnchorBreaks(0, binwidth, 0),
                     circular = "x") +
   geom_contour3(aes(z = sign(estimate)*as.numeric(abs(estimate) > se*2),
                     linetype = factor(sign(..level..))),
                 breaks = c(-0.5, 0.5), circular = "x") +
   stat_subset(aes(subset =  abs(estimate) > se*2), geom = "point",
               alpha = 0.5, color = "black", size = 0.05,
               data = olr.regr[regressor != "ONI" & lon %in% JumpBy(unique(lon), 2) &
                                  lat %in% JumpBy(unique(lat), 2)]) +
   map.SH +
   scale_s_map() +
   scale_fill_gradient2(breaks = AnchorBreaks(0, binwidth, 0),
                        guide = guide_colorstrip_bottom()) +
   coord_quickmap() +
   facet_grid(season~regressor)
```

```{r read-pp}
pp <- ReadNetCDF("DATA/precip.mon.mean.nc")
pp[, time := as.Date(time[1]), by = time]

qs.eof$right %>%
   .[, gh := gh/sd(gh), by = .(PC)] %>% 
   dcast(time ~ PC, value.var = "gh") %>%
   .[pp, on = "time"] %>%
   .[!is.na(PC1) & !is.na(qs.trim(time))] -> pp

pp <- pp[, pp.a := Anomaly(precip), by = .(lon, lat, month(time))]
# pp[, pp.p := precip/mean(precip), by = .(lon, lat, month(time))]
```

```{r calc-pp.regr}
pp[!is.na(qs.trim(time)), 
   FitLm(pp.a, PC1, PC2, se = TRUE),
   by = .(lon, lat, season = qs.trim(time))] %>% 
   .[regressor != "mean"] -> pp.regr
```

```{r pp-regr, fig.cap = "Regression between precipitation and PCs"}
binwidth <- 0.15

ggplot(pp.regr, aes(lon, lat)) +
   geom_contour_fill(aes(z = estimate), breaks = AnchorBreaks(0, binwidth, 0)) +
   geom_contour3(aes(z = sign(estimate)*as.numeric(abs(estimate) > se*1.6)),
                 breaks = c(-0.5, 0.5), circular = "x") +
   stat_subset(aes(subset =  abs(estimate) > se*1.6), geom = "point",
               alpha = 0.5, color = "black", size = 0.05,
               data = pp.regr[lon %in% JumpBy(unique(lon), 2) &
                                 lat %in% JumpBy(unique(lat), 2)]) +
   map.SH +
   scale_s_map() +
   # scale_fill_distiller(palette = "BrBG",
   #                      guide = guide_colorstrip_bottom(),
   # breaks = AnchorBreaks(0, binwidth, 0)) +
   scale_fill_divergent(guide = guide_colorstrip_bottom(),
                        low = "#8C510A", high = "#01665E",
                        breaks = AnchorBreaks(0, binwidth, 0)) +
   # ggalt::coord_proj("+proj=wintri") +
   coord_quickmap() +
   facet_grid(season~regressor)
```

```{r read-temp}
t <- ReadNetCDF("DATA/air.mon.mean.nc", subset = list(level = 1000))
t[, time := as.Date(time[1]), by = time]


qs.eof$right %>%
   .[, gh := gh/sd(gh), by = .(PC)] %>% 
   dcast(time ~ PC, value.var = "gh") %>%
   .[t, on = "time"] %>%
   .[!is.na(PC1) & !is.na(qs.trim(time))] -> t

t <- t[, air.a := Anomaly(air), by = .(lon, lat, month(time))]
```

```{r calc-t.regr}
t[!is.na(qs.trim(time)), 
  FitLm(air.a, PC1, PC2, se = TRUE),
  by = .(lon, lat, season = qs.trim(time))] %>% 
   .[regressor != "mean"] -> t.regr
```


```{r t-regr, fig.cap = "Regression between precipitation and PCs"}
binwidth <- 0.15

ggplot(t.regr, aes(lon, lat)) +
   geom_contour_fill(aes(z = estimate), breaks = AnchorBreaks(0, binwidth, 0)) +
   geom_contour3(aes(z = sign(estimate)*as.numeric(abs(estimate) > se*2)),
                 breaks = c(-0.5, 0.5), circular = "x") +
   stat_subset(aes(subset =  abs(estimate) > se*1.6), geom = "point",
               alpha = 0.5, color = "black", size = 0.05,
               data = t.regr[lon %in% JumpBy(unique(lon), 2) &
                                lat %in% JumpBy(unique(lat), 2)]) +
   map.SH +
   scale_s_map() +
   # scale_fill_distiller(palette = "BrBG",
   #                      guide = guide_colorstrip_bottom(),
   # breaks = AnchorBreaks(0, binwidth, 0)) +
   scale_fill_divergent(guide = guide_colorstrip_bottom(),
                        limits = c(-1, 1),
                        oob = scales::squish,
                        breaks = AnchorBreaks(0, binwidth, 0)) +
   # ggalt::coord_proj("+proj=wintri") +
   coord_quickmap() +
   facet_grid(season~regressor)
```




```{r calc-mean-season}
mean.season <- memoise::memoise(function() {
   ncep <- ncep.f(vars = c("gh", "u", "v"), lat= -90:30)
   
   ncep.mean.season <- ncep[, lapply(.SD, mean),
                            by = .(lon, lat, lev, 
                                   season = qs.trim(month(time)))] %>% 
      .[!is.na(season)]
   
   # remove(ncep)
   
   ncep.mean.season[, zeta := Vorticity(u + v ~ lon + lat, cyclical = TRUE,
                                        sphere = TRUE),
                    by = .(lev, season)] %>%
      .[, zeta.dy := Derivate(zeta ~ lon + lat,
                              cyclical = c(FALSE, FALSE),
                              sphere = TRUE)[[2]],
        by = .(lev, season)] %>%
      .[, eta.dy := zeta.dy + f.dy(lat)]
   
   ncep.mean.season[, k := sqrt(eta.dy/u)*dx(180/pi, lat)]
   ncep.mean.season[, k.full := ifelse(is.na(k) | k > 10, -1, k)]
}, cache = memoise::cache_filesystem(".rcache"))
ncep.mean.season <- mean.season()
```

# Geopotential Fields

Lo anterior justifica el agrupamiento de los meses que viene.

<!-- ```{r gh-ncep, fig.class = "fullpage", fig.cap = "Z (mgp). Contornos cada 250 mgp (NCEP)."} -->
<!-- plot.levs <- c(200) -->
<!-- binwidth <- 30 -->
<!-- ncep.mean.season[, gh.z := Anomaly(gh), by = .(lat,lev, season)] -->
<!-- ggplot(ncep.mean.season[lev %in% plot.levs], aes(lon, lat)) + -->
<!--    geom_contour_fill(aes(z = gh.z), -->
<!--                      breaks = AnchorBreaks(0, binwidth, 0), -->
<!--                      binwidth = binwidth, circular = "x") + -->
<!--    geom_contour3(aes(z = gh.z), -->
<!--                  breaks = AnchorBreaks(0, binwidth, 0), -->
<!--                  binwidth = binwidth, circular = "x") + -->
<!--    map.SH + -->
<!--    geom_label_contour2(aes(z = gh.z), binwidth = binwidth, -->
<!--                        size = 3) + -->
<!--    scale_s_map() + -->
<!--     -->
<!--    scale_fill_divergent() + -->
<!--    facet_wrap( ~ season, ncol = 2) + -->
<!--    coord_quickmap() -->
<!-- ``` -->

```{r ghminus1-ncep, fig.cap = "Zonal anomaly of 200hPa geopotential field with zonal wavenumber 1 filtered out. Areas with zonal wind greater than 30 m/s are hatched."}
ncep.mean.season[, gh.z := Anomaly(gh), by = .(lat, lev, season)] %>% 
   .[, gh.1 := FilterWave(gh, 0:-1), by = .(lat, lev, season)] %>% 
   .[, gh.12 := FilterWave(gh, 0:-2), by = .(lat, lev, season)] 
ncep.mean.season <- ncep.mean.season 

ggplot(ncep.mean.season[lev == 200], aes(lon, lat)) +
   geom_contour_fill(aes(z = gh.1),
                     breaks = AnchorBreaks(0, 10, 0), circular = "x") +
   geom_contour_(aes(z = gh.1), gap = 0,
                 breaks = AnchorBreaks(0, 10, 0), circular = "x") +
   geom_contour_(aes(z = u), breaks = 30, gap = 0) +
   # stat_subset(aes(subset = u >= 30),
   # geom = "point", alpha = 0.5, size = 0.05) +
   stat_subset(aes(subset = u >= 30), geom = "point",
               alpha = 0.5, color = "black", size = 0.05) +
   map.SH +
   scale_fill_divergent(guide = guide_colorstrip_bottom(),
                        breaks = MakeBreaks(10)) +
   scale_s_map() +
   coord_quickmap() +
   facet_wrap(~season, ncol= 2)
```


```{r gh.1-cut, fig.cap = "Mean geopotential zonal anomaly with zonal wave 1 filtered out between 65°S and 35°S"}
binwidth <- 10
ggplot(ncep.mean.season[lat %between% cutlats, 
                        mean(gh.1), by =.(lon, lev, season)],
       aes(lon, lev)) +
   geom_contour_fill(aes(z = V1), breaks = AnchorBreaks(0, binwidth, 0),
                     circular = "x") +
   geom_contour3(aes(z = V1), breaks = AnchorBreaks(0, binwidth, 0),
                 circular = "x") +
   scale_y_level(breaks = lev.breaks) +
   scale_x_longitude() +
   scale_fill_divergent(breaks = AnchorBreaks(0, binwidth, 0),
                        guide = guide_colorstrip_bottom()) +
   
   coord_lonlev() +
   facet_wrap(~season, ncol = 2)
```


```{r ghminus2-ncep, fig.publish = FALSE, fig.cap = "Zonal anomaly of 200hPa geopotential field with zonal wavenumber 1 and 2 filtered out. Areas with stationary wave number less than 3 are shaded."}
## Figura para el doctorado.
ncep.mean.season[lev == 200] %>%
   copy(.) %>%
   .[, gh.minus := FilterWave(gh, 0:-2), by = .(lat, season)] %>%
   .[, k.full := ifelse(is.na(k), -1, k)] %>% 
   ggplot(aes(lon, lat)) +
   geom_contour_fill(aes(z = gh.minus),
                     breaks = AnchorBreaks(0, 10, 0), circular = "x") +
   stat_subset(aes(subset = k.full < 3 | !is.finite(k)), color = NA,
               fill = "gray50", alpha = 0.3, geom = "tile") +
   geom_contour3(aes(z = gh.minus),
                 breaks = AnchorBreaks(0, 10, 0), circular = "x") +
   geom_contour(aes(z = k.full), breaks = 3, color = "gray50", size = 0.3) +
   map.SH +
   scale_fill_divergent(guide = guide_colorstrip_bottom(),
                        breaks = MakeBreaks(10)) +
   scale_s_map() +
   
   coord_quickmap() +
   facet_wrap(~season, ncol= 2)
```

```{r gh.12-cut, fig.cap = "Mean geopotential zonal anomaly with zonal wave 1 and 2 filtered out between 65°S and 35°S"}
binwidth <- 10
ggplot(ncep.mean.season[lat %between% cutlats, mean(gh.12), by =.(lon, lev, season)],
       aes(lon, lev)) +
   geom_contour_fill(aes(z = V1), breaks = AnchorBreaks(0, binwidth, 0),
                     circular = "x") +
   geom_contour3(aes(z = V1), breaks = AnchorBreaks(0, binwidth, 0),
                 circular = "x") +
   scale_y_level(breaks = lev.breaks) +
   scale_x_longitude() +
   scale_fill_divergent(breaks = AnchorBreaks(0, binwidth, 0),
                        guide = guide_colorstrip_bottom()) +
   
   coord_lonlev() +
   facet_wrap(~season, ncol = 2)
```

# Streamfunction



```{r psi, fig.cap = "Mean streamfunction. "}
binwidth <- 0.002
breaks <- AnchorBreaks(0, binwidth, 0)(c(-0.015, 0.015))
ggplot(stream.mean.season, aes(lon, lat)) +
   geom_contour_fill(aes(z = psi.z*10^-9),
                     # breaks = AnchorBreaks(0, binwidth, 0),
                     breaks = breaks,
                     circular = "x") +
   geom_contour3(aes(z = psi.z*10^-9),
                 # breaks = AnchorBreaks(0, binwidth, 0),
                 breaks = breaks,
                 circular = "x") +
   geom_streamline(aes(dx = f.lon, dy = f.lat), 
                   skip = 3, circular = "x", L = 20, size = 0.3, 
                   min.dist = 10, arrow.length = 0.2, arrow.angle = 10) +
   map.SH +
   scale_s_map() +
   scale_size(range = c(0, 1)) +
   scale_fill_divergent(breaks = AnchorBreaks(0, binwidth, 0),
                        oob = scales::squish,
                        limits = c(-1, 1)*0.015,
                        guide = guide_colorstrip_bottom()) +
   facet_wrap(~season, ncol = 2) +
   coord_quickmap(ylim = c(-90, 20))
```


```{r psi.1, fig.cap = "Mean streamfunction with zonal wave 1 filtered out."}
binwidth <- 0.0015
limits <- c(-0.005, 0.005)
breaks <- AnchorBreaks(0, binwidth, 0)(limits)
copy(stream.mean.season) %>%
   .[, psi.z := FilterWave(psi, 0:-1),
     by = .(lat, season)] %>%
   .[, c("f.lon", "f.lat") := WaveFlux(.SD), by = season] %>%
   ggplot(aes(lon, lat)) +
   geom_contour_fill(aes(z = psi.z*10^-9),
                     # breaks = AnchorBreaks(0, binwidth, 0),
                     breaks = breaks,
                     circular = "x") +
   geom_contour3(aes(z = psi.z*10^-9),
                 # breaks = AnchorBreaks(0, binwidth, 0),
                 breaks = breaks,
                 circular = "x") +
   geom_streamline(aes(dx = f.lon, dy = f.lat), 
                   skip = 3, circular = "x", L = 20, size = 0.3, 
                   min.dist = 5, arrow.length = 0.2, arrow.angle = 10) +
   map.SH +
   scale_s_map() +
   scale_size(range = c(0, 1)) +
   scale_fill_divergent(breaks = AnchorBreaks(0, binwidth, 0),
                        oob = scales::squish,
                        limits = limits,
                        guide = guide_colorstrip_bottom()) +
   facet_wrap(~season, ncol = 2) +
   coord_quickmap(ylim = c(-90, 20))
```

```{r psi12, fig.cap = "Mean streamfunction with waves 1 and 2 filtered out."}
binwidth <- 0.001
limits <- c(-0.005, 0.005)
breaks <- AnchorBreaks(0, binwidth, 0)(limits)
copy(stream.mean.season) %>%
   .[, psi.z := FilterWave(psi, 0:-2),
     by = .(lat, season)] %>%
   .[, c("f.lon", "f.lat") := WaveFlux(.SD), by = season] %>%
   ggplot(aes(lon, lat)) +
   geom_contour_fill(aes(z = psi.z*10^-9),
                     # breaks = AnchorBreaks(0, binwidth, 0),
                     breaks = breaks,
                     circular = "x") +
   geom_contour3(aes(z = psi.z*10^-9),
                 # breaks = AnchorBreaks(0, binwidth, 0),
                 breaks = breaks,
                 circular = "x") +
   geom_streamline(aes(dx = f.lon, dy = f.lat), 
                   skip = 3, circular = "x", L = 20, size = 0.3, 
                   min.dist = 5, arrow.length = 0.2, arrow.angle = 10) +
   map.SH +
   scale_s_map() +
   scale_size(range = c(0, 1)) +
   scale_fill_divergent(breaks = AnchorBreaks(0, binwidth, 0),
                        oob = scales::squish,
                        limits = limits,
                        guide = guide_colorstrip_bottom()) +
   facet_wrap(~season, ncol = 2) +
   coord_quickmap(ylim = c(-90, 20))
```

# Fourier

```{r r2-ncep, fig.cap = "Amplitude of zonal wave 3 for each season defined in the text."}
rect.annotation <- data.frame(latmin = -65, latmax = -40,
                              levmin = 100, levmax = 700)
ncep.qs <- ncep.mean.season[, FitWave(gh, k = 3),
                            by = .(lat, lev, season)]

binwidth <- 5
ggplot(ncep.qs[lat <= 0], aes(lat, lev)) +
   geom_contour_fill(aes(z = amplitude), binwidth = binwidth) +
   geom_contour_(aes(z = amplitude), binwidth = binwidth, 
                 gap = 1) +
   surface +
   geom_index.region(rect.annotation) +
   scale_fill_viridis_c(guide = guide_colorstrip_bottom(),
                        limits = c(0, 50),
                        breaks = MakeBreaks(binwidth)) +
   scale_y_level(breaks = lev.breaks) +
   
   scale_x_latitude(name = "latitude", trans = "reverse",
                    ticks = 15) +
   coord_latlev() +
   facet_wrap(~ season, ncol = 2)
```

```{r clac-stationarity}
ncep[lat %inrange% range(region$lat) &
        lev %inrange% range(region$lev), 
     mean(gh), by = .(lat, lon, lev, season = qs.season(time))] %>% 
   .[, FitWave(V1, k = 3), by = .(lat, lev, season)] -> mean.qs

ncep %>%
   .[lat %inrange% range(region$lat) &
        lev %inrange% range(region$lev), 
     FitWave(gh, k = 3),
     by = .(lat, lev, time)] %>%
   .[, .(MA = mean(amplitude)), by = .(lat, lev, season = qs.season(time))] %>%
   .[mean.qs[, .(lat, lev, season, AM = amplitude)], on = c("lat", "lev", "season")] %>% 
   .[, stationarity := AM/MA] -> stationarity
```


```{r stationarity-table}
knitr::kable(stationarity[,
                          .(stationarity = mean(stationarity),
                            MA = mean(MA),
                            AM = mean(AM)), by = season][order(season)],
             digits = 2, caption = "Stationarity, seasonal mean monthly amplitude (MA) and amplitude of the seasonal mean (AM) zonal wave 3 for each season defined in the text.")
```



# Cosas para hacer

- Usar datos de ERA
- Período más largo (1980-20017?)
- ¿Eliminar tendencia lineal? (Hobbs y Raphael)
- ¿Cómo poner wavelets?


# Epílogo:

¿Qué pasa si hago EOF filtrando también la tendencia lineal?

```{r eof4-ncep2, fig.cap = "First 4 EOFs derived from the 200hPa geopotential zonal anomaly field between 30°S and 80°S with zonal wave 1 and linear trend filtered out"}
region <- expand.grid(lat = c(-65, -40),
                      lev = c(100, 700))
lats.eof <- c(-80, -30)
copy(ncep[lev == 200 & lat %between% lats.eof]) %>%
   .[, gh.minus := FilterWave(gh, k = 0:-1), by = .(lat, time, lev)] %>% 
   .[, gh := gh.minus*sqrt(cos(lat*pi/180))] %>%
   .[, gh := resid(.lm.fit(cbind(1, time), gh)), 
     by = .(lon, lat, month(time))] %>% 
   EOF(data = ., gh ~ lon + lat | time, n = 1:20, B = 100) -> qs.eof2

# qs.eof$left[PC == "PC2", gh := -gh]
# qs.eof$right[PC == "PC2", gh := -gh]

pc.lab <- with(qs.eof$sdev, setNames(paste0(PC, " - ", round(r2*100), "%"), PC))

ggplot(qs.eof$left[as.numeric(PC) %in% 1:3], aes(lon, lat)) +
   geom_contour_fill(aes(z = gh), circular = "x",
                     breaks = AnchorBreaks(0, 0.01, 0)) +
   geom_contour3(aes(z = gh), circular = "x",
                 breaks = AnchorBreaks(0, 0.01, 0)) +
   map.SH +
   geom_hline(yintercept = lats.eof, linetype = 2) +
   scale_s_map() +
   scale_fill_divergent(breaks = AnchorBreaks(0, 0.01, 0),
                        guide = guide_colorstrip_bottom()) +
   coord_quickmap(ylim = c(-90, -20)) +
   facet_wrap(~PC, labeller = labeller(PC = pc.lab))
```

```{r}
# n <- length(unique(ncep$time))
qs.eof$sdev %>% 
   # .[, se := sqrt(2/n)*sd] %>% 
   ggplot(aes(as.numeric(PC), sd)) +
   geom_point() +
   geom_line() +
   geom_errorbar(aes(ymin = sd - 2*se, ymax = sd + 2*se),
                 width = 0.3) +
   scale_x_continuous(breaks = 1:20, minor_breaks = NULL)
```


```{r pcodd, fig.cap = "Linear combination of PC1 and PC3 (PCodd) and of PC2 and PC4 (PCeven)"}
qs.eof$left %>% 
   .[qs.eof$sdev, on = "PC"] %>% 
   .[, .(PCodd = (gh*sd)[PC == "PC1"] - (gh*sd)[PC == "PC3"], 
         PCeven = (gh*sd)[PC == "PC2"] + (gh*sd)[PC == "PC4"]),
     keyby = .(lon, lat) ] %>%
   melt(id.vars = c("lon", "lat")) %>% 
   ggplot(aes(lon, lat)) +
   geom_contour_fill(aes(z = value), breaks = AnchorBreaks(0, 250, 0)) +
   geom_contour2(aes(z = value), breaks = AnchorBreaks(0, 250, 0)) +
   map.SH +
   scale_s_map() +
   scale_fill_divergent(breaks = AnchorBreaks(0, 250, 0),
                        guide = guide_colorstrip_bottom()) +
   coord_quickmap(ylim = c(-90, -20)) +
   facet_wrap(~variable)
```

```{r fourier-eof2, fig.cap = "Fourier decomposition by latitude of each EOF."}
qs.eof$left[, FitWave(gh, 2:4), by = .(lat, PC)]  %>%
   ggplot(aes(lat, amplitude)) +
   geom_line(aes(color = paste0("QS", k))) +
   scale_x_latitude(trans = "reverse", ticks = 15) +
   scale_y_continuous() +
   scale_color_brewer(palette = "Set1") +
   coord_fixed(500) +
   facet_wrap(~PC)
```



```{r PC1-PC2-trim2, fig.cap = "Monthly mean values for each PC. Colors and shapes divide months into 5 'seasons'."}
qs.eof$right[, .(value = mean(gh)), by = .(PC, month(time))] %>%
   dcast(... ~ PC) %>%
   ggplot(aes(PC1, PC2)) +
   # xlab("PC 1") + ylab("PC 2") +
   geom_cross(color = "gray50") +
   ggforce::geom_link2(aes(color = qs.season(month),
                           group = 1),
                       alpha = 0.5) +
   geom_point(aes(color = qs.season(month), shape = qs.season(month)),
              size = 3)+
   ggrepel::geom_text_repel(aes(label = month.abb[month])) +
   scale_color_brewer(palette = "Set1", na.translate = F) +
   scale_shape_circlefill() +
   guides(color = "none", shape = "none") +
   coord_equal()
```

```{r cluster2, fig.cap = 'NO VA. Clústering jerárquico. Cortando en ~0.03 se obtienen 4 clusters, y un 5to separando Abril de ASO por continuidad temporal. Confirma la validez del agrupamiento "a ojo"'}
qs.eof$right[PC %in% c("PC1", "PC2"), .(value = mean(gh)), by = .(PC, month(time))] %>%
   dcast(... ~ PC) %>% 
   .[, -1] %>% 
   dist() %>%
   hclust() %>% 
   plot(labels = month.abb) 
```


```{r lm-gh, fig.cap = "Linear regrssions of geopotential height (full) and geopotential height with zonal wave1 removed (no.1)"}
copy(ncep[lev == 200]) %>% 
   .[, gh.1 := FilterWave(gh, 0:-1), by = .(lat, lev, time)] %>%
   .[, FitLm(gh.1, seq_len(.N), se = TRUE), by = .(lat, lon, month(time))] %>% 
   .[regressor != "mean"] %>%
   ggplot(aes(lon, lat)) +
   geom_contour_fill(aes(z = estimate), circular = "x",
                     breaks = AnchorBreaks(0, 0.5, 0)) +
   geom_contour2(aes(z = estimate), circular = "x",
                 breaks = AnchorBreaks(0, 0.5, 0))+
   stat_subset(aes(x = Jump(lon, 2),
                   y = Jump(lat, 2),   
                   subset = abs(estimate) > se*2), geom = "point", 
               size = 0.1) +
   map.SH +
   scale_s_map() +
   scale_fill_divergent() +
   coord_quickmap() +
   facet_wrap(~month, labeller = labeller(month = month.abb),
              ncol = 2) +
   labs(title = "Tendencai lineal mensual de altura geopotential filtrada")


# coord_quickmap(ylim = c(-60, -30), xlim = c(280, 300)) 
```

```{r}
copy(ncep[lev == 200]) %>% 
   .[, gh.1 := FilterWave(gh, 0:-1), by = .(lat, lev, time)] %>%
   .[, FitLm(gh.1, seq_len(.N), se = TRUE), by = .(lat, lon, month(time))] %>% 
   .[regressor != "mean"] %>% 
   .[, sd(estimate), by = .(lon, lat)] %>% 
   ggplot(aes(lon, lat)) +
   geom_contour_fill(aes(z = V1), circular = "x") +
   scale_fill_viridis_c() +
   map.SH +
   scale_s_map() +
   coord_quickmap()

```

La tendencia lineal del geopotencial total es positiva al norte de 60°S y negativa al sur. Probablemente represente la migración de la rama descendente de la celda de Hadley. Sin embargo, existen diferencias zonales en esta tendencia que son consistentes con la tendencia lineal del campo sin la onda 1. Curiosamente, el patrón de esta tendencia es de una onda 3, con decrecimiento del geopotencial sobre el sur de sudamérica y crecimiento al este y al oeste del continente. 

La zona de decrecimiento del geopotencial es cerana a la zona de máximo de geopotencial de la onda 3. Entonces la tendencia lineal estaría reduciendo la amplitud de la onda 3 en esa zona (supongo que eso se puede confirmar o no calculando la amplpitud usnado wavelets y mostrando la tendencia lineal). Será que al restarla, la amplitud de la onda 3 aumenta en esa zona y entonces aparece como un patrón de variabilidad más importante? 

```{r}
ncep[lat == -45 & lev == 200] %>% 
   # .[, gh := Anomaly(gh), by = .(lon, lat, month(time))] %>%
   .[, gh.1 := FilterWave(gh, 0:-1), by = .(lat, time)] %>%
   .[lon == 290] %>% 
   ggplot(aes(time, gh.1)) + 
   geom_line() + 
   geom_smooth(method = "lm") +
   labs(title = "GH Filtrada", subtitle = "70°O 45°S")
# facet_wrap(~month(time))
```

Queda la duda de si es conveniente restar la tendencia o no. 

```{r}
gh.slope[variable == "full",
         FitWave(value, k = 1:4), by = .(variable, lat)] %>% 
   ggplot(aes(lat, amplitude)) +
   geom_line(aes(color = factor(k))) +
   facet_wrap(~variable)
```






```{r lm-gh, fig.cap = "Linear regrssions of geopotential height (full) and geopotential height with zonal wave1 removed (no.1)"}
binwidth <- 0.5
copy(ncep[lev == 200]) %>% 
   .[, gh.1 := FilterWave(gh, 0:-1), by = .(lat, lev, time)] %>%
   .[!is.na(qs.trim(time)), .(gh = mean(gh.1)), 
     by = .(lon, lat, year(time), season = qs.trim(time))] %>%
   .[, FitLm(gh, year, se = TRUE), by = .(lat, lon, season)] %>% 
   .[regressor != "mean"] %>%
   ggplot(aes(lon, lat)) +
   geom_contour_fill(aes(z = estimate), circular = "x",
                     breaks = AnchorBreaks(0, binwidth, 0)) +
   geom_contour2(aes(z = estimate), circular = "x",
                 breaks = AnchorBreaks(0, binwidth, 0))+
   stat_subset(aes(x = Jump(lon, 2),
                   y = Jump(lat, 2),   
                   subset = abs(estimate) > se*2), geom = "point", 
               size = 0.1) +
   map.SH +
   scale_s_map() +
   scale_fill_divergent() +
   coord_quickmap() +
   facet_wrap(~season, labeller = labeller(month = month.abb),
              ncol = 2) +
   labs(title = "Tendencia lineal trimestral de altura geopotential filtrada")
```