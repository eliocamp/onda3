---
title: "32-goyal"
author: "Elio Campitelli"
output: 
   bookdown::html_document2:
         base_format: tufte::tufte_html 
link-citations: yes 
bibliography: goyal.bib
---

```{r setup, include=FALSE}
# Notification
start.time <- unclass(Sys.time())
min.time <- 10
knit_doc <- knitr::knit_hooks$get("document")


knitr::knit_hooks$set(document = function(x) {
   took <- unclass(Sys.time()) - start.time
   if (unclass(Sys.time()) - start.time >= min.time) {
      notify("Done knitting!", 
             paste0("Took ", round(took), " seconds"),
             time = 5)
   }  
   knit_doc(x)
})


name <- tools::file_path_sans_ext(knitr::current_input())
knitr::opts_chunk$set(
   echo = FALSE,
   fig.path = paste0("fig/", name, "/"),
   message = FALSE,
   warning = FALSE,
   cache = TRUE, 
   cache.lazy = FALSE,
   cache.extra = 41,
   cache.path = paste0("cache/", name, "/")
)
# knitr::opts_chunk$set(fig.width = 13, 
#                       fig.height = 7)
source(here::here("scripts", "helperfun.R"))
source(here::here("scripts", "maps.R"))

library(metR)
library(data.table)
library(ggplot2)
library(magrittr)
library(patchwork)
library(here)
library(tagger)
library(kableExtra)

theme_set(theme_elio())
guide_colorstrip_bottom <- function(width = 25, height = 0.5, ...) {
   guide_colorstrip(title.position = "top", title.hjust = 0.5,
                    barheight = height,
                    barwidth = width, ...)
}
setnames <- function(x, ...) {
   names <- c(...)
   # print(names)
   data.table::setnames(x, unname(names), names(names))
}

lapply_p <- function(x, FUN, ...) {
   pb <- progress::progress_bar$new(total = length(x), 
                                    format = "[:bar] :percent - :eta")
   
   FUN_pb <- function(x, ...) {
      pb$tick()
      FUN(x, ...)
   }
   
   lapply(x, FUN_pb, ...)
}


geom_coords <- function() {
   list(
      no_grid,
      annotate("segment",
               y = seq(-90, 0, by = 15),
               yend = seq(-90, 0, by = 15),
               x = 0,
               xend = 360,
               size = 0.1, alpha = 0.5),
      
      annotate("segment",
               x = seq(0, 360 - 30, by = 30),
               xend =  seq(0, 360 - 30, by = 30),
               y = -90 + 15,
               yend = Inf,
               size = 0.1, alpha = 0.5),
      shadowtext::geom_shadowtext(data = data.frame(x = 0, y = seq(-90 + 15, 0, 
                                                                   by = 15)),
                                  aes(x, y, label = LatLabel(y)), size = 1.5, 
                                  alpha = 0.7,
                                  colour = "black",
                                  bg.colour = "white")
      
   )
}
no_grid <- theme(panel.grid = element_blank())
coord_polar <- function(ymax = -20, ...) {
   
   x <- c(seq(0, 360, length.out = 40), 
          seq(360, 0, length.out = 40), 
          0)
   y <- c(rep(ymax, length.out = 40), 
          rep(60, length.out = 40), 
          ymax)
   
   cbind(x, y) %>% 
      list() %>% 
      sf::st_polygon() %>% 
      sf::st_sfc(crs = "+proj=latlong") -> white
   
   list(
      geom_sf(data = white, inherit.aes = FALSE, 
              fill = "white", 
              colour = "white", size = 2),
      coord_sf(ylim = c(-90, ymax), 
               lims_method = "box",
               crs = "+proj=laea +lat_0=-90",
               default_crs = "+proj=longlat",
               label_axes =  "----", ...)
   )
}

periodic_lon <- function(x){
   ggperiodic::periodic(x, lon = c(0, 360))
}

label_placer_vertical <- function(x_ref, rot_adjuster = isoband::angle_halfcircle_bottom()) {
   force(x_ref)
   
   metR:::as_placer(
      function(x, y) {
         which(x %~% x_ref)
      }, 
      rot_adjuster = rot_adjuster
   )
}

label_experiment <-  setNames(c("aqua", "SA", "SAtropics", 
                                "Africatropics", "Australiatropics",
                                "tropics", "control", "ERA5"), 
                              c("Aquaplanet", "Complete South America", 
                                "Tropical South America", 
                                "Tropical Africa", "Tropical Australia",
                                "Realistic Tropics", "Control", "ERA5"))

scale_color_exp <- function(aesthetics = c("colour"), ...){
   labels <- names(label_experiment)
   
   scale_color_manual("Experimentos",
                      values = setNames(c(RColorBrewer::brewer.pal(6, "Dark2"), "black", "#3689e6"),
                                        labels), aesthetics = aesthetics,
                      ...)
   
}


scale_size_exp <- function() {
   values <- setNames(c(rep(0.5, length(label_experiment)-2), 1, 1), 
                      names(label_experiment))
   scale_size_manual(values = values, 
                     guide = "none") 
}

keep_lat <- function(data, lat = -55) {
   which_lat <- lat
   data[, .SD[lat %~% which_lat], by = exp] 
}


sink <- capture.output(old <- sf::sf_use_s2(FALSE))
```

Exploración de los datos de @goyal2021a.

En el paper hacen simulaciones globales con distintos continentes y ven qué le pasa a la onda 3.
En el repositorio con los datos están disponibles las simulaciones:

-   Aquaplanet: sin ningún continente
-   Sudamérica completa: sólo está sudamérica.
-   Sudamérica tropical: sólo está sudamérica entre 10ºS y 10ºN.
-   África tropical: sólo está África entre 10ºS y 10ºN.
-   Australia tropical: sólo está Austrlaia entre 10ºS y 10ºN.
-   Trópicos realistas: Están todos los continentes entre 10ºS y 10ºN.

## Ondas zonales

```{r read-experiments}
files <- list.files("DATA/goyal/Geopotential_height/", full.names = TRUE)

files_data <- strsplit(basename(files), "_") 


datagoyal <- transpose(files_data) %>% 
   as.data.table() %>% 
   data.table::setnames(., colnames(.), c("var", "exp", "lev")) %>% 
   .[, file := files] %>% 
   .[lev != "850hPa.nc"] %>% 
   .[, ReadNetCDF(file, vars = c(hgt = "Z3"), 
                  subset = list(lat = c(-90, 20), 
                                lev = 300))[, lev := as.integer(lev)], by = exp] %>%
   normalise_coords() 
```

```{r read-obs}
era5 <- ReadNetCDF("~/DATOS/reanalisys/ERA5/era5.mon.mean.nc", vars = c(hgt = "z_0001"), 
                   subset = list(level = 300, 
                                 latitude = c(-90, 20))) %>% 
   normalise_coords() %>% 
   .[, hgt := hgt/9.8] %>% 
   na.omit() %>% 
   .[, exp := "ERA5"]

datagoyal <- rbind(era5, datagoyal, use.names = TRUE)
rm(era5)


datagoyal[, exp := factor(exp, 
                          levels = label_experiment, 
                          labels = names(label_experiment))] %>% 
   setkey(exp, time, lev, lat, lon)

```

## Control vs ERA5

```{r}

```

La Figura \@ref(fig:repr-fig2) reproduce la Figura 2 del @goyal2021a.
Muestra las ondas 3 anuales medias para los 100 años de cada simulación junto con la onda 3 media total en rojo.

```{r repr-fig2, fig.cap="Onda 3 de cada simulación en 55ºS. En rojo, la onda media para cada mes."}
datagoyal %>% 
   keep_lat() %>% 
   .[, hgt3 := FilterWave(hgt, 3), by = .(exp, time)] %>% 
   .[, .(hgt3 = mean(hgt3)), by = .(lon, exp, time)] %>% 
   ggplot(aes(lon, hgt3)) +
   geom_line(aes(group = time), alpha = 0.1) +
   geom_line(data = ~.x[, .(hgt3 = mean(hgt3)), by = .(lon, exp, month(time))], color = "red",
             aes(group = month)) +
   scale_x_longitude() +
   # coord_cartesian(ylim = c(-50, 50)) +
   facet_wrap(~exp)
```

Se reproduce bien esto que los continentes están bloqueando la fase de la onda 3, pero que la amplitud media de la onda 3 es grande en todas.
En particular, la simulación con Australia tropical tiene una onda 3 enorme, pero en cualquier lado.
Pero aún el aquaplanet tiene onda 3 no despreciable.
Comparando la corrida control con ERA5 se ve que la Control tiene una onda 3 significativamente más débil y, parecería, menos estacionaria.
En particular, la corrida control tiene un ciclo anual particularmente extremo; es decir, que la fase de la onda media varía muchísimo a lo largo del año.

La distribución meridional de la amplitud media de las ondas (Figura \@ref(fig:amplitud-lat)) detalla esto para otras latitudes.
La Control reproduce bien la distribución de las ondas, pero para ondas 2 y 3 la amplitud es menor.

```{r amplitud-lat, fig.cap = "Amplitud media anual de las ondas zonales por latitud."}
mean_amplituide <- datagoyal %>% 
   .[, FitWave(hgt, 1:4), by = .(lat, exp, time)] %>% 
   .[, mean(amplitude), by = .(lat, k, exp)]

amplitude_mean <- datagoyal %>% 
   .[, mean(hgt), by = .(lon, lat, exp)] %>% 
   .[, FitWave(V1, 1:4), by = .(lat, exp)]

mean_amplituide %>%  
   .[lat <= -20] %>% 
   ggplot(aes(lat, V1)) +
   geom_line(aes(color = exp, size = exp)) +
   facet_wrap(~k) +
   scale_color_exp() +
   scale_size_exp() +
   coord_flip() +
   scale_y_continuous("Amplitud media anual de las ondas zonales") +
   scale_x_latitude()
```

Aquaplanet tiene una amplitud reducida en las ondas 1 a 3 en comparación a control y las experimentales tienen una distribución muy parecida en todas las ondas.
En la onda 3, la diferencia entre corridas experimentales es mínimas.
En la onda 1, las corridas experimentales tienen el máximo más al sur.

```{r amplitud-media-lat, fig.cap = "Amplitud de las ondas zonales medias anuales por latitud."}
amplitude_mean %>%  
   .[lat <= -20] %>% 
   ggplot(aes(lat, amplitude)) +
   geom_line(aes(color = exp, size = exp)) +
   facet_wrap(~k) +
   scale_color_exp() +
   scale_size_exp() +
   coord_flip() +
   scale_y_continuous("Amplitud de las ondas zonales medias anuales") +
   scale_x_latitude()
```

La Figura \@ref(fig:amplitud-media-lat), por su parte, muestra la amplitud de la onda media.
La corrida control es bastante similar a ERA5 en las ondas 1, 2 y 4, pero subestima la amplitud de la onda 3 considerablemente en latitudes medias.
Las corridas experimentales tienen una amplitud de la onda 3 media mayor que aquaplanet, salvo por la corrida de australia tropical; ambas corridas tienen prácticamente nula amplitud de las ondas medias.
Los otros experimentos tienen amplitudes comparables entre sí y algo mayores que la corrida control.

La Figura \@ref(fig:estacionariedad) cuantifica la estacionariedad de la onda 3 con respecto a la media mensual.

```{r estacionariedad, fig.cap = "Estacionariedad de la onda 3 para cada experimento y ERA5 (línea negra)."}

stationarity <- function(amplitude, phase, k, group = 1) {
   data <- data.table(amplitude = amplitude, 
                      phase = phase, 
                      k = k,
                      group = group)
   
   # data[, mean_phase := mean.phase(amplitude, phase, k), by = .(group, k)]
   
   data[, c("ma", "mp") := mean.wave(amplitude, phase, k)[c("amplitude", "phase")], by = .(group, k)]
   
   data[, mean(cos(k*(phase - mp))*amplitude)/mean(amplitude)]
}

stat <- datagoyal %>%  
   .[, FitWave(hgt, k = 1:4), by = .(lat, exp, time)] %>% 
   .[, c("ma", "mp") := mean.wave(amplitude, phase, k)[c("amplitude", "phase")], 
     by = .(lat, exp, month(time), k)] %>% 
   .[, .(
      mean_amplitude = mean(amplitude),
      amplitude_mean = mean(ma),
      stationarity = mean(cos(k*(phase - mp))*amplitude)/mean(amplitude)), 
     by = .(lat, exp, k)]

stat %>%
   .[k %in% 3] %>%
   .[is.finite(stationarity)] %>%
   .[lat <= -20]  %>%
   ggplot(aes(lat, stationarity)) +
   geom_line(aes(color = exp, size = exp)) +
   coord_flip() +
   scale_color_exp() +
   scale_size_exp() +
   # scale_y_continuous(limits = c(0, 1)) +
   scale_x_latitude() +
   facet_wrap(~k) 
```

Para esta medida, la corrida control tiene un valor comparable --aunque algo menor-- a ERA5 en latitudes medias pero mayor en latitudes altas.
El máximo en \~45º es menos marcado que en ERA5, algo que también se observa en las corridas experimentales.
Éstas últimas tienen una estacionariedad considerablemente menor que la observada, aunque la forma es más razonable en altas latitudes.

Tanto el Aquaplanet como la simulación con Australia tropical tienen una estacionariedad casi nula.
De hecho, esta segundaa simulación tiene aún menos estacionariedad en latitudes medias que la primera.
Luego, el resto de las simulaciones con algún continente tienen una estacionariedad más alta.
Aunque todas las simulaciones tienen menos estacionariedad que la observada en ERA5 o la control.

La diferencia entre simulaciones se encuentra principlamente en la en la estacionariedad de la onda.

La Figura \@ref(fig:resumen) resume todo esto, mostrando la amplitud media de las ondas zonales en el eje horizontal y la estacionariedad en el eje vertical.
Las líneas negras marcan los valores de amplitud de las onda media correspondiente.

```{r resumen, fig.cap ="Amplitud media de las ondas y estacionariedad de cada experimento y de ERA5 (punto negro) para los números de onda 1 a 4. Línes de contorno marcan la amplitud de la onda media", fig.with = 6, fig.height= 7}

N <- 80
stationarity_grid <- stat %>% 
   keep_lat() %>% 
   .[, CJ(mean_amplitude = seq(min(mean_amplitude)*.8, max(mean_amplitude)*1.1, length.out = N),
          stationarity = seq(0, 1, length.out = N)),
     by = k] 

stat %>% 
   keep_lat() %>% 
   ggplot(aes(mean_amplitude, stationarity)) +
   geom_contour2(data = stationarity_grid,  family = hrbrthemes::font_rc,
                 aes(z = stationarity*mean_amplitude, label = ..level..), global.breaks = FALSE,
                 label.placer = label_placer_fraction(0.8)) +
   ggrepel::geom_text_repel(aes(label = exp, color = exp), bg.colour = "white") +
   geom_point(aes(fill = exp), colour = "white", shape = 21, size = 4) +
   guides(color = "none") +
   scale_x_continuous("Amplitud media anual de las ondas zonales") +
   scale_y_continuous("Estacionariedad") +
   scale_color_exp(aesthetics = c("colour", "fill")) +
   facet_wrap(~k, scales = "free") 
```

En esta figura se resume también el comportamiento de las distintas ondas zonales.
Para la onda 1, la corrida control es muy similar a ERA5 tanto en amplitud media como en estacionariedad.
Las corridas experimentales varían tanto en amplitud media de las ondas como en la amplitud de la onda media.
Y aunque ninguno de los experimentos se acercan a las amplitudes observadas, la estacionariedad de la simulación con trópicos realistas (\~0.7) es bastante alta y cercana a la observada.

En la onda 2 la corrida control también está relativamente cerca de ERA5.
Los experientos tienen también una estacionariedad realista pero un amplitud media sobreestimada.

Para la onda 4 todas las simulaciones, incluyendo a la control subestiman la amplitud media y la mayoría tiene menos estacionariedad que ERA5.
Sin embargo, esta onda tiene poca estacionaridad de por sí.

Finalmente, para la onda 3 la corrida control tiene la estacionariedad cercana a ERA5 pero menos amplitud.
Todas las simulaciones experimentales tienen una amplitud media similar, pero varían bastante en estacionariedad.

Esto es consistente con lo que vi en la tesis de licenciatura.
Las condiciones de superficie tienen el rol principalmente de cambiar la estacionariedad de la onda, no tanto la amplitud.
Las ondas se excitan aún en ausencia de continentes.
Poner un poquito de continente (Australia tropical) excita aún más, pero no es suficiente para bloquear la fase significativamente.

## ¿Sirve fourier?

Una pregunta es qué tan bien funciona el paradigma de Fourier en estas simulaciones.

```{r cors}
periodic_roll_fun <- function(x, y = NULL, width, fun) {
   x1 <- rep(x, 3)
   keep <- (length(x)+1):(2*length(x))
   
   half_width <- (width - 1)/2
   
   
   if (!is.null(y)) {
      y1 <- rep(y, 3)   
      result <- fun(x1, y1, width = width)
   } else {
      result <- fun(x1, width = width)
   }
   
   result <- data.table::shift(result, n = -half_width)
   
   result[keep]
}


roll_fourier <- function(value, lon, time, lon_width, k) {
   lon_halfwidth <- lon_width/2
   lons <- unique(lon)
   w <- sum(lons  %between% (180 + c(-lon_halfwidth, lon_halfwidth)))
   
   
   data <- list(time = time,
                lon = lon,  
                value = value)
   setDT(data)
   setkey(data, time)
   
   
   # Anomalías zonales
   data[, ":="(fourier = metR::FilterWave(value, k),
               value = value - mean(value),
               value_sd = sd(value)), by = time]
   # data[, value := value/mean(value_sd), by = .(month(time))]
   set(data, NULL, "value", data$value/mean(data$value_sd))
   set(data, NULL, "value_sd", NULL)
   
   # Ondas zonales y medias
   data[, ":="(fourier_mean = mean(fourier),
               value_a      = value - mean(value)), 
        by = .(lon, month(time))]
   
   
   data[, ":="(fourier = fourier/max(fourier),
               fourier_mean = fourier_mean/max(fourier_mean),
               fourier_a = (fourier - fourier_mean)/max(fourier - fourier_mean)), 
        by = time]
   
   
   data[, ":="(cov_zw = periodic_roll_fun(value*fourier, width = w,
                                          fun = roll::roll_sum), 
               cov_qs = periodic_roll_fun(value*fourier_mean, width = w, 
                                          fun = roll::roll_sum),
               cov_a = periodic_roll_fun(value_a*fourier_a, width = w,
                                         fun = roll::roll_sum)
   ),
   by = .(time)]
   
   list(
      proj = data$cov_zw,
      proj_mean = data$cov_qs,
      proj_a = data$cov_a
   )
}

```

```{r}
datagoyal[, c("cov_zw", "cov_qs", "cov_a") := roll_fourier(hgt, lon, time, 360/3, 3), 
          by = .(exp, lat)]
```

Se puede calcular la proyección de las anomalías zonales de altura geopotencial estandarizadas sobre la onda 3 asociada ese campo en gajos de 60º de longitud de ancho.
Esto da una idea de qué regiones están alineadas y "aportan" más con la onda 3.

```{r cov-zw-media, fig.cap = "Proyección media de altura geopotential en la dirección de la onda 3 tomando gajos de 60º de ancho.", fig.height=5.5, fig.width=10, fig.fullwidth = TRUE}
m <- datagoyal %>%
   .[, mean(cov_zw), by = .(exp, lat, lon)]
m %>% 
   periodic_lon() %>% 
   ggplot(aes(lon, lat)) +
   geom_contour_fill(aes(z = V1)) +
   geom_contour2(aes(z = V1, label = ..level..), family = hrbrthemes::font_rc,
                 label.placer = label_placer_flattest()) +
   geom_qmap() +
   # geom_coords() +
   # coord_polar(ymax = 20) +
   coord_sf(ylim = c(-90, 20), expand = FALSE,
            # crs = "+proj=longlat +pm=180 +over",
            default_crs = "+proj=longlat +lon_wrap=180 +over") + 
   labs(x = NULL, y = NULL) +
   scale_fill_divergent(guide = "none") +
   facet_wrap(~exp, ncol = 3)
```

La Figura \@ref(fig:cov-zw-media) muestra la proyección media.
La corrida control es bastante similar a ERA5.
Hay un máximo en latitudes medias que a su vez tiene un máximo al sur del Índico que se va a altas latitudes en el pacífico.
En los trópicos, hay un máximo bien marcado en la zona del Pacífico central.

Por otro lado, Aquaplanet tiene un campo casi constante, indicando que no hay ninguna región preferencial donde la altura geopotential covaríe con la onda 3.
El hecho de que no haya una banda más o menos homogénea de latitudes con valores altos indica que la onda 3 en esta simulación está bastante localizada; es decir que no es una onda hemisférica.

Las otras simulaciones tienen una banda de valores altos entre 40ºS y 60ºS pero con menor localización.
Lo que es interesante es que en las regiones tropicales hay valores altos sobre las áreas con continentes en cada simulación, lo cual es consistente con que ésta son las fuente de las ondas.

Más relevante, quizás, es evaluar la misma proyección que antes pero sobre la onda 3 climatológica.
La Figura \@ref(fig:cov-qs-media) muestra la proyección media de la altura geopotencial en la dirección de la onda climatológica 3 de cada mes.

(ref:cov-qs-media-cap) Igual que Figura \@ref(fig:cov-zw-media) pero en la dirección de la onda 3 climatológica.

```{r cov-qs-media, fig.cap = "(ref:cov-qs-media-cap)",  fig.height=5.5, fig.width=10, fig.fullwidth = TRUE}
datagoyal %>% 
   .[, mean(cov_qs), by = .(exp, lat, lon)] %>% 
   periodic_lon() %>% 
   ggplot(aes(lon, lat)) +
   geom_contour_fill(aes(z = V1), breaks = AnchorBreaks(0, exclude = 0)) +
   geom_contour2(aes(z = V1, label = ..level..), family = hrbrthemes::font_rc,
                 label.placer = label_placer_flattest(), 
                 breaks = AnchorBreaks(0, exclude = 0)) +
   geom_qmap() +
   # geom_coords() +
   # coord_polar(ymax = 20) +
   coord_sf(ylim = c(-90, 20), expand = FALSE,
            # crs = "+proj=longlat +pm=180 +over",
            default_crs = "+proj=longlat +lon_wrap=180 +over") + 
   labs(x = NULL, y = NULL) +
   scale_fill_divergent(guide = "none") +
   facet_wrap(~exp)
```

En esto la corrica control y ERA se van más distintas.
En latitudes tropicales son similares, pero en latitudes medidas son casi lo opuesto.
En ERA5 hay dos máximos localizados al sur de Australia y al sudoeste de América, indicando que éstas dos áreas son las que más "aportan" a la onda 3 climatológica.
Por otro lado, en la corrida control estas zonas son más bien mínimos.

La simulación de Aquaplanet, tiene valores casi nulos, lo cual es esperable.
Como las ondas zonales 3 no tienen una región preferencial, en promedio, la proyección de la altura geopotential en la dirección de la onda climatológica es cero.

Las otras simulaciones tienen regiones con valores positivos.
En las simulaciones con Sudamérica, hay un máximo sobre Sudamérica tropical y a sotavento en latitudes medias.
La forma de estos máximos es consistente con el trayecto esperado de la onda 3.
En la simulación con África hay valores positivos sobre África que parecen extenderse a latitudes más bajas, pero dicha extensión es mucho menor que en las simulaciones con América.
En la simulación con Australia, nuevamente hay valores altos sobre la fuente, pero en este caso no hay ninguna propagación fuera de la región.
En la simulación con trópicos realistas, hay dos regiones tropicales con valores positivos: Pacífico central y áfrica.

```{r}

cors <- lapply(unique(datagoyal$exp), \(e) 
               datagoyal %>%
                  .[exp == e] %>% 
                  melt(id.vars = c("lon", "lat", "time", "exp"), measure.vars = patterns(cov = "^cov")) %>%
                  .[, m := mean(value), by = .(time, lat, exp, variable)] %>%
                  .[, cor(value, m), by = .(variable, exp, lat, lon)]
) %>% 
   rbindlist()

```

```{r}
cors %>% 
   .[variable == "cov_zw"] %>% 
   periodic_lon() %>% 
   ggplot(aes(lon, lat)) +
   geom_contour_fill(aes(z = V1^2), breaks = AnchorBreaks(0, exclude = 0)) +
   geom_contour2(aes(z = V1^2, label = ..level..), family = hrbrthemes::font_rc,
                 label.placer = label_placer_flattest(), 
                 breaks = AnchorBreaks(0, exclude = 0)) +
   geom_qmap() +
   # geom_coords() +
   # coord_polar(ymax = 20) +
   coord_sf(ylim = c(-90, 20), expand = FALSE,
            # crs = "+proj=longlat +pm=180 +over",
            default_crs = "+proj=longlat +lon_wrap=180 +over") + 
   labs(x = NULL, y = NULL) +
   scale_fill_divergent(guide = "none") +
   facet_wrap(~exp)
```

```{r}
samax <- datagoyal %>% 
   .[exp == "Tropical South America"] %>% 
   # .[time == time[1]] %>% 
   .[, mean(cov_qs), by = .(exp, lat, lon)] %>% {
      d <- .
      rbind(
         d[which.max(V1)], 
         d %>% keep_lat() %>% .[which.max(V1)]       
      ) 
   } %>% 
   .[, .(lon, lat, exp)] 

samax <- samax %>% 
   rbind(data.table(lon = 135, lat = samax$lat[2], exp = "Tropical South America"))

waves <- lapply(seq_len(nrow(samax)), \(i) {
   maxlat <- samax[i, lat]
   maxlon <- samax[i, lon]
   
   datagoyal %>% 
      .[exp == "Tropical South America"] %>% 
      .[, base := cov_qs[lat == maxlat & lon == maxlon], by = .(time)] %>% 
      .[, hgt := hgt - mean(hgt), by = .(time, lat)] %>% 
      .[, .(base_lon = maxlon,
            base_lat = maxlat, 
            cor = cor(hgt, base)), by = .(lon, lat)]
}) %>% 
   rbindlist()

waves %>% 
   # .[base_lat == min(base_lat)] %>% 
   periodic_lon() %>% 
   
   ggplot(aes(lon, lat)) +
   geom_contour_fill(aes(z = cor), breaks = AnchorBreaks(0, exclude = 0)) +
   geom_contour2(aes(z = cor, label = ..level..), family = hrbrthemes::font_rc,
                 label.placer = label_placer_flattest(), 
                 breaks = AnchorBreaks(0, exclude = 0)) +
   geom_qmap() +
   geom_point(data = ~unique(.x[, .(base_lon, base_lat)]), 
              aes(base_lon, base_lat), size = 4) +
   # geom_coords() +
   # coord_polar(ymax = 20) +
   coord_sf(ylim = c(-90, 20), expand = FALSE,
            # crs = "+proj=longlat +pm=180 +over",
            default_crs = "+proj=longlat +lon_wrap=180 +over") + 
   labs(x = NULL, y = NULL) +
   scale_fill_divergent(guide = "none") +
   facet_wrap(~as.numeric(interaction(base_lat, base_lon)))
```

```{r}

lons <- seq(0, 300, by = 60)
this_exp <- "ERA5"
lats <- datagoyal[exp == this_exp] %>%
   .[which.min(abs(lat + 55)), lat]
waves <- lapply(lons, \(l) {
   datagoyal %>% 
      # .[exp == "Tropical South America"] %>% 
      .[exp == this_exp] %>% 
      
      .[, hgt := hgt - mean(hgt), by = .(time, lat)] %>% 
      melt(id.vars = c("lon", "lat", "time", "exp", "hgt"), 
           measure.vars = c("cov_qs", "cov_zw")) %>%
      .[, base := value[lat == lats & lon == l], by = .(variable, time)] %>% 
      
      .[, .(base_lon = l,
            base_lat = lats, 
            cor = cor(hgt, base)), by = .(variable, lon, lat)]
}) %>% 
   rbindlist()

waves %>% 
   # .[base_lat == min(base_lat)] %>% 
   periodic_lon() %>% 
   
   ggplot(aes(lon, lat)) +
   geom_contour_fill(aes(z = cor), breaks = AnchorBreaks(0, exclude = 0)) +
   geom_contour2(aes(z = cor, label = ..level..), family = hrbrthemes::font_rc,
                 label.placer = label_placer_flattest(), 
                 breaks = AnchorBreaks(0, exclude = 0)) +
   geom_qmap() +
   geom_point(data = ~unique(.x[, .(base_lon, base_lat)]), 
              aes(base_lon, base_lat), size = 4) +
   # geom_coords() +
   # coord_polar(ymax = 20) +
   coord_sf(ylim = c(-90, 20), expand = FALSE,
            # crs = "+proj=longlat +pm=180 +over",
            default_crs = "+proj=longlat +lon_wrap=180 +over") + 
   labs(x = NULL, y = NULL) +
   scale_fill_divergent(guide = "none") +
   facet_grid(base_lon  ~ variable)
```

## EOFs

```{r}
eofs <- datagoyal %>% 
   copy() %>% 
   # .[, hgt := hgt - mean(hgt), by = .(month(time), lon, lat, exp)] %>% 
   .[, hgt := hgt - mean(hgt), by = .(time, lat, exp)] %>% 
   .[, hgt := hgt*sqrt(cos(lat*pi/180))] %>%
   .[, .(eof = list(EOF(hgt ~ time | lon + lat, n = 1:6, suffix = "EOF", data = .SD))), 
     by = exp]
```

```{r}
eofs[, eof[[1]]$right, by = exp] %>% 
   # .[exp != "Aquaplanet"] %>%
   periodic_lon() %>% 
   ggplot(aes(lon, lat)) +
   geom_contour_fill(aes(z = hgt)) +
   
   
   
   geom_qmap() +
   geom_coords() +
   shadowtext::geom_shadowtext(data = eofs[, eof[[1]]$sdev, by = exp] %>%
                                  # .[exp != "Aquaplanet"] %>%
                                  .[, cumr2 := cumsum(r2), by = exp],
                               family = "Roboto Condensed",
                               aes(0, -90, label = paste0(scales::percent(r2, 0.1), "\n(",
                                                          scales::percent(cumr2, .1), ")")),
                               bg.colour = "white", colour = "black") +
   coord_polar() +
   labs(x = NULL, y = NULL) +
   scale_fill_divergent(guide = "none") +
   facet_grid(EOF ~ exp)
```

La simulación aquaplanet está dominada por variabilidad en latitudes medias, con un \~30% de la varianza explicada por una onda 1 y un 15% por una onda 5.

## cEOFs

Como lo que interesan son las onda zonales, voy a calcular los EOFs complejos.
Para ayudar en la interpretación de lo que ya sé, voy a usar sólo Septiembre-Octubre-Noviembre.

```{r ceofs}
season_weights <- function(time, groups = seasonally(time)) {
   w <- as.numeric(on_unique(time, lubridate::days_in_month))
   setDT(list(w = w, groups = groups))[, w := w/mean(w), by = groups]$w
}


mean_goyal <- datagoyal %>%
   .[season(time) == "SON"] %>%
   .[, .(hgt = mean(hgt)), by = .(time = seasonally(time), lon, lat, exp)]

n = 1:3
ceofs <- mean_goyal %>% 
   copy() %>% 
   .[, hgt := hgt - mean(hgt), by = .(time, lat, exp)] %>% 
   .[, hgt := hgt*sqrt(cos(lat*pi/180))] %>%
   .[, hgt.cpx := spectral::analyticFunction(hgt),
     by = .(lat, time, exp)] %>%
   .[, hgt := hgt.cpx] %>% 
   .[, .(eof = list(EOF(hgt ~ time | lon + lat, n = n, suffix = "cEOF", data = .SD))), by = exp]
```

```{r ceofs-plot, fig.cap = "Parte real de los primeros 3 EOFs complejos de los experimentos."}
ceofs[, eof[[1]]$right, by = exp] %>% 
   # .[exp != "Aquaplanet"] %>% 
   periodic_lon() %>% 
   ggplot(aes(lon, lat)) +
   geom_contour_fill(aes(z = as.numeric(Re(hgt)))) +
   # geom_contour2(data = ceofsr2, 
   #               aes(z = r.squared, 
   #                   label = ..level..)) +
   shadowtext::geom_shadowtext(data = ceofs[, eof[[1]]$sdev, by = exp] %>%
                                  # .[exp != "Aquaplanet"] %>%
                                  .[, cumr2 := cumsum(r2), by = exp],
                               family = "Roboto Condensed",
                               aes(0, -90, label = paste0(scales::percent(r2, 0.1), "\n(",
                                                          scales::percent(cumr2, .1), ")")),
                               bg.colour = "white", colour = "black") +
   geom_qmap() +
   geom_coords() +
   coord_polar() +
   labs(x = NULL, y = NULL) +
   scale_fill_divergent(guide = "none") +
   facet_grid(cEOF~exp)
```

La Figura \@ref(fig:ceofs-plot) muestra la parte real de los primeros 4 cEOFs de las simulaciones.
El primer cEOF es una onda 1 en todas las simulaciones, la cual estaría uniendo los primeros 2 EOFs (Fig. \@ref(fig:eofs-plot)).
Los siguientes cEOF varían más en estructura entre los distintos experimentos.

Salvo aquaplanet y "Tropical South America", en el resto de las simulaciones los cEOFs 2 y 3 parecerían tener su amplitud localizada en hemisferios opuestos.

Salvo la simulación de Sudamérica tropical, todos estos cEOF tienen un grado de localización comparable con ERA5.

Tratar de hacer paralelismos entre cEOFs no es fácil porque la tienen diferencias en cuanto a las regiones donde están más activos por construcción de las simulaciones.
Para tener una mejor idea de la estructura de ondas zonales independientemente de la fase, la Figura \@ref(fig:coefs-amplitudes) muestra la amplitud de las ondas zonales 1 a 3 de los cEOFs 2 y 3 de cada experimento (salvo aquaplanet).

```{r ceofs-amplitudes, fig.cap = "Amplitud de las ondas zonales en cada latitud para los EOFs complejos."}
ceofs[, eof[[1]]$right, by = exp] %>% 
   .[exp != "Aquaplanet"] %>% 
   # .[cEOF != "cEOF1"] %>% 
   .[, FitWave(Re(hgt), 1:3), by = .(lat, exp, cEOF)] %>% 
   ggplot(aes(lat, amplitude)) +
   geom_line(aes(color = factor(k))) +
   coord_flip() +
   facet_grid(cEOF~exp) 
```

Es importante ver la distribución de amplitudes en el cEOF2 de ERA5, ya que sería el "benchmark" de lo que debe ser el PSA.
Por ejemplo, el cEOF2 de la simulación con "trópicos realistas" tiene una distribución casi idéntica que el benchmark salvo por la onda 1.
Cabe notar también que el cEOF3 de esta simulación también es muy parecido salvo la onda 1; de hecho, la varianza explicada de cada uno es casi idéntica (\~8%), por lo que claramente estos modos están muy mezclados.
Es posible que se trate de dos modos que tratan de refleja una estructura similar pero localizada; el cEOF2 explicaría la parte del Atlántico-Índico mientras que el cEOF3 explicaría la parte del Pacífico.

Algo similar parecería ocurrir en la simulación de Complete South America.
En ésta los cEOFs no están mezclados en cuando a varianza expicada, pero ambos son similares, con una mezcla similar de onda 2 y 3.
La diferencia principal es que el cEOF2 tiene más amplitud an el hemisferio occidental mientras que el cEOF3 tiene más amplitud en el oriental.

La simulación de Tropical South America es muy distinta a las demás.
El cEOF2 es una onda 3 casi pura y el cEOF3 es una onda 2 casi pura.

Una última herramienta para tratar de entender estos modos es calcular las regresiones entre ellos y la altura geopotential completa.
Esto brinda una idea más realista de los campos asosicados a cada modo y cada parte.
En particular quiero mirar dos cosas:

1.  Si la parte real e imaginaria forman realmente una estructura de ondas.

2.  Si hay estas ondas forman parte de un tren de ondas tipo PSA.

```{r ceof-regre, fig.cap = "Regresiones de altura geopotential y los cEOFs. Las primeras dos filas son las regresiones con la parte Imaginaria y Real del cEOF2 y las últimas dos, las del cEOF3."}
ceofs[, eof[[1]]$left, by = exp] %>% 
   .[exp != "Aquaplanet"] %>% 
   # .[cEOF != "cEOF1"] %>% 
   .[cEOF == "cEOF3"] %>% 
   sep_ReIm(hgt, longer = FALSE) %>% 
   .[, hgt := NULL] %>% 
   mean_goyal[., on = c("time", "exp"), allow.cartesian = TRUE] %>% 
   .[, FitLm(hgt, R, I, r2 = TRUE), by = .(exp, cEOF, lon, lat)] %>% 
   rm_intercept() %>% 
   periodic_lon() %>% 
   ggplot(aes(lon, lat)) +
   geom_contour_fill(aes(z = estimate)) +
   geom_qmap() +
   geom_coords() +
   coord_polar() +
   labs(x = NULL, y = NULL) +
   scale_fill_divergent(guide = "none") +
   ggh4x::facet_nested(cEOF + term ~exp)

```

La Figura \@ref(fig:ceof-regre) muestra estas regresiones.

Para Complete SOuth America, el cEOF2 es rarísimo y no veo que tenga una estructura clara de onda.
El cEOF3, en cambio, tiene un poco más de pinta.
Aunque la region que afecta está lejos de sudamérica.

Para Tropical South America, ambos cEOFs tiene una estructura de onda zonal, pero en ambos casos son ondas zonales bastante puras.
Hay una sugerencia de un tren de ondas en la regresión con la parte imaginaria.

En Tropical Africa, el cEOF2 es bastante raro.
El cEOF3 sí tiene más pinta de tren de ondas.

En Tropical Australia, el cEOF3 tiene un patrón de tren den ondas bastante bien definido.

El Realistic Tropics tiene un patrón de tren de ondas en cEOF2, aunque con superposición de una especie de SAM con la parte Real.

```{r tabla-psa}
wave3 <- tibble::tribble(
   ~ exp,                    ~cEOF, 
   "Complete South America", "cEOF3",
   "Tropical South America", "cEOF2", 
   "Tropical Africa",        "cEOF3",
   "Tropical Australia",     "cEOF3",
   "Realistic Tropics",      "cEOF2", 
   "ERA5",                   "cEOF2"
) %>% 
   as.data.table()

wave3 %>% 
   kable(caption = "Identificación de cEOFs con tren de onda tipo PSA")
```

Las decisiones de qué cEOFs son los relevantes en cada simulación están en la Tabla \@ref(tab:tabla-psa).
