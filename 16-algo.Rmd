---
title: ""
author: "Elio Campitelli"
output: 
   pdf_document:
      latex_engine: xelatex
urlcolor: blue
header_includes:
   - \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE}
# Notification
start.time <- unclass(Sys.time())
min.time <- 10
knit_doc <- knitr::knit_hooks$get("document")


knitr::knit_hooks$set(document = function(x) {
   took <- unclass(Sys.time()) - start.time
   if (unclass(Sys.time()) - start.time >= min.time) {
      notify("Done knitting!", 
             paste0("Took ", round(took), " seconds"),
             time = 5)
   }  
   knit_doc(x)
})

name <- tools::file_path_sans_ext(knitr::current_input())
knitr::opts_chunk$set(echo = FALSE,
                      cache = TRUE,
                      cache.extra = 41, 
                      warning = FALSE, message = FALSE,
                      out.extra = "",
                      cache.path = paste0("cache/", name, "/"),
                      fig.path = paste0("fig/", name, "/"),
                      fig.align = "center")

# knitr::opts_chunk$set(fig.width = 13, 
#                       fig.height = 7)

library(metR)
library(data.table)
library(ggplot2)
library(magrittr)
library(patchwork)
library(here)

here <- here::here

lev.breaks <- c(1000, 500, 300, 200, 100, 50, 10)

theme_elio <- theme_minimal(base_size = 11) +
   theme(strip.background = element_rect(fill = "#fafafa", color = NA),
         # text = element_text(family = font_rc),
         legend.position = "bottom", legend.box = "vertical",
         panel.spacing.y = unit(5, "mm"),
         panel.spacing.x = unit(5, "mm"),
         legend.spacing = unit(2, "mm"),
         plot.margin = grid::unit(rep(3, 4), "mm"),
         legend.title = element_blank(),
         legend.box.spacing = unit(3, "mm"),
         legend.margin = margin(t = -5),
         panel.grid = element_line(color = "gray50", size = 0.2, linetype = 3),
         panel.ontop = TRUE)
theme_set(theme_elio)
# theme_set(hrbrthemes::theme_ipsum_rc() + theme(panel.ontop = TRUE))

guide_colorstrip_bottom <- function(width = 25, height = 0.5, ...) {
   guide_colorstrip(title.position = "top", title.hjust = 0.5,
                    barheight = height,
                    barwidth = width, ...)
}


subset_data <- list(lat = c(-90, 0), 
                    time = lubridate::as_datetime(c("1985-01-01",
                                                    "2014-12-01")))
breaks_zero <- AnchorBreaks(0, NULL, 0)



makeActiveBinding(".", function(value) .Last.value, .GlobalEnv)

setnames <- function(x, ...) {
   names <- c(...)
   # print(names)
   data.table::setnames(x, names(names), unname(names))
}

ReIm <- function(complex) {
   list(R = Re(complex), I = Im(complex))
}

Pvaluate <- function(estimate, std.error, df, adjustement = "none") {
   p.adjust(2*pt(abs(estimate)/std.error, df, lower.tail = FALSE), method = "fdr")
}

source(here::here("scripts", "facet_nested.R"))
source(here::here("scripts", "helperfun.R"))


map_simple <- function(wrap = c(0, 360), out = "sf") {
   map <- maps::map("world", fill = TRUE, 
                    col = "transparent", plot = FALSE, wrap = c(0, 360))
   IDs <- vapply(strsplit(map$names, ":"), function(x) x[1], 
                 "")
   proj <- sp::CRS("+proj=longlat +datum=WGS84")
   map <- maptools::map2SpatialPolygons(map, IDs = IDs, 
                                        proj4string = proj)
   
   simple <- rmapshaper::ms_simplify(map, keep = 0.015)
   simple
}

map_data <- subset(fortify(map_simple()), lat <= 0)

map <- function(subset, color = "black", size = 0.2, fill = NA, ...) {
   data <- fortify(map_simple())
   subset <- eval(substitute(subset), envir = data)
   
   geom_polygon(data = data[subset, ], 
                aes(long, lat, group = group), 
                color = color, 
                size = size, 
                fill = fill,
                ...)
}

sep_ReIm <- function(dt, col, longer = TRUE) {
   names <- c("R", "I")
   expr <- quote(copy(dt)[, (names) := ReIm(col)])
   expr  <-  do.call(substitute, list(expr, 
                                      list(col = substitute(col))))
   data <- eval(expr)
   
   if (isTRUE(longer)) {
      data[, deparse(substitute(col)) := NULL]
      data <- setDT(tidyr::pivot_longer(data, R:I, names_to = "part", values_to = deparse(substitute(col))))
   }
   
   return(data[])
}

```


```{r read-data}
subset <- list(latitude = -90:0, 
               level = list(50, 200, 500))


files <- c(era   = here("DATA", "ERA-Interim", "erai.mon.mean.nc"),
           era20 = here("DATA", "ERA-20C", "era20c.mon.mean.nc"))

datos <- rbindlist(lapply(files, function(f) {
   ReadNetCDF(f, c(hgt = "z"), subset = subset)}), 
   idcol = "dataset") %>% 
   .[, hgt := hgt/9.8] %>% 
   setnames(longitude = "lon", latitude = "lat", level = "lev") %>% 
   .[, year := year(time[1]), by = time] %>% 
   .[month(time) == 12, year := year + 1] %>%  # december counts to the next year
   .[, .(hgt = mean(hgt), n = .N), by = .(dataset, lev, lat, lon, year, season(time))] %>% 
   .[n == 3] %>%  # keep only full seasons
   .[, n := NULL]

# datos <- ReadNetCDF(here("DATA", "ERA-Interim", "uwnd.mon.mean.nc"), 
#                     subset = subset) %>%
#    .[, dataset := "era"] %>% 
#    setnames(longitude = "lon", latitude = "lat", level = "lev") %>% 
#    .[, year := year(time[1]), by = time] %>% 
#    .[month(time) == 12, year := year + 1] %>%  # december counts to the next year
#    .[, .(u = mean(u), n = .N), by = .(dataset, lev, lat, lon, year, season(time))] %>% 
#    .[n == 3] %>%  # keep only full seasons
#    .[, n := NULL] %>% 
#    setnames(u = "hgt")

modern <- range(datos[dataset == "era", year])
# Surface mask
pres <- ReadNetCDF(here("DATA", "NCEP Reanalysis", "pres.mon.mean.nc"), 
                   subset = list(lat = -90:0))
pres.mean <- pres[, .(pres = median(pres)), by = lat]
pres.mean <- rbind(data.table(lat = 0.0, pres = Inf), 
                   pres.mean, 
                   data.table(lat = -90.0, pres = Inf))

censor_ground <- function(df, col = "underground") {
   df[, c(col) := lev > pres.mean[lat == .BY$lat, pres] , by = lat][]
}

surface <- function(lats = c(-90:0)) {
   geom_polygon(data = pres.mean[lat %between% range(lats)], aes(y = pres), fill = "white", 
                alpha = 0.9, color = "gray10", size = 0.5)
}
```


Vamos a separar las anomalías de geopogential $Z'$ en su partes zonalmente simétricas y asimétricas

$$
Z' = Z^{'*} + \left [Z' \right]
$$

La varianza de $Z'$ entonces puede descomponserse en:

$$
\mathrm{var}\left (Z' \right ) = \mathrm{var}\left (Z^{'*} \right) + \mathrm{var}\left ( \left [Z' \right ] \right ) + 2 \mathrm{cov}\left ( Z^{'*}, \left [ Z' \right ] \right)
$$


```{r}
datos <- datos %>%
   .[, hgt_z := Anomaly(hgt), by = .(lat, lev, dataset, season, year)] %>% 
   .[, prime := Anomaly(hgt), by = .(lon, lat, lev, dataset, season)] %>% 
   .[, prime_mean := mean(prime), by = .(lat, lev, dataset, year, season)] %>% 
   .[, prime_star := prime - prime_mean]
```


```{r}
varianzas <- datos %>% 
   .[, .(prime      = var(prime), 
         prime_star = var(prime_star),
         prime_mean = var(prime_mean),
         cov2       = 2*cov(prime_star, prime_mean)), 
     by = .(dataset, lev, lon, lat, season)] %>% 
   # .[, prime_z := Anomaly(prime), by = .(dataset, season, lev, lat)] %>%
   melt(id.vars = c("dataset", "lev", "lon", "lat", "season")) %>% 
   .[, variable := factor(variable, 
                          levels = c("prime", "prime_star", "prime_mean", "cov2"),
                          labels = c("Z'", "Z'*", "[Z']", "cov(Z'*, [Z'])"))]
```

```{r}
plot_var <- function(season, lev) {
   out_season <- season
   out_lev    <- lev
   varianzas %>%
      # .[lat < -15] %>% 
      .[dataset == "era"] %>% 
      .[season %in% out_season] %>%
      .[lev %in% out_lev] %>%
      ggplot(aes(lon, lat)) +
      geom_contour_fill(aes(z = value), breaks = AnchorBreaks(0, NULL, 0)) +
      map(lat < 0) +
      # geom_contour(aes(z = value), color = "black") +
      # geom_contour2(aes(z = value)) +
      scale_fill_divergent(guide = guide_colorbar(barwidth = 0.5, barheight = 2)) +
      scale_y_latitude(limits = c(-90, -30)) +
      scale_x_longitude() +
      coord_quickmap() +
      facet_nested(season ~ variable) +
      theme(legend.position = "right")
}

plot_vars <- function(lev) {
   seasons <- levels(varianzas$season)
   
   lapply(seasons, plot_var, lev = lev) %>% 
      Reduce("+", .) +
      plot_layout(ncol = 1) +
      plot_annotation(title = paste0(lev, "hPa"))
}
```


```{r, fig.cap = "Descomposición de la varianza de Z' en 50hPa", fig.width=9, fig.height=6}
plot_vars(50)
```

La varianza de la parte zonalmente simétrica de geopotencial tiene siempre la misma estructura de máxima varianza en los polos. Esto creo que hay que agarrarlo con pinzas porque podría deberse más que nada a la dependencia con el parámetro de coriolis. Podría estar señalándo que es más razonable manejarse con la función corriente. Lo malo es que no encuentro dónde bajar la función corriente en ERA. 

En cualquier caso, la varianza de $Z^{'*}$ es máxima en latitudes polares y longitudinalmente magimiza al sur de sudamérica y al sur del Índico en todas las estaciones, prácticamente. Sin embargo, el campo de varianza total no tiene ese doble máximo salvo en JJA y la razón está en la estructura de la covarianza. En todas las estaciones hay un máximo de covariana negativa cerca de la península antártica que cancela el máximo de varianza de $Z^{'*}$. Esta estructura "bipolar" es interesante pero hay que tener cuidado. Por las fórmulas matemáticas, el promedio zonal de la covarianza de $Z^{'*}$ y $[Z^{*}]$ tiene que ser nulo, por lo que es una certeza matemática que zonas con covarianza positiva tienen que estar compensadas por áreascon covarianza negativa. 


```{r, fig.cap = "Descomposición de la varianza de Z' en 200hPa", fig.width=9, fig.height=6}
plot_vars(200)
```

En 200hPa hay algunos cambios. La estructura de varianza es tiene escalas espaciales más pequeñas. Esto es de esperarse dado que como las ondas cortas no se propagan verticalmente tanto como las cortas, toda la estructura de la estratósfera es más "suave" que la de la tropósfera. La varianza de $[Z']$ sigue siendo máxima en el polo sur, salvo en verano, que tiene un máximo en latitudes medias que probablemente corresponda a la variabilidad del jet subtropical. La varianza de $Z*'$ maximiza en latitudes plares igual que en 5hPa, pero en vez de tener dos máximos, tiene uno solo que coincide con la Baja de Amundsen. En cuanto a la covarianza, sigue tieniendo un máximo negativo en el mar de Weddell. 


Para analizar con más detalle la relación entre Z y [Z] pero sin los probelmas matemáticos de la covarianza mostrada arriba, abajo muestro directamente la correlación entre Z (sin ningún filtro) y [Z].

```{r fig.cap="Correlación entre Z y [Z]", fig.width=9, fig.height=3}
datos %>% 
   .[lev %in% c(50, 200)] %>% 
   .[dataset == "era"] %>% 
   .[, cor.test(hgt, prime_mean)[c("estimate", "p.value")], 
     by = .(dataset, lev, lon, lat, season)] %>% 
   ggperiodic::periodic(lon = c(0, 360)) %>% 
   ggplot(aes(lon, lat)) +
   geom_contour_fill(aes(z = estimate)) +
   geom_contour2(aes(z = estimate), breaks = 0, size = 0.1) +
   # stat_subset(aes(subset = p.value < 0.01 & is.cross(lon, lat)), size = 0.1, alpha = 0.2) +
   scale_y_latitude(limits = c(-90, -30)) +
   scale_x_longitude() +
   facet_nested(lev~season) +
   scale_fill_divergent() +
   map(lat < 0) +
   coord_quickmap()
```

Como era de esperarse, la correlación es positiva en casi todos lados y muy cercana a uno por la estructura principalmente zonal de la circulación del hemisferio Sur. Sin embargo, resaltan áreas de correlación mínima. Estas se dan entre 45°S y 75°S aproximadamente aunque varían según la estación y el nivel. Es notorio encontrar que sobre el Pasaje de Drake la correlación es negativa en otoño (aunque no estadísticamente significativa).


```{r}
lats.eof <- c(-80, -20)
ceof <- datos[lev %in% c(50, 200) & lat %between% lats.eof] %>%
   .[dataset != "ncep"] %>% 
   .[year %between% common_range(year, dataset)] %>%
   .[, hgt := Anomaly(hgt),
     by  = .(lat, season, year, lev, dataset)] %>%
   .[, hgt := Anomaly(hgt), by = .(lon, lat, season, lev, dataset)] %>% 
   .[, hgt := hgt*sqrt(cos(lat*pi/180))] %>%
   .[, hgt.cpx := spectral::analyticFunction(hgt),
     by = .(lat, season, year, dataset, lev)] %>% 
   .[, hgt := hgt.cpx] %>%
   .[, list(ceof = list(EOF(hgt ~ year | lon + lat, n = 1:2, suffix = "cPC"))),
     by = .(dataset, season, lev)]
```


```{r, fig.cap = "Patrones espaciales del EOF complejo. Valor absoluto en sombreado, parte real en linea negra y parte imaginaria en linea azul. (dataset = ERA Interim)", fig.width=9, fig.height=11}
gdata <- ceof[, ceof[[1]]$right, by = .(dataset, season, lev)] %>% 
   .[dataset == "era"] 

gdata %>%    
   ggplot(aes(lon, lat)) +
   geom_contour_fill(aes(z = abs(hgt))) +
   map(lat < 0) +
   # geom_contour2(aes(z = Im(hgt), linetype = factor(-sign(..level..))), size = 0.2) +
   geom_contour2(data = sep_ReIm(gdata, hgt),
                 aes(z = hgt, linetype = factor(-sign(..level..)), color = part), size = 0.2) +
   # geom_contour2(aes(z = Im(hgt), linetype = factor(-sign(..level..))), size = 0.2, color = "blue") +
   # geom_contour(aes(z = Im(hgt)), color = "black") +
   scale_fill_distiller(palette = "Oranges", direction = 1) +
   scale_x_longitude() +
   scale_y_latitude() +
   scale_color_manual(values = c(R = "black", I = "blue"), guide = "none") +
   facet_nested(season + lev ~  cPC,
                labeller = labeller(lev = AddSuffix(" hPa"))) +
   coord_quickmap()
```

El PC1 en 50 hPa "va" con el PC2 en 200 tanto en estructura como en series temporales. Abajo se muestra las correlaciónes entre las series temporales de cada componente principal y cada nivel y para la parte imaginaria y real respectivamente. El cPC2 en 50hPa tiene una alta correlación con el cPC1 en 200hPa en JJA y SON. Entonce está claro que es el mismo modo que tiene una estructura barotrópica equivalente y que se propaga hacia o desde la estratósfera. En DJF y MAM la sincronización entre niveles se da más bien entre el PC1 de ambos niveles (aunque en menor medida).

```{r, fig.cap = "Correlaciones entre componentes principales.", fig.height=4, fig.width=6}
ceof[, ceof[[1]]$left, by = .(dataset, season, lev)] %>% 
   .[dataset == "era"] %>% 
   .[, c("R", "I") := ReIm(hgt)] %>% 
   tidyr::pivot_longer(R:I) %>% 
   as.data.table() %>% 
   .[, item :=  interaction(lev, cPC)] %>% 
   .[, widyr::pairwise_cor(.SD, item, year, value), by = .(season, name)] %>%
   ggplot(aes(item1, item2)) +
   geom_raster(aes(fill = correlation)) +
   geom_text(aes(label = signif(correlation, 2))) +
   scale_fill_divergent(guide = "none") +
   facet_nested(season ~ name) 
```

Esto motiva hacer el EOF con ambos niveles juntos de manera de obtener modos de oscilación conjuntos. Lo bueno de esto es que reduce la dimensión del problema ya que se reducen las series temporales a la mitad (porque hay una sola serie temporal para cada componente principal para los dos niveles).

```{r}
# Sacado de James
H <- 6.4*1000
lats.eof <- c(-80, -20)
ceof <- datos[lev %in% c(50, 200) & lat %between% lats.eof] %>%
   .[dataset != "ncep"] %>% 
   .[year %between% common_range(year, dataset)] %>%
   # .[, hgt := hgt*exp(hgt/2*H)] %>% 
   .[, hgt := Anomaly(hgt),
     by  = .(lat, season, year, lev, dataset)] %>%
   .[, hgt := Anomaly(hgt), by = .(lon, lat, season, lev, dataset)] %>% 
   .[, hgt := hgt*sqrt(cos(lat*pi/180)), by = .(season, dataset, lev)] %>%
   .[, hgt.cpx := spectral::analyticFunction(hgt),
     by = .(lat, season, year, dataset, lev)] %>% 
   .[, hgt := hgt.cpx] %>%
   .[, list(ceof = list(EOF(hgt ~ year | lon + lat + lev, n = 1:2, suffix = "cPC"))),
     by = .(dataset, season)]
```



```{r, fig.cap = "Patrones espaciales del EOF complejo. Valor absoluto en sombreado, parte real en linea negra y parte imaginaria en linea azul. (dataset = ERA Interim)", fig.width=9, fig.height=11}
gdata <- ceof[, ceof[[1]]$right, by = .(dataset, season)] %>% 
   .[dataset == "era"] 

gdata %>%    
   ggplot(aes(lon, lat)) +
   geom_contour_fill(aes(z = abs(hgt))) +
   map(lat < 0) +
   # geom_contour2(aes(z = Im(hgt), linetype = factor(-sign(..level..))), size = 0.2) +
   geom_contour2(data = sep_ReIm(gdata, hgt), breaks = AnchorBreaks(0, exclude = 0),
                 aes(z = hgt, linetype = factor(-sign(..level..)), color = part), size = 0.2) +
   scale_fill_distiller(palette = "Oranges", direction = 1) +
   scale_x_longitude() +
   scale_y_latitude() +
   scale_color_manual(values = c(R = "black", I = "blue"), guide = "none") +
   facet_nested(season + lev ~  cPC,
                labeller = labeller(lev = AddSuffix(" hPa"))) +
   coord_quickmap()
```

Estas nuevas componentes princpales son parecidas a las anteriorer sólo que se agrupan de forma más explícita según la covariabilidad entre 200hPa y 50hPa. 

En general, se ven estructuras barotrópica equivalentes. Algunos PC tienen similar amplitud en ambos niveles, en ortos la amplitud es mucho mayor en uno que en el otro. ¿Eso significa que los primeros marcan variabilidad conjunta mientras que los otros variabilidad sólo en un nivel? 

El PC1 en todas las estacioens marca la actividad de la onda 1 en 50hPa, salvo en MAM, que también tiene onda 2 que la modifica. Su "impacto" en 200hPa varía en cada estación. En JJA y SON es casi nulo, lo que indica la poca comunicación entre ambos niveles para ese modol. En DJF y MAM sí se observa actividad de la PC1 en 200hPa, con máxima amplitud en el Mar de Weddell y máximos y mínimos en fase con los de 50hPa. 

El PC2 muestra más aparente conexión entre los niveles, excepto en DJF. En ese trimestre, en 50hPa hay una mezcla de onda 1 y onda 2 que genera un máximo y un mínimo en el Índico Sur mientras qu een 200hPa hay una mezcla variada de muchos números de onda que no parece tener una estructura muy coherente pero con máxima variabilidad en en Pacífico Sur. En MAM, la acticidad en ambos niveles está en el Pacífico Sur y muestra ondas barotrópicas equivalentes. En 50hPa es una onda 1+2 relativamente pura y sin propagación meridional mientras que en 200hPa parece haber un tren de ondas desde el Índico hacia Sudamérica. JJA y SON tienen estructuras parecidas pero el máximo de amplitud está maś corrido hacia el este. 


En resumen la onda 1 en la estratósfera está representada principalmente por el PC1. Su amplitud es mayor en JJA y SON cuando además parece evidenciar menor conexión con la tropósfera. El PC2 representa ondas más cortas, barotrópicas equivalentes (salvo en DJF) con mayor actividad en el pacífico sur. Este resultado es medio raro porque implica que la variabilidad conjunta se da por las ondas más cortas que la onda 1. Pero por las condiciones de propagación vertical uno esperaría que ésta se propagara hasta la estratósfera más fácilmente. 


```{r}
ceof[, denormalize(ceof[[1]], "right"), by = .(dataset, season)] %>% 
   .[dataset == "era"] %>% 
   .[, FitWave(Re(hgt), 1:6), by = .(lat, lev, dataset, cPC, season)] %>% 
   ggplot(aes(lat, amplitude)) +
   geom_line(aes(color = factor(k))) +
   facet_nested(cPC + lev  ~  season, 
                labeller = labeller(lev = AddSuffix(" hPa"))) +
   scale_color_brewer(palette = "Set1") +
   coord_flip()
```


```{r}
ceof_era <- ceof[dataset == "era"]
```



```{r, fig.cap = "Correlación entre altura geopotencial y parte Real (sombreado) e Imaginaria (contornos) de cada componente principal"}

eof <- ceof_era[, ceof[[1]]]

ceof_era[, denormalize(ceof[[1]], "left"), by = .(dataset, season)] %>% 
   setnames(hgt = "EOF") %>% 
   datos[., on = c("dataset", "season", "year")] %>%
   .[lev %in% c(50, 200)] %>% 
   .[dataset == "era"]  %>% 
   sep_ReIm(EOF) %>% 
   .[, .(estimate = cor(hgt, EOF)),
     by = .(lon, lat, lev, season, dataset, cPC, part)] %>% 
   tidyr::pivot_wider(names_from = part, values_from = estimate) %>% 
   # .[term == "value"] %>% 
   # .[, p.val := p.adjust(p.value, "fdr"), by = .(lev, season, cPC, variable)] %>% 
   ggplot(aes(lon, lat)) +
   geom_contour_fill(aes(z = R), breaks = AnchorBreaks(0, 0.25, 0)) +
   geom_contour2(aes(z = I, linetype = factor(-sign(..level..))), breaks = AnchorBreaks(0, 0.25, 0)) +
   geom_text_contour(aes(z = I), rotate = FALSE, stroke = 0.1, stroke.color = "white", skip = 1,
                     breaks = AnchorBreaks(0, 0.25, 0)) +
   # stat_subset(aes(subset = p.val < 0.01 & is.cross(lon, lat)), geom = "point", shape = "+") +
   map(lat < 0) +
   scale_fill_divergent(breaks = AnchorBreaks(0, 0.25, 0),
                        guide = guide_colorstrip_bottom()) +
   facet_nested(season + lev ~  cPC,
                labeller = labeller(lev = AddSuffix(" hPa"))) +
   coord_quickmap()
```


Las correlaciones temporales entre el geopotencial y las series temporales de 

```{r}
ceof_era[, denormalize(ceof[[1]], "left"), by = .(dataset, season)] %>% 
   setnames(hgt = "EOF") %>% 
   datos[., on = c("dataset", "season", "year")] %>%
   .[lev %in% c(50, 200)] %>% 
   .[dataset == "era"]  %>% 
   # sep_ReIm(EOF) %>% 
   .[, .(estimate = cor(hgt, abs(EOF))),
     by = .(lon, lat, lev, season, dataset, cPC)] %>%
   ggplot(aes(lon, lat)) +
   geom_contour_fill(aes(z = estimate), breaks = AnchorBreaks(0, NULL, 0)) +
   # geom_contour2(aes(z = I, linetype = factor(-sign(..level..))), breaks = AnchorBreaks(0, 0.25, 0)) +
   # geom_text_contour(aes(z = I), rotate = FALSE, stroke = 0.1, stroke.color = "white", skip = 1,
   # breaks = AnchorBreaks(0, 0.25, 0)) +
   # stat_subset(aes(subset = p.val < 0.01 & is.cross(lon, lat)), geom = "point", shape = "+") +
   map(lat < 0) +
   scale_fill_divergent(guide = guide_colorstrip_bottom()) +
   facet_nested(season + lev ~  cPC,
                labeller = labeller(lev = AddSuffix(" hPa"))) +
   coord_quickmap()
```


```{r, fig.cap = "Series temporales de las partes reales e imaginarias de cada componente principal para ERA Interim y ERA20C"}
ceof[, denormalize(ceof[[1]], "left"),  by = .(dataset, season)] %>% 
   .[dataset == "era"] %>% 
   # .[dataset == "era20"] %>% 
   sep_ReIm(hgt) %>%
   
   # .[, change_sign := sign(widyr::pairwise_cor(.SD, dataset, year, hgt, upper = FALSE)$correlation), by = .(season, cPC, part)] %>%
   # .[dataset == "era20", hgt := hgt*change_sign] %>% 
   ggplot(aes(year, hgt, color = part)) +
   geom_line() +
   geom_smooth(method = "lm") +
   facet_nested(cPC + dataset ~ season)
```

Cada PC tiene 2 series temporales, una Real y otra imaginaria. 


```{r}
psi <- ReadNetCDF("DATA/NCEP Reanalysis/psi.mon.mean.nc",
                  subset = list(lat = c(-90, 20),
                                level = 0.9950,
                                time = c("1979-01-01", "2019-01-01"))) %>% 
   setnames(level = "lev") %>% 
   .[, year := year(time[1]), by = time] %>% 
   .[month(time) == 12, year := year + 1] %>%  # december counts to the next year
   .[, .(psi = mean(psi), n = .N), by = .(lev, lat, lon, year, season(time))] %>% 
   .[n == 3] %>%  # keep only full seasons
   .[, n := NULL] %>% 
   .[, psi.z := Anomaly(psi), by = .(lat, season, year)]

ceof[dataset == "era"] %>% 
   .[, denormalize(ceof[[1]], "left"), by = .(season)] %>% 
   sep_ReIm(hgt) %>% 
   .[psi, on = c("year", "season"), allow.cartesian = TRUE] %>% 
   na.omit() %>% 
   .[, FitLm(psi.z, hgt = hgt/sd(hgt)), by = .(lat, lon, season, cPC, part)] %>% 
   .[term == "hgt"] %>%
   .[, psi.z := estimate] %>%
   .[, c("f.lon", "f.lat") := WaveFlux(.SD), by = .(season, cPC, part)] %>%
   ggplot(aes(lon, lat)) +
   geom_contour_fill(aes(z = psi.z), breaks = AnchorBreaks(0, exclude = 0)) +
   geom_streamline(aes(dx = f.lon, dy = f.lat), skip = 4, L = 10, min.L = 3) +
   map(lat < 10) +
   scale_fill_divergent() +
   facet_nested(season ~  cPC + part)
```








```{r}
sst <- ReadNetCDF(here::here("DATA/ERA-Interim/erai-sfc.mon.mean.nc"),
                  vars = "sst",
                  subset = list(latitude = -90:20)) %>% 
   setnames(longitude = "lon", latitude = "lat") %>% 
   .[, lapply(.SD, mean), by = .(lon, lat, year(time), season(time))]

air <- ReadNetCDF(here::here("DATA/ERA-Interim/erai.mon.mean.nc"),
                  vars = "t",
                  subset = list(latitude = -90:20,
                                level = list(850, 50))) %>% 
   setnames(longitude = "lon", latitude = "lat", level = "lev") %>% 
   .[, lapply(.SD, mean), by = .(lon, lat, lev, year(time), season(time))]
```


```{r, fig.cap = "Regresión de la parte real e imaginaria de cada PC con la anomalía zonal de SST"}
sst[, sst_z := Anomaly(sst, na.rm = TRUE), by = .(year, season, lat)]


ceof_era[, ceof[[1]]$left, by = .(dataset, season)] %>%
   sep_ReIm(hgt) %>% 
   sst[., on = c("season", "year"), allow.cartesian = TRUE] %>% 
   na.omit() %>% 
   .[, FitLm(sst, hgt, se = TRUE),  
     by = .(lon, lat, season, dataset, cPC, part)] %>% 
   .[term == "hgt"] %>% 
   .[, p.val := Pvaluate(estimate, std.error, df, "fdr"), by = .(season, cPC, part)] %>% 
   # .[, cor.test(sst.z, hgt, use = "complete.obs")[c("estimate", "p.value")],
   # by = .(lon, lat, season, dataset, cPC, part)] %>%
   # .[, p.val := p.adjust(p.value, "fdr"), by = .(season, cPC, part)] %>%
   .[lat > -75] %>%
   ggplot(aes(lon, lat)) +
   # geom_raster(aes(fill = estimate)) +
   geom_contour_fill(aes(z = estimate), na.fill = TRUE) +
   stat_subset(aes(subset = p.val < 0.01 & is.cross(lon, lat)), geom = "point", shape = "+") +
   # scale_fill_divergent(limits = c(-1, 1)) +
   scale_fill_divergent() +
   facet_nested( cPC + part ~  season,
                 labeller = labeller(lev = AddSuffix(" hPa"))) +
   map(lat < 25, fill = "white") +
   coord_quickmap()
```

La correlación entre el la anomalía zonal de SST y las series temporales de casa EOF no da mucho significativo. El PC2 en SON tiene una señal significativa de tipo niño que se muestra con más detalle abajo:

```{r }
ceof_era[, ceof[[1]]$left, by = .(dataset, season)] %>%
   sep_ReIm(hgt) %>% 
   sst[., on = c("season", "year"), allow.cartesian = TRUE] %>% 
   na.omit() %>% 
   .[cPC == "cPC2" & season == "SON"] %>% 
   .[, FitLm(sst, hgt, se = TRUE),  
     by = .(lon, lat, season, dataset, cPC, part)] %>% 
   .[term == "hgt"] %>% 
   .[, p.val := Pvaluate(estimate, std.error, df, "fdr"), by = .(season, cPC, part)] %>% 
   # .[, cor.test(sst.z, hgt, use = "complete.obs")[c("estimate", "p.value")],
   # by = .(lon, lat, season, dataset, cPC, part)] %>%
   # .[, p.val := p.adjust(p.value, "fdr"), by = .(season, cPC, part)] %>%
   .[lat > -75] %>%
   ggplot(aes(lon, lat)) +
   geom_contour_fill(aes(z = estimate), na.fill = TRUE) +
   stat_subset(aes(subset = p.val < 0.01 & is.cross(lon, lat)), geom = "point", shape = "+") +
   # scale_fill_divergent(limits = c(-1, 1)) +
   scale_fill_divergent() +
   facet_nested( cPC + part ~  season,
                 labeller = labeller(lev = AddSuffix(" hPa"))) +
   map(lat < 25, fill = "white") +
   coord_quickmap()

ceof_era[, ceof[[1]]$left, by = .(dataset, season)] %>%
   
   sep_ReIm(hgt) %>% 
   sst[., on = c("season", "year"), allow.cartesian = TRUE] %>% 
   na.omit() %>% 
   .[cPC == "cPC2" & season == "SON"] %>% 
   .[, FitLm(sst, hgt, se = TRUE),  
     by = .(lon, lat, season, dataset, cPC, part)] %>% 
   .[term == "hgt"] %>% 
   dcast(lon + lat  ~ part, value.var = "estimate") %>% 
   .[, dif := R - I] %>% 
   ggplot(aes(lon, lat)) +
   # geom_raster(aes(fill = dif)) +
   geom_contour_fill(aes(z = dif), na.fill = TRUE) +
   # stat_subset(aes(subset = p.val < 0.01 & is.cross(lon, lat)), geom = "point", shape = "+") +
   # scale_fill_divergent(limits = c(-1, 1)) +
   scale_fill_divergent() +
   map(lat < 25, fill = "white") +
   coord_quickmap()
```


Pareciera que la parte real está más asociada a temperaturas cálidas de lado este del pacífico mientras que la parte imaginaria está asociada a anomalías cálidas en la parte central. De todas formas las diferencias no son muy grandes. 

```{r}
# air850 <- air[lev == 50]

air_reg <- ceof_era[, ceof[[1]]$left, by = .(dataset, season)] %>%
   sep_ReIm(hgt)  %>% 
   air[., on = c("season", "year"), allow.cartesian = TRUE] %>% 
   na.omit() %>%
   .[, FitLm(t, hgt, se = TRUE),  
     by = .(lon, lat, season, dataset, cPC, part, lev)] %>% 
   .[term == "hgt"] %>% 
   .[, p.val := Pvaluate(estimate, std.error, df, "fdr"), by = .(season, cPC, part,lev)] 

air_reg[lev == 50] %>% 
   ggplot(aes(lon, lat)) +
   # geom_raster(aes(fill = estimate)) +
   geom_contour_fill(aes(z = estimate), na.fill = TRUE) +
   stat_subset(aes(subset = p.val < 0.01 & is.cross(lon, lat)), geom = "point", shape = "+") +
   # scale_fill_divergent(limits = c(-1, 1)) +
   scale_fill_divergent() +
   facet_nested(cPC + part ~  season,
                labeller = labeller(lev = AddSuffix(" hPa"))) +
   map(lat < 25) +
   coord_quickmap()
```

```{r}
air_reg[lev == 850] %>% 
   ggplot(aes(lon, lat)) +
   # geom_raster(aes(fill = estimate)) +
   geom_contour_fill(aes(z = estimate), na.fill = TRUE) +
   stat_subset(aes(subset = p.val < 0.01 & is.cross(lon, lat)), geom = "point", shape = "+") +
   # scale_fill_divergent(limits = c(-1, 1)) +
   scale_fill_divergent() +
   facet_nested(cPC + part ~  season,
                labeller = labeller(lev = AddSuffix(" hPa"))) +
   map(lat < 25) +
   coord_quickmap()
```


Las regresiones con la temperatura muestran los efectos esperables de advección meridional por parte de las anomalías de circulación. 

```{r}
as.list.acf <- function(x) {
   list(acf = x[["acf"]][, 1, 1],
        lag = x[["lag"]][, 1, 1])
}

ceof_era[, ceof[[1]]$left, by = .(dataset, season)] %>% 
   .[, as.list(ccf(Re(hgt), Im(hgt), plot = FALSE)), by = .(season, cPC)] %>% 
   ggplot(aes(lag, acf)) +
   geom_line() +
   geom_point() +
   facet_nested(cPC  ~  season, 
                labeller = labeller(lev = AddSuffix(" hPa"))) 

```




